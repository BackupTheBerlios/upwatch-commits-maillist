<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Upwatch-commits] r632 - in upwatch/libdbi: . common	compat/bb/bbhimport doc st-1.4 upwatch uw_accept uw_acceptbb	uw_dns uw_httpget uw_imap uw_investigate uw_mssql uw_mysql	uw_mysqlstats uw_null uw_ping uw_pop3 uw_postgresql	uw_process uw_purple uw_route uw_send uw_setip uw_smtp	uw_snmpget uw_syncprobes uw_sysstat uw_tcpconnect
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/upwatch-commits/2006-July/index.html" >
   <LINK REL="made" HREF="mailto:upwatch-commits%40lists.berlios.de?Subject=Re%3A%20%5BUpwatch-commits%5D%20r632%20-%20in%20upwatch/libdbi%3A%20.%20common%0A%09compat/bb/bbhimport%20doc%20st-1.4%20upwatch%20uw_accept%20uw_acceptbb%0A%09uw_dns%20uw_httpget%20uw_imap%20uw_investigate%20uw_mssql%20uw_mysql%0A%09uw_mysqlstats%20uw_null%20uw_ping%20uw_pop3%20uw_postgresql%0A%09uw_process%20uw_purple%20uw_route%20uw_send%20uw_setip%20uw_smtp%0A%09uw_snmpget%20uw_syncprobes%20uw_sysstat%20uw_tcpconnect&In-Reply-To=%3C200607212035.k6LKZhah024996%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000165.html">
   <LINK REL="Next"  HREF="000168.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Upwatch-commits] r632 - in upwatch/libdbi: . common	compat/bb/bbhimport doc st-1.4 upwatch uw_accept uw_acceptbb	uw_dns uw_httpget uw_imap uw_investigate uw_mssql uw_mysql	uw_mysqlstats uw_null uw_ping uw_pop3 uw_postgresql	uw_process uw_purple uw_route uw_send uw_setip uw_smtp	uw_snmpget uw_syncprobes uw_sysstat uw_tcpconnect</H1>
    <B>raarts at BerliOS</B> 
    <A HREF="mailto:upwatch-commits%40lists.berlios.de?Subject=Re%3A%20%5BUpwatch-commits%5D%20r632%20-%20in%20upwatch/libdbi%3A%20.%20common%0A%09compat/bb/bbhimport%20doc%20st-1.4%20upwatch%20uw_accept%20uw_acceptbb%0A%09uw_dns%20uw_httpget%20uw_imap%20uw_investigate%20uw_mssql%20uw_mysql%0A%09uw_mysqlstats%20uw_null%20uw_ping%20uw_pop3%20uw_postgresql%0A%09uw_process%20uw_purple%20uw_route%20uw_send%20uw_setip%20uw_smtp%0A%09uw_snmpget%20uw_syncprobes%20uw_sysstat%20uw_tcpconnect&In-Reply-To=%3C200607212035.k6LKZhah024996%40sheep.berlios.de%3E"
       TITLE="[Upwatch-commits] r632 - in upwatch/libdbi: . common	compat/bb/bbhimport doc st-1.4 upwatch uw_accept uw_acceptbb	uw_dns uw_httpget uw_imap uw_investigate uw_mssql uw_mysql	uw_mysqlstats uw_null uw_ping uw_pop3 uw_postgresql	uw_process uw_purple uw_route uw_send uw_setip uw_smtp	uw_snmpget uw_syncprobes uw_sysstat uw_tcpconnect">raarts at mail.berlios.de
       </A><BR>
    <I>Fri Jul 21 22:35:43 CEST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000165.html">[Upwatch-commits] r631 - upwatch
</A></li>
        <LI>Next message: <A HREF="000168.html">[Upwatch-commits] r633 - in upwatch/libdbi: . cfg common compat doc	patches upwatch util uw_accept uw_acceptbb uw_dns uw_httpget	uw_imap uw_iptraf uw_mssql uw_mysql uw_mysqlstats uw_null	uw_ping uw_pop3 uw_postgresql uw_process uw_purple uw_route	uw_send uw_setip uw_smtp uw_snmpget uw_syncprobes uw_sysstat	uw_sysstat/uw_sysstat.d/maillog uw_sysstat/uw_sysstat.d/mysql	uw_sysstat/uw_sysstat.d/quagga uw_sysstat/uw_sysstat.d/syslog	uw_sysstat/uw_sysstat.d/upwatch uw_tcpconnect
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#167">[ date ]</a>
              <a href="thread.html#167">[ thread ]</a>
              <a href="subject.html#167">[ subject ]</a>
              <a href="author.html#167">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: raarts
Date: 2006-07-21 22:34:40 +0200 (Fri, 21 Jul 2006)
New Revision: 632

Modified:
   upwatch/libdbi/Makefile.am
   upwatch/libdbi/Makefile.am.common
   upwatch/libdbi/common/db.c
   upwatch/libdbi/common/dbase_options.def
   upwatch/libdbi/common/main.c
   upwatch/libdbi/common/probe.tpl
   upwatch/libdbi/compat/bb/bbhimport/Makefile.am
   upwatch/libdbi/compat/bb/bbhimport/run.c
   upwatch/libdbi/configure.ac
   upwatch/libdbi/doc/installation.xml
   upwatch/libdbi/doc/program-guide.html
   upwatch/libdbi/doc/program-guide.txt
   upwatch/libdbi/st-1.4/st.spec
   upwatch/libdbi/upwatch-spec.spec
   upwatch/libdbi/upwatch/Makefile.am
   upwatch/libdbi/upwatch/compat.h
   upwatch/libdbi/upwatch/db.h
   upwatch/libdbi/upwatch/pr_bb.c
   upwatch/libdbi/upwatch/pr_bb_cpu.c
   upwatch/libdbi/upwatch/pr_hwstat.c
   upwatch/libdbi/upwatch/pr_iptraf.c
   upwatch/libdbi/upwatch/pr_process.c
   upwatch/libdbi/upwatch/pr_sysstat.c
   upwatch/libdbi/upwatch/probe.h
   upwatch/libdbi/upwatch/spool.c
   upwatch/libdbi/upwatch/spool.h
   upwatch/libdbi/uw_accept/Makefile.am
   upwatch/libdbi/uw_accept/run.c
   upwatch/libdbi/uw_accept/uw_accept.def
   upwatch/libdbi/uw_acceptbb/Makefile.am
   upwatch/libdbi/uw_acceptbb/uw_acceptbb.def
   upwatch/libdbi/uw_dns/Makefile.am
   upwatch/libdbi/uw_dns/run.c
   upwatch/libdbi/uw_dns/uw_dns.def
   upwatch/libdbi/uw_httpget/Makefile.am
   upwatch/libdbi/uw_httpget/run.c
   upwatch/libdbi/uw_httpget/uw_httpget.def
   upwatch/libdbi/uw_imap/Makefile.am
   upwatch/libdbi/uw_imap/run.c
   upwatch/libdbi/uw_imap/uw_imap.def
   upwatch/libdbi/uw_investigate/cmd_options.def
   upwatch/libdbi/uw_mssql/Makefile.am
   upwatch/libdbi/uw_mssql/run.c
   upwatch/libdbi/uw_mssql/uw_mssql.def
   upwatch/libdbi/uw_mysql/Makefile.am
   upwatch/libdbi/uw_mysql/run.c
   upwatch/libdbi/uw_mysql/uw_mysql.def
   upwatch/libdbi/uw_mysqlstats/Makefile.am
   upwatch/libdbi/uw_mysqlstats/run.c
   upwatch/libdbi/uw_mysqlstats/uw_mysqlstats.def
   upwatch/libdbi/uw_null/Makefile.am
   upwatch/libdbi/uw_ping/Makefile.am
   upwatch/libdbi/uw_ping/run.c
   upwatch/libdbi/uw_ping/uw_ping.def
   upwatch/libdbi/uw_pop3/Makefile.am
   upwatch/libdbi/uw_pop3/run.c
   upwatch/libdbi/uw_pop3/uw_pop3.def
   upwatch/libdbi/uw_postgresql/Makefile.am
   upwatch/libdbi/uw_postgresql/run.c
   upwatch/libdbi/uw_postgresql/uw_postgresql.def
   upwatch/libdbi/uw_process/Makefile.am
   upwatch/libdbi/uw_process/bb_cpu.c
   upwatch/libdbi/uw_process/generic_ct.c
   upwatch/libdbi/uw_process/httpget.c
   upwatch/libdbi/uw_process/hwstat.c
   upwatch/libdbi/uw_process/imap.c
   upwatch/libdbi/uw_process/insertcache.c
   upwatch/libdbi/uw_process/iptraf.c
   upwatch/libdbi/uw_process/mssql.c
   upwatch/libdbi/uw_process/mysql.c
   upwatch/libdbi/uw_process/mysqlstats.c
   upwatch/libdbi/uw_process/notify.c
   upwatch/libdbi/uw_process/ping.c
   upwatch/libdbi/uw_process/pop3.c
   upwatch/libdbi/uw_process/postgresql.c
   upwatch/libdbi/uw_process/process.c
   upwatch/libdbi/uw_process/run.c
   upwatch/libdbi/uw_process/snmpget.c
   upwatch/libdbi/uw_process/sysstat.c
   upwatch/libdbi/uw_process/tcpconnect.c
   upwatch/libdbi/uw_process/uw_process.def
   upwatch/libdbi/uw_process/uw_process_glob.h
   upwatch/libdbi/uw_process/uw_tnot.def
   upwatch/libdbi/uw_purple/Makefile.am
   upwatch/libdbi/uw_purple/run.c
   upwatch/libdbi/uw_purple/uw_purple.def
   upwatch/libdbi/uw_route/Makefile.am
   upwatch/libdbi/uw_route/uw_route.def
   upwatch/libdbi/uw_send/Makefile.am
   upwatch/libdbi/uw_setip/Makefile.am
   upwatch/libdbi/uw_setip/run.c
   upwatch/libdbi/uw_setip/uw_setip.def
   upwatch/libdbi/uw_smtp/Makefile.am
   upwatch/libdbi/uw_smtp/run.c
   upwatch/libdbi/uw_smtp/uw_smtp.def
   upwatch/libdbi/uw_snmpget/Makefile.am
   upwatch/libdbi/uw_snmpget/run.c
   upwatch/libdbi/uw_snmpget/uw_snmpget.def
   upwatch/libdbi/uw_syncprobes/Makefile.am
   upwatch/libdbi/uw_syncprobes/run.c
   upwatch/libdbi/uw_syncprobes/uw_syncprobes.def
   upwatch/libdbi/uw_sysstat/Makefile.am
   upwatch/libdbi/uw_tcpconnect/Makefile.am
   upwatch/libdbi/uw_tcpconnect/run.c
   upwatch/libdbi/uw_tcpconnect/uw_tcpconnect.def
Log:
First try at supporting libdbi - stll lots of loose ends


Modified: upwatch/libdbi/Makefile.am
===================================================================
--- upwatch/libdbi/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -8,6 +8,10 @@
 UW_IPTRAF = uw_iptraf
 endif
 
+if HAVE_LIBMYSQL
+UW_MYSQL = uw_mysql uw_mysqlstats
+endif
+
 if HAVE_LIBPQ
 UW_POSTGRESQL = uw_postgresql
 endif
@@ -20,6 +24,10 @@
 UW_MSSQL = uw_mssql
 endif
 
+if XMBMON
+XMBMON = xmbmon203
+endif
+
 # variables to build installable packages
 # packages are:
 # base (includes docs, utils, uw_sysstat, uw_null and uw_send).
@@ -29,8 +37,8 @@
 CLIENTLIST = uw_send uw_sysstat uw_null
 # order is important here: uw_process should be last
 SERVERLIST = uw_acceptbb uw_accept uw_purple uw_route uw_syncprobes uw_setip uw_process
-MONITORLIST = uw_httpget uw_dns uw_ping uw_mysql uw_mysqlstats uw_pop3 uw_smtp uw_tcpconnect uw_imap \
- ${UW_POSTGRESQL} ${UW_SNMPGET} ${UW_MSSQL}
+MONITORLIST = uw_httpget uw_dns uw_ping uw_pop3 uw_smtp uw_tcpconnect uw_imap \
+ ${UW_MYSQL} ${UW_POSTGRESQL} ${UW_SNMPGET} ${UW_MSSQL}
 IPTRAFLIST = uw_iptraf
 EXTRALIST = ${IPTRAFLIST}
 
@@ -39,6 +47,7 @@
 if ENABLE_SERVER
 SERVERPROG = ${SERVERLIST}
 ENABLE_SERVER = --enable-server
+COMPAT = compat
 endif
 
 if ENABLE_MONITORS
@@ -53,10 +62,6 @@
 
 EXTRAPROG = ${IPTRAFPROG}
 
-if XMBMON
-XMBMON = xmbmon203
-endif
-
 CONFARGS = --enable-client $(ENABLE_SERVER) $(ENABLE_MONITOR) $(ENABLE_IPTRAF)
 
 # order is important: SERVERPROG should be last
@@ -65,11 +70,11 @@
 export PROGNAMES MONITORPROG CLIENTPROG SERVERPROG EXTRAPROG
 export TOP_SRCDIR = $(top_srcdir)
 
-if ENABLE_SERVER
-SUBDIRS = upwatch st-1.4 ${XMBMON} libstatgrab ${PROGNAMES} compat util scripts config common
-else
-SUBDIRS = upwatch st-1.4 ${XMBMON} libstatgrab ${PROGNAMES} util scripts config common 
-endif
+SUBDIRS = upwatch st-1.4 ${XMBMON} libstatgrab uw_send uw_sysstat uw_null \
+  uw_httpget uw_dns uw_ping uw_pop3 uw_smtp uw_tcpconnect uw_imap \
+  uw_mysql uw_mysqlstats uw_postgresql uw_snmpget uw_mssql uw_iptraf \
+  uw_acceptbb uw_accept uw_purple uw_route uw_syncprobes uw_setip uw_process \
+  ${COMPAT} util scripts config common
 
 DIST_SUBDIRS = ${SUBDIRS} doc
 

Modified: upwatch/libdbi/Makefile.am.common
===================================================================
--- upwatch/libdbi/Makefile.am.common	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/Makefile.am.common	2006-07-21 20:34:40 UTC (rev 632)
@@ -32,11 +32,11 @@
 
 %_main.o: $(top_srcdir)/common/main.c $(@:%_main.o=%.def) $(CMDDEF)
 	$(COMPILE) -include $(@:%_main.o=%.h) -o $@ @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ \
-		@MYSQL_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS) -c $(top_srcdir)/common/main.c
+		@LIBOPTS_CFLAGS@ $(AM_CFLAGS) -c $(top_srcdir)/common/main.c
 
 %_db.o: $(top_srcdir)/common/db.c $(@:%_db.o=%.def) $(CMDDEF)
 	$(COMPILE) -include $(@:%_db.o=%.h) -o $@ @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ \
-		@MYSQL_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS) -c $(top_srcdir)/common/db.c
+		@LIBOPTS_CFLAGS@ $(AM_CFLAGS) -c $(top_srcdir)/common/db.c
 
 %.c %.h: %.def
 	autogen -b $(&lt;:%.def=%) $(AGDEFINES) $(GENINCL) $&lt;

Modified: upwatch/libdbi/common/db.c
===================================================================
--- upwatch/libdbi/common/db.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/common/db.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -1,6 +1,5 @@
 #include &quot;config.h&quot;
-#include &lt;mysql.h&gt;
-#include &lt;mysqld_error.h&gt;
+#include &lt;dbi/dbi.h&gt;
 #include &lt;stdarg.h&gt;
 #include &lt;generic.h&gt;
 
@@ -8,74 +7,75 @@
 #include &quot;dmalloc.h&quot;
 #endif
 
-#ifndef HAVE_MYSQL_REAL_ESCAPE
-unsigned long mysql_real_escape_string(MYSQL *mysql, char *to, const char *from, unsigned long length)
-{
-  return(mysql_escape_string(to, from, length));
-}
-#endif
-
-
 /****************************
  database functions. 
  NOTE: Don't use with multithreaded programs!
  ***************************/
-void close_database(MYSQL *mysql)
+void close_database(dbi_conn conn)
 {
-  if (mysql) {
-    //my_transaction(&quot;rollback&quot;);
-    mysql_close(mysql);
-  }
+  dbi_conn_close(conn);
 }
 
-MYSQL *open_database(char *dbhost, int dbport, char *dbname, char *dbuser, char *dbpasswd)
+dbi_conn open_database(const char *dbtype, const char *dbhost, const char *dbport, const char *dbname, const char *dbuser, const char *dbpasswd)
 {
-  MYSQL *mysql;
+  dbi_conn conn;
 
-  mysql = mysql_init(NULL);
-  mysql_options(mysql, MYSQL_OPT_COMPRESS, 0);
-  if (!mysql_real_connect(mysql, dbhost, dbuser, dbpasswd, dbname, dbport, NULL, 0)) {
+  conn = dbi_conn_new(dbtype);
+
+  dbi_conn_set_option(conn, &quot;host&quot;, dbhost);
+  dbi_conn_set_option(conn, &quot;port&quot;, dbport);
+  dbi_conn_set_option(conn, &quot;username&quot;, dbuser);
+  dbi_conn_set_option(conn, &quot;password&quot;, dbpasswd);
+  dbi_conn_set_option(conn, &quot;dbname&quot;, dbname);
+  dbi_conn_set_option(conn, &quot;encoding&quot;, &quot;UTF-8&quot;);
+
+  if (dbi_conn_connect(conn) &lt; 0) {
+    const char *errmsg;
+    dbi_conn_error(conn, &amp;errmsg);
     LOG(LOG_ERR, &quot;%s dbhost=%s,dbport=%d,dbname=%s,dbuser=%s,dbpasswd=%s&quot;,
-           mysql_error(mysql), dbhost, dbport, dbname, dbuser, dbpasswd);
+           errmsg, dbhost, dbport, dbname, dbuser, dbpasswd);
     return(NULL);
   }
-  return(mysql);
+  return(conn);
 }
 
-MYSQL_RES *my_rawquery(MYSQL *mysql, int log_dupes, char *qry)
+dbi_result db_rawquery(dbi_conn conn, int log_dupes, const char *qry)
 {
-  MYSQL_RES *result;
+  dbi_result result;
 
   if (debug &gt; 4) {
     LOGRAW(LOG_DEBUG, qry);
   }
-  if (mysql_query(mysql, qry)) {
+  result = dbi_conn_query(conn, qry);
+  if (dbi_conn_error_flag(conn)) {
+    const char *errmsg;
+    dbi_conn_error(conn, &amp;errmsg);
+/*
     switch (mysql_errno(mysql)) {
     case ER_DUP_ENTRY:
         if (!log_dupes) break;
     default:
-      LOG(LOG_WARNING, &quot;%s:[%u] %s&quot;, qry, mysql_errno(mysql), mysql_error(mysql));
+*/
+    LOG(LOG_WARNING, &quot;%s: %s&quot;, qry, errmsg);
+/*
       break;
     }
+*/
     return(NULL);
   }
-  result = mysql_store_result(mysql);
-  if (mysql_errno(mysql)) {
-    LOG(LOG_WARNING, &quot;%s: [%u] %s&quot;, qry, mysql_errno(mysql), mysql_error(mysql));
-  }
   return(result);
 }
 
-MYSQL_RES *my_query(MYSQL *mysql, int log_dupes, char *fmt, ...)
+dbi_result db_query(dbi_conn conn, int log_dupes, const char *fmt, ...)
 {
 static char qry[65536]; // max query size for us
   va_list arg;
 
-  if (!mysql) return(NULL);
+  if (conn) return(NULL);
 
   va_start(arg, fmt);
   vsnprintf(qry, sizeof(qry)-1, fmt, arg);
   va_end(arg);
-  return my_rawquery(mysql, log_dupes, qry);
+  return db_rawquery(conn, log_dupes, qry);
 }
 

Modified: upwatch/libdbi/common/dbase_options.def
===================================================================
--- upwatch/libdbi/common/dbase_options.def	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/common/dbase_options.def	2006-07-21 20:34:40 UTC (rev 632)
@@ -27,8 +27,8 @@
 flag = {
     must-set;
     name      = dbport;
-    arg_type  = numeric;   /* option argument indication  */
-    arg-default = 3306;
+    arg_type  = string;   /* option argument indication  */
+    arg-default = &quot;3306&quot;;
     descrip   = &quot;Port number on database host&quot;;
     doc       = 
 'Port number to connect to';

Modified: upwatch/libdbi/common/main.c
===================================================================
--- upwatch/libdbi/common/main.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/common/main.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -92,7 +92,7 @@
 
   if (OPT_VALUE_STDERR)  _log2stderr  = TRUE;
   if (OPT_VALUE_SYSLOG)  _log2syslog  = TRUE;
-  if (HAVE_OPT(LOGFILE)) _logfilename = OPT_ARG(LOGFILE);
+  if (HAVE_OPT(LOGFILE)) _logfilename = (char *) OPT_ARG(LOGFILE);
 
   LOG(LOG_NOTICE, &quot;start (Version %s-%s, date %s %s)&quot;, VERSION, RELEASE, __DATE__, __TIME__);
   LOG(LOG_INFO, &quot;using GCC %s&quot;, __VERSION__);

Modified: upwatch/libdbi/common/probe.tpl
===================================================================
--- upwatch/libdbi/common/probe.tpl	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/common/probe.tpl	2006-07-21 20:34:40 UTC (rev 632)
@@ -94,6 +94,7 @@
 ENDIF +][+
 ESAC type +][+ ENDFOR def+]
   PRIMARY KEY  (id),
+  KEY tbldomid (tblid, domid, id),
   KEY server (server),
   KEY notify (notify),
   KEY ipaddress (ipaddress),

Modified: upwatch/libdbi/compat/bb/bbhimport/Makefile.am
===================================================================
--- upwatch/libdbi/compat/bb/bbhimport/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/compat/bb/bbhimport/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -5,8 +5,8 @@
 man_MANS = bbhimport.1
 
 bbhimport_SOURCES = run.c bbhimport.h bbhimport.c
-bbhimport_CFLAGS = @MYSQL_CFLAGS@ @LIBXML2_CFLAGS@ @LIBGLIB2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
-bbhimport_LDADD = bbhimport_$(DB_O) bbhimport_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) @LIBGLIB2_LIBS@ @MYSQL_LIBS@
+bbhimport_CFLAGS = @LIBXML2_CFLAGS@ @LIBGLIB2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
+bbhimport_LDADD = bbhimport_$(DB_O) bbhimport_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) @LIBGLIB2_LIBS@ @LIBDBI_LIBS@
 
 BUILT_SOURCES = $(program:%=%.1) $(program:%=%.h) $(program:%=%.c)
 INCLUDES = -I$(top_srcdir)/upwatch 

Modified: upwatch/libdbi/compat/bb/bbhimport/run.c
===================================================================
--- upwatch/libdbi/compat/bb/bbhimport/run.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/compat/bb/bbhimport/run.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -9,7 +9,7 @@
 #include &quot;../../../probes.enum&quot;
 } probeidx;
 
-void process(MYSQL *mysql, char *ip, char *hostname, char *args);
+void process(dbi_conn conn, char *ip, char *hostname, char *args);
 
 int init(void)
 {
@@ -23,16 +23,16 @@
   FILE *in;
   char buffer[4096];
   int count = 0;
-  MYSQL *mysql;
+  dbi_conn conn;
 
   if (!HAVE_OPT(INPUT)) {
     fprintf(stderr, &quot;parameter -I is required\n&quot;);
     return 0;
   }
 
-  mysql = open_database(OPT_ARG(DBHOST), OPT_VALUE_DBPORT, OPT_ARG(DBNAME), 
+  conn = open_database(OPT_ARG(DBTYPE), OPT_ARG(DBHOST), OPT_ARG(DBPORT), OPT_ARG(DBNAME), 
 			OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
-  if (!mysql) {
+  if (!conn) {
     printf(&quot;Can't open database\n&quot;);
     return 0;
   }
@@ -56,54 +56,53 @@
       arg = strtok(NULL, &quot; \t&quot;);
     }
     count++;
-    process(mysql, ip, hostname, arg ? arg : &quot;&quot;);
+    process(conn, ip, hostname, arg ? arg : &quot;&quot;);
   }
   fclose(in);
-  close_database(mysql);
+  close_database(conn);
   return count;
 }
 
-void process(MYSQL *mysql, char *ip, char *hostname, char *args)
+void process(dbi_conn conn, char *ip, char *hostname, char *args)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   int serverid;
   char *p;
 
-  result = my_query(mysql, 0, &quot;select %s from %s where %s = '%s'&quot;, 
+  result = db_query(conn, 0, &quot;select %s from %s where %s = '%s'&quot;, 
        OPT_ARG(SERVER_TABLE_ID_FIELD), OPT_ARG(SERVER_TABLE_NAME), 
        OPT_ARG(SERVER_TABLE_NAME_FIELD), hostname);
   if (!result) {
     printf(&quot;internal error. Stop.\n&quot;);
     exit(1);
   }
-  row = mysql_fetch_row(result);
-  if (!row || !row[0]) {
-    mysql_free_result(result);
+  if (!dbi_result_next_row(result)) {
+    dbi_result_free(result);
     return;
   }
-  serverid = atoi(row[0]);
-  mysql_free_result(result);
+  serverid = dbi_result_get_uint_idx(result, 0);
+  dbi_result_free(result);
   if (!serverid) return;
 
   if (strstr(args, &quot;noping&quot;) == NULL) {
     int rows;
 
-    result = my_query(mysql, 0, 
+    result = db_query(conn, 0, 
                       &quot;select id from pr_ping_def where server = '%d' and ipaddress = '%s'&quot;,
                       serverid, ip);
     if (!result) {
       printf(&quot;internal error. Stop.\n&quot;);
       exit(1);
     }
-    rows = mysql_num_rows(result);
-    mysql_free_result(result);
+    rows = dbi_result_get_numrows(result);
+    dbi_result_free(result);
 
     if (rows == 0) { 
       printf(&quot;INSERT ping %s %s\n&quot;, ip, hostname);
-      my_query(mysql, 0, 
+      result = db_query(conn, 0, 
                &quot;insert into pr_ping_def set server = '%d', ipaddress = '%s', description = '%s'&quot;,
                serverid, ip, hostname);
+      dbi_result_free(result);
     } else {
       printf(&quot;ALREADY THERE: ping %s %s\n&quot;, ip, hostname);
     }
@@ -129,21 +128,22 @@
     }
     URI[i] = 0;
 
-    result = my_query(mysql, 0,
+    result = db_query(conn, 0,
                       &quot;select id from pr_httpget_def where server = '%d' and ipaddress = '%s' and &quot;
                       &quot;hostname = '%s' and uri = '%s'&quot;, serverid, ip, HostName, URI);
     if (!result) {
       printf(&quot;internal error. Stop.\n&quot;);
       exit(1);
     }
-    rows = mysql_num_rows(result);
-    mysql_free_result(result);
+    rows = dbi_result_get_numrows(result);
+    dbi_result_free(result);
 
     if (rows == 0) { 
       printf(&quot;INSERT httpget %s %s <A HREF="http://%s%s\n">http://%s%s\n</A>&quot;, ip, hostname, HostName, URI);
-      my_query(mysql, 0,
+      result = db_query(conn, 0,
                &quot;insert into pr_httpget_def set server = '%d', ipaddress = '%s', description = '%s', &quot;
                &quot;hostname = '%s', uri = '%s'&quot;, serverid, ip, hostname, HostName, URI);
+      dbi_result_free(result);
     } else {
       printf(&quot;ALREADY THERE: httpget %s %s <A HREF="http://%s%s\n">http://%s%s\n</A>&quot;, ip, hostname, HostName, URI);
     }
@@ -152,21 +152,22 @@
   if ((p = strstr(args, &quot;pop-3&quot;)) != NULL || (p = strstr(args, &quot;pop3&quot;)) != NULL) {
     int rows;
 
-    result = my_query(mysql, 0,
+    result = db_query(conn, 0,
                       &quot;select id from pr_pop3_def where server = '%d' and ipaddress = '%s'&quot;,
                       serverid, ip);
     if (!result) {
       printf(&quot;internal error. Stop.\n&quot;);
       exit(1);
     }
-    rows = mysql_num_rows(result);
-    mysql_free_result(result);
+    rows = dbi_result_get_numrows(result);
+    dbi_result_free(result);
 
     if (rows == 0) { 
       printf(&quot;INSERT pop-3 %s %s\n&quot;, ip, hostname);
-      my_query(mysql, 0,
+      result = db_query(conn, 0,
                &quot;insert into pr_pop3_def set server = '%d', ipaddress = '%s', description = '%s'&quot;,
                serverid, ip, hostname);
+      dbi_result_free(result);
     } else {
       printf(&quot;ALREADY THERE: pop3 %s %s \n&quot;, ip, hostname);
     }
@@ -175,21 +176,22 @@
   if ((p = strstr(args, &quot;imap&quot;)) != NULL) {
     int rows;
 
-    result = my_query(mysql, 0,
+    result = db_query(conn, 0,
                       &quot;select id from pr_imap_def where server = '%d' and ipaddress = '%s'&quot;,
                       serverid, ip);
     if (!result) {
       printf(&quot;internal error. Stop.\n&quot;);
       exit(1);
     }
-    rows = mysql_num_rows(result);
-    mysql_free_result(result);
+    rows = dbi_result_get_numrows(result);
+    dbi_result_free(result);
 
     if (rows == 0) { 
       printf(&quot;INSERT imap %s %s\n&quot;, ip, hostname);
-      my_query(mysql, 0,
+      result = db_query(conn, 0,
                &quot;insert into pr_imap_def set server = '%d', ipaddress = '%s', description = '%s'&quot;,
                serverid, ip, hostname);
+      dbi_result_free(result);
     } else {
       printf(&quot;ALREADY THERE: imap %s %s \n&quot;, ip, hostname);
     }

Modified: upwatch/libdbi/configure.ac
===================================================================
--- upwatch/libdbi/configure.ac	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/configure.ac	2006-07-21 20:34:40 UTC (rev 632)
@@ -35,6 +35,8 @@
     fi]
 )
 
+CFLAGS=&quot;${CFLAGS} -I/usr/include/autoopts&quot;
+
 # ----------------------------------------------------------------------
 # Set some global things based on os type
 # ----------------------------------------------------------------------
@@ -291,6 +293,7 @@
 done
 
 AC_SUBST(LIBOPTS_CFLAGS)
+
 ################## MYSQL
 # path to libmysqlclient stuff:.
 AC_ARG_WITH(mysql-libs,
@@ -299,19 +302,6 @@
     [MYSQL_LIB_PREFIX=/usr/lib/mysql]
 )
 AC_SUBST(MYSQL_LIB_PREFIX)
-
-for libpath in /usr/lib/mysql $MYSQL_LIB_PREFIX /usr/local/lib/mysql /usr/lib /cygdrive/c/mysql/lib/opt /usr/pkg/lib/mysql
-do
-  for file in $libpath/libmysqlclient.so* $libpath/mysqlclient.lib
-  do
-    if test -f $file
-    then
-      MYSQL_LIBS=&quot;-L${libpath} -lmysqlclient&quot;
-      break
-    fi
-  done
-done
-
 # path to mysql includes
 AC_ARG_WITH(mysql-include,
     [  --with-mysql-include=&lt;path&gt;        prefix of MySQL headers. Default /usr/include/mysql],
@@ -320,26 +310,36 @@
 )
 AC_SUBST(MYSQL_INC_PREFIX)
 
-for incpath in /usr/include/mysql $MYSQL_LIB_PREFIX /usr/local/include/mysql /cygdrive/c/mysql/include /usr/pkg/include/mysql
-do
-  if test -f $incpath/mysql.h
-  then
-    MYSQL_CFLAGS=&quot;-I${incpath}&quot;
-  fi
-done
+if test x$enable_monitors = xyes
+then
+  for libpath in /usr/lib/mysql $MYSQL_LIB_PREFIX /usr/local/lib/mysql /usr/lib /cygdrive/c/mysql/lib/opt /usr/pkg/lib/mysql
+  do
+    for file in $libpath/libmysqlclient.so* $libpath/mysqlclient.lib
+    do
+      if test -f $file
+      then
+        MYSQL_LIBS=&quot;-L${libpath} -lmysqlclient&quot;
+        break
+      fi
+    done
+  done
 
-if test &quot;$enable_monitors&quot; = &quot;yes&quot; -o &quot;$enable_server&quot; = &quot;yes&quot;
-then
-  if test -z &quot;$MYSQL_LIBS&quot;
-  then
-    AC_MSG_ERROR([Cannot find MySQL libraries, tell me where they are with --with-mysql-libs=])
-  fi
+  for incpath in /usr/include/mysql $MYSQL_LIB_PREFIX /usr/local/include/mysql /cygdrive/c/mysql/include /usr/pkg/include/mysql
+  do
+    if test -f $incpath/mysql.h
+    then
+      MYSQL_CFLAGS=&quot;-I${incpath}&quot;
+    fi
+  done
+
   if test -z &quot;$MYSQL_CFLAGS&quot;
   then
-    AC_MSG_ERROR([Cannot find MySQL include files, tell me where they are with --with-mysql-include=])
+    HAVE_LIBMYSQL=&quot;0&quot;
+  else
+    HAVE_LIBMYSQL=&quot;1&quot;
   fi
 fi
-
+AM_CONDITIONAL(HAVE_LIBMYSQL, test $HAVE_LIBMYSQL -eq 1)
 AC_SUBST(MYSQL_CFLAGS)
 AC_SUBST(MYSQL_LIBS)
 
@@ -483,11 +483,13 @@
 AC_CHECK_LIB([curses], [initscr], [HAVE_LIBCURSES=1], [HAVE_LIBCURSES=0])
 if test $HAVE_LIBCURSES -eq 1
 then
+	AC_DEFINE(HAVE_LIBCURSES,1,[is libcurses available on this system])
         LIBCURSES_LIBS=-lcurses
 fi
 AC_CHECK_LIB([ncurses], [initscr], [HAVE_LIBNCURSES=1], [HAVE_LIBNCURSES=0])
 if test $HAVE_LIBNCURSES -eq 1
 then
+	AC_DEFINE(HAVE_LIBCURSES,1,[is libcurses available on this system])
         LIBCURSES_LIBS=-lncurses
 fi
 AM_CONDITIONAL(HAVE_CURSES, test ! -z $LIBCURSES_LIBS)
@@ -501,6 +503,7 @@
 AC_CHECK_LIB([pcap], [pcap_close], [HAVE_LIBPCAP=1], [HAVE_LIBPCAP=0])
 if test $HAVE_LIBPCAP -eq 1
 then
+	AC_DEFINE(HAVE_LIBPCAP,1,[is libpcap available on this system])
 	LIBPCAP_LIBS=-lpcap
 fi
 AM_CONDITIONAL(HAVE_LIBPCAP, test $HAVE_LIBPCAP -eq 1)
@@ -524,6 +527,18 @@
 AM_CONDITIONAL(HAVE_LIBCRYPTO, test $HAVE_LIBCRYPTO -eq 1)
 AC_SUBST(LIBCRYPTO_LIBS)
 
+# libdbi
+AC_CHECK_LIB([dbi], [dbi_conn_quote_string], [HAVE_LIBDBI=1], [HAVE_LIBDBI=0])
+if test $HAVE_LIBDBI -eq 1
+then
+	LIBDBI_LIBS=-ldbi
+else
+	AC_MSG_ERROR([Sorry, we need libdbi &gt;= 0.8 to continue])
+fi
+AM_CONDITIONAL(HAVE_LIBDBI, test $HAVE_LIBDBI -eq 1)
+AC_SUBST(LIBDBI_LIBS)
+AC_SUBST(LIBDBI_CFLAGS)
+
 # snmp
 AC_CHECK_LIB([snmp], [snmp_errno], [HAVE_LIBSNMP=1], [HAVE_LIBSNMP=0], -lcrypto)
 if test $HAVE_LIBSNMP -eq 1
@@ -533,6 +548,7 @@
 	AC_CHECK_LIB([netsnmp], [snmp_errno], [HAVE_LIBSNMP=1], [HAVE_LIBSNMP=0], -lcrypto)
 	if test $HAVE_LIBSNMP -eq 1
 	then
+		AC_DEFINE(HAVE_LIBSNMP,1,[are the netsnmp libraries available on this system])
 		LIBSNMP_LIBS=-lnetsnmp
 	fi
 fi
@@ -557,6 +573,7 @@
 AC_CHECK_LIB([readline], [readline], [HAVE_LIBREADLINE=1], [HAVE_LIBREADLINE=0], -lncurses)
 if test $HAVE_LIBREADLINE -eq 1
 then
+	AC_DEFINE(HAVE_LIBREADLINE,1,[Is the readline library available on this system])
 	LIBREADLINE_LIBS=-lreadline
         AC_DEFINE(HAVE_LIBREADLINE,1,[Do we have the readline library])
 else 
@@ -575,6 +592,7 @@
 if test $HAVE_LIBTDS -eq 1
 then
 	LIBTDS_LIBS=-ltds
+	AC_DEFINE(HAVE_LIBTDS,1,[Is libtds available on this system])
 fi
 AM_CONDITIONAL(HAVE_LIBTDS, test $HAVE_LIBTDS -eq 1)
 AC_SUBST(LIBTDS_LIBS)
@@ -583,6 +601,7 @@
 AC_CHECK_LIB([pq], [PQclear], [HAVE_LIBPQ=1], [HAVE_LIBPQ=0])
 if test $HAVE_LIBPQ -eq 1
 then
+	AC_DEFINE(HAVE_LIBPQ,1,[Is postgres available on this system])
 	LIBPQ_LIBS=-lpq
 	LIBPQ_CFLAGS=&quot;&quot;
 	if test -f /usr/include/pgsql/libpq-fe.h
@@ -630,7 +649,7 @@
 AC_FUNC_STAT
 AC_FUNC_STRFTIME
 AC_CHECK_FUNCS([alarm atexit dup2 gethostbyname gethostname gettimeofday inet_ntoa memset putenv regcomp select socket strchr strdup strerror strncasecmp strrchr strstr strtol strtoul tzset uname])
-AC_CHECK_LIB(mysqlclient, mysql_real_escape_string, AC_DEFINE(HAVE_MYSQL_REAL_ESCAPE,1,[Does mysql have real_escape]),,[$MYSQL_LIBS])
+AC_CHECK_LIB(dbi, dbi_result_get_uint, AC_DEFINE(HAVE_LIBDBI_GET_UINT,1,[Does libdbi have dbi_result_get_uint]),,[$DBI_LIBS])
 
 echo 
 echo &quot;*********************************************************&quot;
@@ -650,17 +669,22 @@
 then
   if test $HAVE_LIBSNMP -eq 0
   then
-    echo &quot;* snmp libs (or openssl libs) not found, no SNMP support&quot;
+    echo &quot;* snmp libs (or openssl libs) not found, SNMP probes will not be built&quot;
   fi
 
   if test $HAVE_LIBTDS -eq 0
   then
-    echo &quot;* TDS lib not found, no MS-SQL support&quot;
+    echo &quot;* TDS lib not found, MS-SQL related probes will not be built&quot;
   fi
 
+  if test $HAVE_LIBMYSQL -eq 0
+  then
+    echo &quot;* MySQL not found, related probes not built&quot;
+  fi
+
   if test $HAVE_LIBPQ -eq 0
   then
-    echo &quot;* PostgreSQL not found, no PostgreSQL support&quot;
+    echo &quot;* PostgresSQL not found, related probes will not be built&quot;
   fi
 fi
 
@@ -683,48 +707,50 @@
 
 if test &quot;$enable_server&quot; = &quot;yes&quot; -o &quot;$enable_monitors&quot; = &quot;yes&quot;
 then
-AC_CONFIG_FILES([st-1.4/Makefile])
+  AC_CONFIG_FILES([st-1.4/Makefile])
 fi
 
 # server 
 if test &quot;$enable_server&quot; = &quot;yes&quot;
 then
-AC_CONFIG_FILES([uw_setip/Makefile])
-AC_CONFIG_FILES([uw_accept/Makefile])
-AC_CONFIG_FILES([uw_acceptbb/Makefile])
-AC_CONFIG_FILES([uw_purple/Makefile])
-AC_CONFIG_FILES([uw_route/Makefile])
-AC_CONFIG_FILES([uw_process/Makefile])
-AC_CONFIG_FILES([uw_syncprobes/Makefile])
-AC_CONFIG_FILES([compat/Makefile])
-AC_CONFIG_FILES([compat/sometests/Makefile])
-AC_CONFIG_FILES([compat/sometests/setproctitle/Makefile])
-AC_CONFIG_FILES([compat/bb/Makefile])
-AC_CONFIG_FILES([compat/bb/bbhimport/Makefile])
+  AC_CONFIG_FILES([uw_setip/Makefile])
+  AC_CONFIG_FILES([uw_accept/Makefile])
+  AC_CONFIG_FILES([uw_acceptbb/Makefile])
+  AC_CONFIG_FILES([uw_purple/Makefile])
+  AC_CONFIG_FILES([uw_route/Makefile])
+  AC_CONFIG_FILES([uw_process/Makefile])
+  AC_CONFIG_FILES([uw_syncprobes/Makefile])
+  AC_CONFIG_FILES([compat/Makefile])
+  AC_CONFIG_FILES([compat/sometests/Makefile])
+  AC_CONFIG_FILES([compat/sometests/setproctitle/Makefile])
+  AC_CONFIG_FILES([compat/bb/Makefile])
+  AC_CONFIG_FILES([compat/bb/bbhimport/Makefile])
 fi
 
 # monitors
 if test &quot;$enable_monitors&quot; = &quot;yes&quot;
 then
-AC_CONFIG_FILES([uw_httpget/Makefile])
-AC_CONFIG_FILES([uw_dns/Makefile])
-AC_CONFIG_FILES([uw_ping/Makefile])
-AC_CONFIG_FILES([uw_mysql/Makefile])
-AC_CONFIG_FILES([uw_mysqlstats/Makefile])
-AC_CONFIG_FILES([uw_pop3/Makefile])
-AC_CONFIG_FILES([uw_smtp/Makefile])
-AC_CONFIG_FILES([uw_tcpconnect/Makefile])
-AC_CONFIG_FILES([uw_imap/Makefile])
-AC_CONFIG_FILES([uw_snmpget/Makefile])
-AC_CONFIG_FILES([uw_mssql/Makefile])
-AC_CONFIG_FILES([uw_postgresql/Makefile])
+  AC_CONFIG_FILES([uw_httpget/Makefile])
+  AC_CONFIG_FILES([uw_dns/Makefile])
+  AC_CONFIG_FILES([uw_ping/Makefile])
+  AC_CONFIG_FILES([uw_mysql/Makefile])
+  AC_CONFIG_FILES([uw_mysqlstats/Makefile])
+  AC_CONFIG_FILES([uw_pop3/Makefile])
+  AC_CONFIG_FILES([uw_smtp/Makefile])
+  AC_CONFIG_FILES([uw_tcpconnect/Makefile])
+  AC_CONFIG_FILES([uw_imap/Makefile])
+  AC_CONFIG_FILES([uw_snmpget/Makefile])
+  AC_CONFIG_FILES([uw_mssql/Makefile])
+  AC_CONFIG_FILES([uw_postgresql/Makefile])
 fi
 
 # extra
 if test &quot;$enable_iptraf&quot; = &quot;yes&quot;
 then
-AC_CONFIG_FILES([uw_iptraf/Makefile])
+if test $HAVE_LIBPCAP -eq 1; then
+  AC_CONFIG_FILES([uw_iptraf/Makefile])
 fi
+fi
 
 ( cd libstatgrab ; ./configure --disable-manpages --disable-examples \
   --disable-statgrab --disable-saidar --disable-shared ; cd .. )

Modified: upwatch/libdbi/doc/installation.xml
===================================================================
--- upwatch/libdbi/doc/installation.xml	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/doc/installation.xml	2006-07-21 20:34:40 UTC (rev 632)
@@ -119,13 +119,19 @@
         &lt;title&gt;Database&lt;/title&gt;
         &lt;para&gt;You actually need to create two databases, one for the probes to read from, and one 
         for the results to be written to. The first database should be called upwatch, the other
-        one can be any name (in this example we use netland). Create the databases as follows. (You DO have a root 
-        password set for mysql don't you?)&lt;/para&gt;
+        one can be any name (in this example we use netland). If you have a new database installation
+        create a password for the root account, and remove the anonymous accounts as follows:&lt;para&gt;
         &lt;literallayout&gt;
+           $ mysql -u root 
+           mysql&gt; DELETE FROM mysql.user WHERE User = '';
+           mysql&gt; SET PASSWORD FOR 'root'@'localhost' = PASSWORD('newpwd');
+        &lt;/literallayout&gt;&lt;/para&gt;
+        &lt;para&gt;Now create the databases as follows.&lt;/para&gt;
+        &lt;literallayout&gt;
            $ mysqladmin -u root --password=PASSWORD create upwatch
-           $ mysql -u root --password=PASSWORD upwatch &lt; upwatch-base.mysql
+           $ mysql -u root --password=PASSWORD upwatch &lt; /usr/share/doc/upwatch-xxx/upwatch-base.mysql
            $ mysqladmin -u root --password=PASSWORD create netland
-           $ mysql -u root --password=PASSWORD netland &lt; upwatch-full.mysql
+           $ mysql -u root --password=PASSWORD netland &lt; i/usr/share/doc/upwatch-xxx/upwatch-full.mysql
         &lt;/literallayout&gt;
         &lt;para&gt;Of course you need to assign users and GRANT them access. We start with 
            the probes. We assume the probes are running on a separate host with ip address 192.168.1.23.
@@ -178,7 +184,7 @@
           dbtype mysql
           dbhost localhost
           dbport 3306
-          dbname dymos
+          dbname netland
           dbuser upwatch
           dbpasswd PASSWORD
         &lt;/literallayout&gt;

Modified: upwatch/libdbi/doc/program-guide.html
===================================================================
(Binary files differ)

Modified: upwatch/libdbi/doc/program-guide.txt
===================================================================
(Binary files differ)

Modified: upwatch/libdbi/st-1.4/st.spec
===================================================================
--- upwatch/libdbi/st-1.4/st.spec	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/st-1.4/st.spec	2006-07-21 20:34:40 UTC (rev 632)
@@ -2,7 +2,7 @@
 Name:		st
 Version:	1.4
 Release:	1
-Copyright:	MPL 1.2 or GPL 2+
+License:	MPL 1.2 or GPL 2+
 Packager:	Wesley W. Terpstra &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/upwatch-commits">wesley at terpstra.ca</A>&gt;
 Source:		<A HREF="http://prdownloads.sourceforge.net/state-threads/st-%{version">http://prdownloads.sourceforge.net/state-threads/st-%{version</A>}.tar.gz
 Prefix:		/usr

Modified: upwatch/libdbi/upwatch/Makefile.am
===================================================================
--- upwatch/libdbi/upwatch/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/upwatch/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -7,7 +7,7 @@
 endif
 
 if ENABLE_SERVER
-SERVER_SOURCE = pr_process.c pr_bb.c pr_bb_cpu.c pr_httpget.c pr_mysqlstats.c \
+SERVER_SOURCE = pr_bb.c pr_process.c pr_bb_cpu.c pr_httpget.c pr_mysqlstats.c \
  pr_ping.c pr_snmpget.c pr_sysstat.c pr_iptraf.c pr_generic.c pr_hwstat.c 
 endif
 
@@ -17,7 +17,7 @@
  findsaddr.h gnuc.h logregex.h probe.h
 
 if ENABLE_SERVER
-pr_process.c: probe.h
+pr_bb.c: probe.h
 
 probe.h: ../uw_acceptbb/probe.res_h  ../uw_httpget/probe.res_h \
  ../uw_imap/probe.res_h ../uw_iptraf/probe.res_h ../uw_mssql/probe.res_h ../uw_mysql/probe.res_h \
@@ -29,8 +29,8 @@
 endif
 
 libupwatch_a_SOURCES = $(sources)
-libupwatch_a_CFLAGS = @LIBXML2_CFLAGS@ @LIBGLIB2_CFLAGS@ @MYSQL_CFLAGS@ @LIBPCRE_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
+libupwatch_a_CFLAGS = @LIBXML2_CFLAGS@ @LIBGLIB2_CFLAGS@ @LIBPCRE_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
 
 libupwatcht_a_SOURCES = $(sources)
-libupwatcht_a_CFLAGS = @LIBXML2_CFLAGS@ @LIBGLIB2_CFLAGS@ @MYSQL_CFLAGS@ @LIBPCRE_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS) -DWITH_THREADS
+libupwatcht_a_CFLAGS = @LIBXML2_CFLAGS@ @LIBGLIB2_CFLAGS@ @LIBPCRE_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS) -DWITH_THREADS
 

Modified: upwatch/libdbi/upwatch/compat.h
===================================================================
--- upwatch/libdbi/upwatch/compat.h	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/upwatch/compat.h	2006-07-21 20:34:40 UTC (rev 632)
@@ -10,11 +10,5 @@
 #define INADDR_NONE ((unsigned long) -1)
 #endif
 
-#if defined(ENABLE_SERVER)
-#ifndef HAVE_MYSQL_REAL_ESCAPE
-unsigned long mysql_real_escape_string(MYSQL *mysql, char *to, const char *from, unsigned long length);
 #endif
-#endif
 
-#endif
-

Modified: upwatch/libdbi/upwatch/db.h
===================================================================
--- upwatch/libdbi/upwatch/db.h	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/upwatch/db.h	2006-07-21 20:34:40 UTC (rev 632)
@@ -1,12 +1,16 @@
 #if !defined(__DB_H) 
 #define __DB_H
 
-#include &lt;mysql.h&gt;
-#include &lt;mysqld_error.h&gt;
+#include &lt;dbi/dbi.h&gt;
 
-MYSQL *open_database(char *dbhost, int dbport, char *dbname, char *dbuser, char *dbpasswd);
-void close_database(MYSQL *mysql);
-MYSQL_RES *my_query(MYSQL *mysql, int log_dupes, char *qry, ...);
-MYSQL_RES *my_rawquery(MYSQL *mysql, int log_dupes, char *qry);
+dbi_conn open_database(const char *dbtype, const char *dbhost, const char *dbport, const char *dbname, const char *dbuser, const char *dbpasswd);
+void close_database(dbi_conn conn);
+dbi_result db_query(dbi_conn conn, int log_dupes, const char *qry, ...);
+dbi_result db_rawquery(dbi_conn conn, int log_dupes, const char *qry);
 
+#ifndef HAVE_LIBDBI_GET_UINT
+#define dbi_result_get_uint(a,b)  dbi_result_get_ulong(a,b)
+#define dbi_result_get_uint_idx(a,b)  dbi_result_get_ulong_idx(a,b)
+#endif
+
 #endif /* __DB_H */

Modified: upwatch/libdbi/upwatch/pr_bb.c
===================================================================
--- upwatch/libdbi/upwatch/pr_bb.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/upwatch/pr_bb.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -8,7 +8,7 @@
 #include &quot;dmalloc.h&quot;
 #endif
 
-char *query_server_by_name;
+const char *query_server_by_name;
 
 void bb_free_res(void *res)
 {
@@ -41,8 +41,7 @@
 {
   struct probe_def *def;
   struct bb_result *res = (struct bb_result *)t-&gt;res;
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
 
   def = g_malloc0(t-&gt;probe-&gt;def_size);
   def-&gt;stamp    = time(NULL);
@@ -52,7 +51,7 @@
 
   if (res-&gt;color == STAT_PURPLE &amp;&amp; res-&gt;probeid) {
     // find the definition based on the probe id
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                       &quot;select id, contact, hide, email, delay from pr_bb_def &quot;
                       &quot;where  id = '%u'&quot;, res-&gt;probeid);
     if (!result) {
@@ -68,26 +67,25 @@
         g_free(def);
         return(NULL);
       }
-      result = my_query(t-&gt;probe-&gt;db, 0, query_server_by_name, res-&gt;hostname, res-&gt;hostname, 
+      result = db_query(t-&gt;probe-&gt;db, 0, query_server_by_name, res-&gt;hostname, res-&gt;hostname, 
                         res-&gt;hostname, res-&gt;hostname, res-&gt;hostname);
       if (!result) {
         g_free(def);
         return(NULL);
       }
-      row = mysql_fetch_row(result);
-      if (row &amp;&amp; row[0]) {
-        res-&gt;server   = atoi(row[0]);
-      } else {
+      if (dbi_result_get_numrows(result) == 0) {
         LOG(LOG_WARNING, &quot;%s:%u@%s: server %s not found&quot;, res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;hostname);
-        mysql_free_result(result);
+        dbi_result_free(result);
         g_free(def);
         return(NULL);
       }
-      mysql_free_result(result);
+      dbi_result_next_row(result);
+      res-&gt;server = dbi_result_get_uint(result, &quot;id&quot;);
+      dbi_result_free(result);
     }
 
     // first find the definition based on the serverid
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                       &quot;select id, contact, hide, email, delay from pr_bb_def &quot;
                       &quot;where  bbname = '%s' and server = '%u'&quot;, res-&gt;bbname, res-&gt;server);
     if (!result) {
@@ -95,53 +93,53 @@
       return(NULL);
     }
   }
-  if (mysql_num_rows(result) == 0) { // DEF RECORD NOT FOUND
-    mysql_free_result(result);
-    result = my_query(t-&gt;probe-&gt;db, 0,
+  if (dbi_result_get_numrows(result) == 0) { // DEF RECORD NOT FOUND
+    dbi_result_free(result);
+    result = db_query(t-&gt;probe-&gt;db, 0,
                       &quot;insert into pr_%s_def set server = '%u', ipaddress = '%s', &quot; 
                       &quot;       description = '%s', bbname = '%s'&quot;, 
                        res-&gt;name, res-&gt;server, res-&gt;ipaddress ? res-&gt;ipaddress : &quot;&quot;, 
                        res-&gt;hostname, res-&gt;bbname);
-    mysql_free_result(result);
-    def-&gt;probeid = mysql_insert_id(t-&gt;probe-&gt;db);
+    dbi_result_free(result);
+    def-&gt;probeid = dbi_conn_sequence_last(t-&gt;probe-&gt;db, NULL);
     LOG(LOG_NOTICE, &quot;%s:%u@%s: pr_bb_def %s created for %s, id = %u&quot;, 
         res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;bbname, res-&gt;hostname, def-&gt;probeid);
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;select id, contact, hide, email, delay from pr_bb_def &quot;
                     &quot;where  bbname = '%s' and server = '%u'&quot;, res-&gt;bbname, res-&gt;server);
     if (!result) return(NULL);
   }
-  row = mysql_fetch_row(result);
-  if (!row || !row[0]) {
+  if (dbi_result_get_numrows(result) == 0) {
     LOG(LOG_NOTICE, &quot;%s:%u@%s: no pr_%s_def found for server %u - skipped&quot;, 
          res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, res-&gt;server);
-    mysql_free_result(result);
+    dbi_result_free(result);
     return(NULL);
   }
 
-  if (row[0])  def-&gt;probeid = atoi(row[0]);
-  if (row[1])  def-&gt;contact = atoi(row[1]);
-  strcpy(def-&gt;hide, row[2] ? row[2] : &quot;no&quot;);
-  strcpy(def-&gt;email, row[3] ? row[3] : &quot;&quot;);
-  if (row[4]) def-&gt;delay = atoi(row[4]);
+  dbi_result_next_row(result);
+  def-&gt;probeid = dbi_result_get_uint(result, &quot;id&quot;);
+  def-&gt;contact = dbi_result_get_uint(result, &quot;contact&quot;);
+  strcpy(def-&gt;hide, dbi_result_get_string(result, &quot;hide&quot;));
+  strcpy(def-&gt;email, dbi_result_get_string(result, &quot;email&quot;));
+  def-&gt;delay = dbi_result_get_uint(result, &quot;delay&quot;);
 
-  mysql_free_result(result);
+  dbi_result_free(result);
 
   // definition found, get the pr_status
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;select color, stattime &quot;
                     &quot;from   pr_status &quot;
                     &quot;where  class = '%u' and probe = '%u'&quot;, t-&gt;probe-&gt;class, def-&gt;probeid);
   if (result) {
-    row = mysql_fetch_row(result);
-    if (row) {
-      if (row[0]) def-&gt;color   = atoi(row[0]);
-      if (row[1]) def-&gt;newest  = atoi(row[1]);
-    } else {
+    if (dbi_result_get_numrows(result) == 0) { // DEF RECORD NOT FOUND
       LOG(LOG_NOTICE, &quot;%s:%u@%s: pr_status record for %s id %u (server %s) not found&quot;, 
                        res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, def-&gt;probeid, res-&gt;hostname);
+    } else {
+      dbi_result_next_row(result);
+      def-&gt;color   = dbi_result_get_uint(result, &quot;color&quot;);
+      def-&gt;newest  = dbi_result_get_uint(result, &quot;stattime&quot;);
+      dbi_result_free(result);
     }
-    mysql_free_result(result);
   }
   if (!def-&gt;color) def-&gt;color = res-&gt;color;
   res-&gt;probeid = def-&gt;probeid;

Modified: upwatch/libdbi/upwatch/pr_bb_cpu.c
===================================================================
--- upwatch/libdbi/upwatch/pr_bb_cpu.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/upwatch/pr_bb_cpu.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -63,26 +63,24 @@
 {
   struct probe_def *def;
   struct bb_cpu_result *res = (struct bb_cpu_result *)t-&gt;res;
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   time_t now = time(NULL);
 
   if (res-&gt;color != STAT_PURPLE &amp;&amp; res-&gt;server == 0) { 
     // first we find the serverid, this will be used to find the probe definition in the hashtable
-    result = my_query(t-&gt;probe-&gt;db, 0, query_server_by_name, res-&gt;hostname, res-&gt;hostname, 
+    result = db_query(t-&gt;probe-&gt;db, 0, query_server_by_name, res-&gt;hostname, res-&gt;hostname, 
                       res-&gt;hostname, res-&gt;hostname, res-&gt;hostname);
     if (!result) {
       return(NULL);
     }
-    row = mysql_fetch_row(result);
-    if (row &amp;&amp; row[0]) {
-      res-&gt;server   = atoi(row[0]);
-    } else {
+    if (dbi_result_get_numrows(result) == 0) {
       LOG(LOG_NOTICE, &quot;%s:%u@%s: server %s not found&quot;, res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;hostname);
-      mysql_free_result(result);
+      dbi_result_free(result);
       return(NULL);
     }
-    mysql_free_result(result);
+    dbi_result_next_row(result);
+    res-&gt;server = dbi_result_get_uint_idx(result, 0);
+    dbi_result_free(result);
   }
 
   // look in the cache for the def
@@ -100,70 +98,71 @@
     strcpy(def-&gt;hide, &quot;no&quot;);
 
     // first find the definition based on the serverid
-    result = my_query(t-&gt;probe-&gt;db, 0, &quot;select id, yellow, red, contact, hide, email, delay &quot;
+    result = db_query(t-&gt;probe-&gt;db, 0, &quot;select id, yellow, red, contact, hide, email, delay &quot;
                                     &quot;from pr_%s_def where server = '%u'&quot;, 
                       res-&gt;name, res-&gt;server);
     if (!result) {
       g_free(def);
       return(NULL);
     }
-    if (mysql_num_rows(result) == 0) { // DEF RECORD NOT FOUND
+    if (dbi_result_get_numrows(result) == 0) { // DEF RECORD NOT FOUND
       // no def record found? Create one. 
-      mysql_free_result(result);
-      result = my_query(t-&gt;probe-&gt;db, 0, 
+      dbi_result_free(result);
+      result = db_query(t-&gt;probe-&gt;db, 0, 
                         &quot;insert into pr_%s_def set server = '%u', description = '%s'&quot;, 
                          res-&gt;name, res-&gt;server, res-&gt;hostname);
-      mysql_free_result(result);
-      def-&gt;probeid = mysql_insert_id(t-&gt;probe-&gt;db);
+      dbi_result_free(result);
+      def-&gt;probeid = dbi_conn_sequence_last(t-&gt;probe-&gt;db, NULL);
       LOG(LOG_NOTICE, &quot;%s:%u@%s: pr_%s_def created for %s, id = %u&quot;, 
           res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, res-&gt;hostname, def-&gt;probeid);
-      result = my_query(t-&gt;probe-&gt;db, 0, &quot;select id, yellow, red, contact, hide, email, delay &quot;
+      result = db_query(t-&gt;probe-&gt;db, 0, &quot;select id, yellow, red, contact, hide, email, delay &quot;
                                       &quot;from pr_%s_def where id = '%u'&quot;, 
                         res-&gt;name, def-&gt;probeid);
     }
-    row = mysql_fetch_row(result);
-    if (!row || !row[0]) {
+    if (dbi_result_get_numrows(result) == 0) {
       LOG(LOG_NOTICE, &quot;%s:%u@%s: no pr_%s_def found for server %u - skipped&quot;, 
           res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, res-&gt;server);
-      mysql_free_result(result);
+      dbi_result_free(result);
       g_free(def);
       return(NULL);
     } 
-    if (row[0]) def-&gt;probeid = atoi(row[0]);
-    if (row[1]) def-&gt;yellow = atof(row[1]);
-    if (row[2]) def-&gt;red = atof(row[2]);
-    if (row[3]) def-&gt;contact = atof(row[3]);
-    strcpy(def-&gt;hide, row[4] ? row[4] : &quot;no&quot;);
-    strcpy(def-&gt;email, row[5] ? row[5] : &quot;&quot;);
-    if (row[6]) def-&gt;delay = atoi(row[6]);
+    dbi_result_next_row(result);
 
-    mysql_free_result(result);
-    result = my_query(t-&gt;probe-&gt;db, 0, 
+    def-&gt;probeid = dbi_result_get_uint(result, &quot;id&quot;);
+    def-&gt;yellow = dbi_result_get_float(result, &quot;yellow&quot;);
+    def-&gt;red = dbi_result_get_float(result, &quot;red&quot;);
+    def-&gt;contact = dbi_result_get_uint(result, &quot;contact&quot;);
+    strcpy(def-&gt;hide, dbi_result_get_string(result, &quot;hide&quot;));
+    strcpy(def-&gt;email, dbi_result_get_string(result, &quot;email&quot;));
+    def-&gt;delay = dbi_result_get_uint(result, &quot;delay&quot;);
+    dbi_result_free(result);
+
+    result = db_query(t-&gt;probe-&gt;db, 0, 
                       &quot;select color &quot;
                       &quot;from   pr_status &quot;
                       &quot;where  class = '%u' and probe = '%u'&quot;, t-&gt;probe-&gt;class, def-&gt;probeid);
     if (result) {
-      row = mysql_fetch_row(result);
-      if (row) {
-        if (row[0]) def-&gt;color   = atoi(row[0]);
-      } else {
+      if (dbi_result_get_numrows(result) == 0) {
         LOG(LOG_NOTICE, &quot;%s:%u@%s: pr_status record for %s id %u not found&quot;, 
            res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, def-&gt;probeid);
+      } else {
+        dbi_result_next_row(result);
+        def-&gt;color   = dbi_result_get_uint(result, &quot;color&quot;);
+        dbi_result_free(result);
       }
-      mysql_free_result(result);
     }
     if (!def-&gt;color) def-&gt;color = res-&gt;color;
 
-    result = my_query(t-&gt;probe-&gt;db, 0, 
+    result = db_query(t-&gt;probe-&gt;db, 0, 
                       &quot;select stattime from pr_%s_raw use index(probstat) &quot;
                       &quot;where probe = '%u' order by stattime desc limit 1&quot;,
                        res-&gt;name, def-&gt;probeid);
     if (result) {
-      row = mysql_fetch_row(result);
-      if (row &amp;&amp; mysql_num_rows(result) &gt; 0) {
-        if (row[0]) def-&gt;newest = atoi(row[0]);
+      if (dbi_result_get_numrows(result) &gt; 0) {
+        dbi_result_next_row(result);
+        def-&gt;newest  = dbi_result_get_uint(result, &quot;stattime&quot;);
+        dbi_result_free(result);
       }
-      mysql_free_result(result);
     }
     g_hash_table_insert(t-&gt;probe-&gt;cache, guintdup(def-&gt;server), def);
   }

Modified: upwatch/libdbi/upwatch/pr_hwstat.c
===================================================================
--- upwatch/libdbi/upwatch/pr_hwstat.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/upwatch/pr_hwstat.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -79,26 +79,24 @@
 { 
   struct hwstat_def *def;
   struct hwstat_result *res = (struct hwstat_result *)t-&gt;res;
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   time_t now = time(NULL);
 
   if (res-&gt;color == STAT_PURPLE) { // generated by uw_purple, which knows the probe id but not the serverid
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                       &quot;select server from pr_%s_def where id = '%u'&quot;, res-&gt;name, res-&gt;probeid);
     if (!result) return(NULL);
 
-    row = mysql_fetch_row(result);
-    if (row &amp;&amp; row[0]) {
-      res-&gt;server = atoi(row[0]);
-    } else {
+    if (dbi_result_get_numrows(result) == 0) {
       LOG(LOG_NOTICE, &quot;%s:%u@%s: %s def %u not found&quot;, 
           res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, res-&gt;probeid);
-      mysql_free_result(result);
+      dbi_result_free(result);
       delete_pr_status(t, res-&gt;probeid);
       return(NULL);
     }
-    mysql_free_result(result);
+    dbi_result_next_row(result);
+    res-&gt;server = dbi_result_get_uint_idx(result, 0);
+    dbi_result_free(result);
   }
 
   def = g_hash_table_lookup(t-&gt;probe-&gt;cache, &amp;res-&gt;server);
@@ -113,7 +111,7 @@
     strcpy(def-&gt;hide, &quot;no&quot;);
     def-&gt;server = res-&gt;server;
 
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                       &quot;select id, contact, hide, email, delay, &quot;
                       &quot;       temp1_yellow, temp1_red, temp2_yellow, temp2_red, &quot;
                       &quot;       temp3_yellow, temp3_red, rot1_red, rot2_red, rot3_red, pgroup &quot;
@@ -121,24 +119,26 @@
                       &quot;where  server = '%u'&quot;, res-&gt;name, res-&gt;server);
     if (!result) return(NULL);
 
-    if (mysql_num_rows(result) == 0) { // DEF RECORD NOT FOUND
-      mysql_free_result(result);
+    if (dbi_result_get_numrows(result) == 0) { // DEF RECORD NOT FOUND
+      dbi_result_free(result);
       if (!create) {
         LOG(LOG_NOTICE, &quot;%s:%u@%s: pr_%s_def for server %u not found and not trusted - skipped&quot;, 
                          res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, def-&gt;server);
         return(NULL);
       }
-      result = my_query(t-&gt;probe-&gt;db, 0,
+      result = db_query(t-&gt;probe-&gt;db, 0,
                         &quot;insert into pr_%s_def set server = '%d', &quot;
                         &quot;        ipaddress = '%s', description = '%s'&quot;, 
                         res-&gt;name, res-&gt;server, t-&gt;res-&gt;ipaddress ? t-&gt;res-&gt;ipaddress : &quot;127.0.0.1&quot;, 
                         t-&gt;fromhost ? t-&gt;fromhost : &quot;automatically added&quot;);
-      mysql_free_result(result);
-      if (mysql_affected_rows(t-&gt;probe-&gt;db) == 0) { // nothing was actually inserted
+      dbi_result_free(result);
+      if (dbi_result_get_numrows_affected(t-&gt;probe-&gt;db) == 0) { // nothing was actually inserted
+        const char *errmsg;
+        dbi_conn_error(t-&gt;probe-&gt;db, &amp;errmsg);
         LOG(LOG_NOTICE, &quot;insert missing pr_%s_def id %u: %s&quot;, 
-                         res-&gt;name, def-&gt;probeid, mysql_error(t-&gt;probe-&gt;db));
+                         res-&gt;name, def-&gt;probeid, errmsg);
       }
-      result = my_query(t-&gt;probe-&gt;db, 0,
+      result = db_query(t-&gt;probe-&gt;db, 0,
                         &quot;select id, contact, hide, email, delay, &quot;
                         &quot;       temp1_yellow, temp1_red, temp2_yellow, temp2_red, &quot;
                         &quot;       temp3_yellow, temp3_red, rot1_red, rot2_red, rot3_red, pgroup &quot;
@@ -146,55 +146,57 @@
                         &quot;where  server = '%u'&quot;, res-&gt;name, res-&gt;server);
       if (!result) return(NULL);
     }
-    row = mysql_fetch_row(result); 
-    if (!row || !row[0]) {
+    if (dbi_result_get_numrows(result) == 0) {
       LOG(LOG_NOTICE, &quot;%s:%u@%s: no pr_%s_def found for server %u - skipped&quot;, 
           res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, res-&gt;server);
-      mysql_free_result(result);
+      dbi_result_free(result);
       return(NULL);
     }
-    if (row[0]) def-&gt;probeid  = atoi(row[0]);
-    if (row[1]) def-&gt;contact  = atoi(row[1]);
-    strcpy(def-&gt;hide, row[2] ? row[2] : &quot;no&quot;);
-    strcpy(def-&gt;email, row[3] ? row[3] : &quot;&quot;);
-    if (row[4]) def-&gt;delay = atoi(row[4]);
-    if (row[5]) def-&gt;temp1_yellow = atoi(row[5]);
-    if (row[6]) def-&gt;temp1_red = atoi(row[6]);
-    if (row[7]) def-&gt;temp2_yellow = atoi(row[7]);
-    if (row[8]) def-&gt;temp2_red = atoi(row[8]);
-    if (row[9]) def-&gt;temp3_yellow = atoi(row[9]);
-    if (row[10]) def-&gt;temp3_red = atoi(row[10]);
-    if (row[11]) def-&gt;rot1_red = atoi(row[11]);
-    if (row[12]) def-&gt;rot2_red = atoi(row[12]);
-    if (row[13]) def-&gt;rot3_red = atoi(row[13]);
-    if (row[14]) def-&gt;pgroup = atoi(row[14]);
+    dbi_result_next_row(result);
 
-    mysql_free_result(result);
+    def-&gt;probeid = dbi_result_get_uint(result, &quot;id&quot;);
+    def-&gt;contact = dbi_result_get_uint(result, &quot;contact&quot;);
+    strcpy(def-&gt;hide, dbi_result_get_string(result, &quot;hide&quot;));
+    strcpy(def-&gt;email, dbi_result_get_string(result, &quot;email&quot;));
+    def-&gt;delay = dbi_result_get_uint(result, &quot;delay&quot;);
+    def-&gt;temp1_yellow = dbi_result_get_uint(result, &quot;temp1_yellow&quot;);
+    def-&gt;temp1_red = dbi_result_get_uint(result, &quot;temp1_red&quot;);
+    def-&gt;temp2_yellow = dbi_result_get_uint(result, &quot;temp2_yellow&quot;);
+    def-&gt;temp2_red = dbi_result_get_uint(result, &quot;temp2_red&quot;);
+    def-&gt;temp3_yellow = dbi_result_get_uint(result, &quot;temp3_yellow&quot;);
+    def-&gt;temp3_red = dbi_result_get_uint(result, &quot;temp3_red&quot;);
+    def-&gt;rot1_red = dbi_result_get_uint(result, &quot;rot1_red&quot;);
+    def-&gt;rot2_red = dbi_result_get_uint(result, &quot;rot2_red&quot;);
+    def-&gt;rot3_red = dbi_result_get_uint(result, &quot;rot3_red&quot;);
+    def-&gt;pgroup = dbi_result_get_uint(result, &quot;pgroup&quot;);
+    dbi_result_free(result);
 
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                       &quot;select color &quot;
                       &quot;from   pr_status &quot;
                       &quot;where  class = '%d' and probe = '%d'&quot;, t-&gt;probe-&gt;class, def-&gt;probeid);
     if (result) {
-      row = mysql_fetch_row(result);
-      if (row) {
-        def-&gt;color   = atoi(row[0]); 
+      if (dbi_result_get_numrows(result) == 0) {
+        LOG(LOG_NOTICE, &quot;%s:%u@%s: pr_status record for %s id %u not found&quot;,
+           res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, def-&gt;probeid);
+      } else {
+        dbi_result_next_row(result);
+        def-&gt;color   = dbi_result_get_uint(result, &quot;color&quot;);
+        dbi_result_free(result);
       }
-      mysql_free_result(result);
-    } 
+    }
+    if (!def-&gt;color) def-&gt;color = res-&gt;color;
 
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                       &quot;select stattime from pr_%s_raw use index(probstat) &quot;
                       &quot;where probe = '%u' order by stattime desc limit 1&quot;,
                        res-&gt;name, def-&gt;probeid);
     if (result) {
-      if (mysql_num_rows(result) &gt; 0) {
-        row = mysql_fetch_row(result);
-        if (row &amp;&amp; row[0]) {
-          def-&gt;newest = atoi(row[0]);
-        }
+      if (dbi_result_get_numrows(result) &gt; 0) {
+        dbi_result_next_row(result);
+        def-&gt;newest  = dbi_result_get_uint(result, &quot;stattime&quot;);
+        dbi_result_free(result);
       }
-      mysql_free_result(result);
     }
 
     g_hash_table_insert(t-&gt;probe-&gt;cache, guintdup(res-&gt;server), def);

Modified: upwatch/libdbi/upwatch/pr_iptraf.c
===================================================================
--- upwatch/libdbi/upwatch/pr_iptraf.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/upwatch/pr_iptraf.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -13,7 +13,7 @@
 #include &quot;dmalloc.h&quot;
 #endif
 
-char *query_server_by_ip;
+const char *query_server_by_ip;
 
 //*******************************************************************
 // GET THE INFO FROM THE XML FILE
@@ -64,27 +64,26 @@
 {
   struct iptraf_def *def;
   struct iptraf_result *res = (struct iptraf_result *)t-&gt;res;
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   char buffer[10];
   time_t now = time(NULL);
 
   if (res-&gt;color == STAT_PURPLE) {
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                       &quot;select ipaddress from pr_%s_def where id = '%u'&quot;, res-&gt;name, res-&gt;probeid);
     if (!result) return(NULL);
 
-    row = mysql_fetch_row(result);
-    if (row &amp;&amp; row[0]) {
-      res-&gt;ipaddress = strdup(row[0]);
-      inet_aton(res-&gt;ipaddress, &amp;res-&gt;ipaddr);
-    } else {
+    if (dbi_result_get_numrows(result) == 0) {
       LOG(LOG_NOTICE, &quot;%s:%u@%s: iptraf def %u not found&quot;, res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;probeid);
-      mysql_free_result(result);
+      dbi_result_free(result);
       delete_pr_status(t, res-&gt;probeid);
       return(NULL);
     }
-    mysql_free_result(result);
+
+    dbi_result_next_row(result);
+    strcpy(res-&gt;ipaddress, dbi_result_get_string(result, &quot;ipaddress&quot;));
+    inet_aton(res-&gt;ipaddress, &amp;res-&gt;ipaddr);
+    dbi_result_free(result);
   }
 
   def = g_hash_table_lookup(t-&gt;probe-&gt;cache, &amp;res-&gt;ipaddr);
@@ -99,14 +98,14 @@
     def-&gt;stamp = now;
     strcpy(def-&gt;hide, &quot;no&quot;);
 
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                       &quot;select id, server, yellow, red, contact, hide, email, delay, pgroup &quot;
                       &quot;from   pr_%s_def &quot;
                       &quot;where  ipaddress = '%s'&quot;, res-&gt;name, res-&gt;ipaddress);
     if (!result) return(NULL);
 
-    if (mysql_num_rows(result) == 0) { // DEF RECORD NOT FOUND
-      mysql_free_result(result);
+    if (dbi_result_get_numrows(result) == 0) { // DEF RECORD NOT FOUND
+      dbi_result_free(result);
       if (!create) {
         LOG(LOG_NOTICE, &quot;%s:%u@%s: pr_%s_def ip %s not found - skipped&quot;,
                          res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, res-&gt;ipaddress);
@@ -118,112 +117,113 @@
         LOG(LOG_ERR, &quot;No SQL query for how to find a server by ip address&quot;);
         return(NULL);
       }
-      result = my_query(t-&gt;probe-&gt;db, 0, query_server_by_ip, res-&gt;ipaddress, res-&gt;ipaddress,
+      result = db_query(t-&gt;probe-&gt;db, 0, query_server_by_ip, res-&gt;ipaddress, res-&gt;ipaddress,
                         res-&gt;ipaddress, res-&gt;ipaddress, res-&gt;ipaddress);
       if (!result) return(NULL);
-      row = mysql_fetch_row(result);
-      if (row &amp;&amp; row[0]) {
-        res-&gt;server   = atoi(row[0]);
-      } else {
+
+      if (dbi_result_get_numrows(result) == 0) {
         LOG(LOG_NOTICE, &quot;%s:%u@%s: iptraf for ip %s added without server id&quot;, 
             res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;ipaddress);
         res-&gt;server = 1;
+      } else {
+        dbi_result_next_row(result);
+        res-&gt;server = dbi_result_get_uint_idx(result, 0);
+        dbi_result_free(result);
       }
-      mysql_free_result(result);
 
-      result = my_query(t-&gt;probe-&gt;db, 0,
+      result = db_query(t-&gt;probe-&gt;db, 0,
                         &quot;insert into pr_%s_def set ipaddress = '%s', server = '%u', &quot;
                         &quot;        description = 'auto-added by system'&quot;,
                         res-&gt;name, res-&gt;ipaddress, res-&gt;server);
-      mysql_free_result(result);
-      if (mysql_affected_rows(t-&gt;probe-&gt;db) == 0) { // nothing was actually inserted
+      dbi_result_free(result);
+      if (dbi_result_get_numrows_affected(t-&gt;probe-&gt;db) == 0) { // nothing was actually inserted
+        const char *errmsg;
+        dbi_conn_error(t-&gt;probe-&gt;db, &amp;errmsg);
         LOG(LOG_NOTICE, &quot;%s:%u@%s: insert missing pr_%s_def id %s: %s&quot;, 
                          res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, 
-                         res-&gt;name, res-&gt;ipaddress, mysql_error(t-&gt;probe-&gt;db));
+                         res-&gt;name, res-&gt;ipaddress, errmsg);
       } else {
         LOG(LOG_NOTICE, &quot;%s:%u@%s: created pr_%s_def for ipaddress %s&quot;, 
                          res-&gt;realm, res-&gt;stattime, t-&gt;fromhost,
                          res-&gt;name, res-&gt;ipaddress);
       }
-      result = my_query(t-&gt;probe-&gt;db, 0,
+      result = db_query(t-&gt;probe-&gt;db, 0,
                         &quot;select id, server, yellow, red, contact, hide, email, delay, pgroup &quot;
                         &quot;from   pr_%s_def &quot;
                         &quot;where  ipaddress = '%s'&quot;, res-&gt;name, res-&gt;ipaddress);
       if (!result) return(NULL);
     }
   
-    row = mysql_fetch_row(result);
-    if (!row) {
-      mysql_free_result(result);
+    if (dbi_result_get_numrows(result) == 0) {
+      dbi_result_free(result);
       return(NULL);
     }
-    def-&gt;probeid  = atoi(row[0]);
-    def-&gt;server   = atoi(row[1]);
-    def-&gt;yellow   = atof(row[2]);
-    def-&gt;red      = atof(row[3]);
-    def-&gt;contact  = atof(row[4]);
-    strcpy(def-&gt;hide, row[5] ? row[5] : &quot;no&quot;);
-    strcpy(def-&gt;email, row[6] ? row[6] : &quot;&quot;);
-    if (row[7]) def-&gt;delay = atoi(row[7]);
-    if (row[8]) def-&gt;pgroup = atoi(row[8]);
+    dbi_result_next_row(result);
 
-    mysql_free_result(result);
+    def-&gt;probeid = dbi_result_get_uint(result, &quot;id&quot;);
+    def-&gt;server = dbi_result_get_float(result, &quot;server&quot;);
+    def-&gt;yellow = dbi_result_get_float(result, &quot;yellow&quot;);
+    def-&gt;red = dbi_result_get_float(result, &quot;red&quot;);
+    def-&gt;contact = dbi_result_get_uint(result, &quot;contact&quot;);
+    strcpy(def-&gt;hide, dbi_result_get_string(result, &quot;hide&quot;));
+    strcpy(def-&gt;email, dbi_result_get_string(result, &quot;email&quot;));
+    def-&gt;delay = dbi_result_get_uint(result, &quot;delay&quot;);
+    def-&gt;pgroup = dbi_result_get_uint(result, &quot;pgroup&quot;);
+    dbi_result_free(result);
 
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                       &quot;select color &quot;
                       &quot;from   pr_status &quot;
                       &quot;where  class = '%d' and probe = '%d'&quot;, t-&gt;probe-&gt;class, def-&gt;probeid);
     if (result) {
-      row = mysql_fetch_row(result);
-      if (row) {
-        def-&gt;color   = atoi(row[0]);
-      } else {
+      if (dbi_result_get_numrows(result) == 0) {
         LOG(LOG_NOTICE, &quot;%s:%u@%s: pr_status record for %s id %u (%s) not found&quot;, 
             res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, def-&gt;probeid, res-&gt;ipaddress);
-        mysql_free_result(result);
-        result = my_query(t-&gt;probe-&gt;db, 0,
+        dbi_result_free(result);
+        result = db_query(t-&gt;probe-&gt;db, 0,
                           &quot;insert into pr_status set class = '%d', probe = '%d', server = '%d'&quot;,
                           t-&gt;probe-&gt;class, def-&gt;probeid, def-&gt;server);
+      } else {
+        dbi_result_next_row(result);
+        def-&gt;color   = dbi_result_get_uint(result, &quot;color&quot;);
       }
-      mysql_free_result(result);
-    } else {
-      LOG(LOG_NOTICE, &quot;%s:%u@%s: pr_status record for %s id %u (%s) not found&quot;, 
-          res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, def-&gt;probeid, res-&gt;ipaddress);
+      dbi_result_free(result);
     }
+    if (!def-&gt;color) def-&gt;color = res-&gt;color;
 
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                       &quot;select stattime from pr_%s_raw use index(probstat) &quot;
                       &quot;where probe = '%u' order by stattime desc limit 1&quot;,
                        res-&gt;name, def-&gt;probeid);
     if (result) {
-      if (mysql_num_rows(result) &gt; 0) {
-        row = mysql_fetch_row(result);
-        if (row &amp;&amp; row[0]) {
-          def-&gt;newest = atoi(row[0]);
-        }
+      if (dbi_result_get_numrows(result) &gt; 0) {
+        dbi_result_next_row(result);
+        def-&gt;newest  = dbi_result_get_uint(result, &quot;stattime&quot;);
+        dbi_result_free(result);
       }
-      mysql_free_result(result);
     }
 
     uw_slot(SLOT_DAY, res-&gt;stattime, &amp;slotlow, &amp;slothigh);
-    result = my_query(t-&gt;probe-&gt;db, 0,
-                      &quot;select sum(incoming), sum(outgoing), max(color), avg(yellow), avg(red) &quot;
+    result = db_query(t-&gt;probe-&gt;db, 0,
+                      &quot;select sum(incoming) as slotday_in, sum(outgoing) as slotday_out, &quot;
+                      &quot;       max(color) as slotday_max_color, avg(yellow) as slotday_avg_yellow, &quot;
+                      &quot;       avg(red) as slotday_avg_red &quot;
                       &quot;from   pr_iptraf_raw use index(probstat) &quot;
                       &quot;where  probe = '%u' and stattime &gt;= '%u' and stattime &lt; '%u'&quot;,
                       def-&gt;probeid, slotlow, slothigh);
     if (result) {
-      row = mysql_fetch_row(result);
-      if (row) {
-        if (row[0]) def-&gt;slotday_in   = atoi(row[0]);
-        if (row[1]) def-&gt;slotday_out  = atoi(row[1]);
-        if (row[2]) def-&gt;slotday_max_color  = atoi(row[2]);
-        if (row[3]) def-&gt;slotday_avg_yellow = atof(row[3]);
-        if (row[4]) def-&gt;slotday_avg_red    = atof(row[4]);
+      if (dbi_result_get_numrows(result) &gt; 0) {
+        dbi_result_next_row(result);
+        def-&gt;slotday_in  = dbi_result_get_uint(result, &quot;slotday_in&quot;);
+        def-&gt;slotday_out = dbi_result_get_uint(result, &quot;slotday_out&quot;);
+        def-&gt;slotday_max_color = dbi_result_get_uint(result, &quot;slotday_max_color&quot;);
+        def-&gt;slotday_avg_yellow = dbi_result_get_uint(result, &quot;slotday_avg_yellow&quot;);
+        def-&gt;slotday_avg_red = dbi_result_get_uint(result, &quot;slotday_avg_red&quot;);
+        dbi_result_free(result);
+      } else {
+        LOG(LOG_NOTICE, &quot;%s:%u@%s: raw record for %s id %u not found between %u and %u&quot;, 
+                        res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, def-&gt;probeid, slotlow, slothigh);
       }
-      mysql_free_result(result);
-    } else {
-      LOG(LOG_NOTICE, &quot;%s:%u@%s: raw record for %s id %u not found between %u and %u&quot;, 
-                      res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, def-&gt;probeid, slotlow, slothigh);
     }
     if (def-&gt;slotday_avg_yellow == 0) {
       def-&gt;slotday_avg_yellow = def-&gt;yellow;

Modified: upwatch/libdbi/upwatch/pr_process.c
===================================================================
--- upwatch/libdbi/upwatch/pr_process.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/upwatch/pr_process.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -29,7 +29,7 @@
 // GET THE INFO FROM THE XML FILE
 // Caller must free the pointer it returns
 //******************************************************************* 
-int set_result_value(trx *t, char *name, char *value)
+int set_result_value(trx *t, char *name, unsigned char *value)
 {
   xmlNodePtr cur = t-&gt;cur;
   int found = FALSE;
@@ -89,7 +89,7 @@
   }
 
   for (t-&gt;cur = t-&gt;cur-&gt;xmlChildrenNode; t-&gt;cur != NULL; t-&gt;cur = t-&gt;cur-&gt;next) {
-    char *p;
+    unsigned char *p;
 
     if (xmlIsBlankNode(t-&gt;cur)) continue;
     if ((!xmlStrcmp(t-&gt;cur-&gt;name, (const xmlChar *) &quot;color&quot;)) &amp;&amp; (xmlNsEqual(t-&gt;cur-&gt;ns, t-&gt;ns))) {
@@ -159,26 +159,25 @@
 
 void delete_pr_status(trx *t, int id)
 {
-  MYSQL_RES *result;
+  dbi_conn result;
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
            &quot;delete from pr_status where class = '%u' and probe = '%u'&quot;,
            t-&gt;probe-&gt;class, id);
-  mysql_free_result(result);
+  dbi_result_free(result);
 }
 
 //*******************************************************************
 // retrieve the definitions + status
 // get it from the cache. if there but too old: delete
-// in case of mysql-has-gone-away type errors, we keep on running, 
+// in case of server-has-gone-away type errors, we keep on running, 
 // it will be caught later-on.
 //*******************************************************************
 void *get_def(trx *t, int create)
 {
   struct probe_result *res = (struct probe_result *)t-&gt;res;
   struct probe_def *def;
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   time_t now = time(NULL);
   char *def_fields = &quot;ipaddress, description, server, yellow, red, contact, hide, email, delay, pgroup&quot;;
 
@@ -193,30 +192,30 @@
     def-&gt;stamp    = time(NULL);
     strcpy(def-&gt;hide, &quot;no&quot;);
 
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                       &quot;select color &quot;
                       &quot;from   pr_status &quot;
                       &quot;where  class = '%u' and probe = '%u'&quot;, t-&gt;probe-&gt;class, res-&gt;probeid);
     if (result) {
-      row = mysql_fetch_row(result);
-      if (row) {
-        if (row[0]) def-&gt;color   = atoi(row[0]);
-      } else {
+      if (dbi_result_get_numrows(result) == 0) {
         LOG(LOG_NOTICE, &quot;%s:%u@%s: pr_status record for %s id %u ip %s not found&quot;, 
             res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, res-&gt;probeid, res-&gt;ipaddress);
+      } else {
+        dbi_result_next_row(result);
+        def-&gt;color = dbi_result_get_uint(result, &quot;color&quot;);
       }
-      mysql_free_result(result);
+      dbi_result_free(result);
     }
 
     // Get the server, contact and yellow/red info from the def record. Note the yellow/red may 
     // have been changed by the user so need to be transported into the data files
-    result = my_query(t-&gt;probe-&gt;db, 0, &quot;select %s from pr_%s_def where  id = '%u'&quot;, 
+    result = db_query(t-&gt;probe-&gt;db, 0, &quot;select %s from pr_%s_def where  id = '%u'&quot;, 
                       t-&gt;probe-&gt;get_def_fields ? t-&gt;probe-&gt;get_def_fields : def_fields,
                       res-&gt;name, res-&gt;probeid);
     if (!result) return(NULL);
 
-    if (mysql_num_rows(result) == 0) { // DEF RECORD NOT FOUND
-      mysql_free_result(result);
+    if (dbi_result_get_numrows(result) == 0) { // DEF RECORD NOT FOUND
+      dbi_result_free(result);
       if (!create) {
         LOG(LOG_NOTICE, &quot;%s:%u@%s: pr_%s_def id %u not found - skipped&quot;,
                          res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, res-&gt;probeid);
@@ -233,19 +232,21 @@
       // for it. We apparantly trust this result, so we can create the definition
       // ourselves. For that we need to fill in the server id and the ipaddress
       // and we look into the result if the is anything useful in there.
-      result = my_query(t-&gt;probe-&gt;db, 0,
+      result = db_query(t-&gt;probe-&gt;db, 0,
                         &quot;insert into pr_%s_def set server = '%d', &quot;
                         &quot;        ipaddress = '%s', description = '%s'&quot;,
                         res-&gt;name, res-&gt;server, res-&gt;ipaddress?res-&gt;ipaddress:&quot;&quot;,
                         t-&gt;fromhost ? t-&gt;fromhost : &quot;automatically added&quot;);
-      mysql_free_result(result);
-      res-&gt;probeid = mysql_insert_id(t-&gt;probe-&gt;db);
-      if (mysql_affected_rows(t-&gt;probe-&gt;db) == 0) { // nothing was actually inserted
+      dbi_result_free(result);
+      res-&gt;probeid = dbi_conn_sequence_last(t-&gt;probe-&gt;db, NULL);
+      if (dbi_result_get_numrows_affected(t-&gt;probe-&gt;db) == 0) { // nothing was actually inserted
+        const char *errmsg;
+        dbi_conn_error(t-&gt;probe-&gt;db, &amp;errmsg);
         LOG(LOG_NOTICE, &quot;%s:%u@%s: insert missing pr_%s_def id %u: %s&quot;, 
                          res-&gt;realm, res-&gt;stattime, t-&gt;fromhost,
-                         res-&gt;name, res-&gt;probeid, mysql_error(t-&gt;probe-&gt;db));
+                         res-&gt;name, res-&gt;probeid, errmsg);
       }
-      result = my_query(t-&gt;probe-&gt;db, 0, &quot;select %s from pr_%s_def where  id = '%u'&quot;, 
+      result = db_query(t-&gt;probe-&gt;db, 0, &quot;select %s from pr_%s_def where  id = '%u'&quot;, 
                         t-&gt;probe-&gt;get_def_fields ? t-&gt;probe-&gt;get_def_fields : def_fields,
                         res-&gt;name, res-&gt;probeid);
       if (!result) return(NULL);
@@ -253,34 +254,30 @@
     if (t-&gt;probe-&gt;set_def_fields) {
       t-&gt;probe-&gt;set_def_fields(t, def, result);
     } else {
-      row = mysql_fetch_row(result);
-      if (row) {
-        if (row[0]) def-&gt;ipaddress   = strdup(row[0]);
-        if (row[1]) def-&gt;description = strdup(row[1]);
-        if (row[2]) def-&gt;server    = atoi(row[2]);
-        if (row[3]) def-&gt;yellow    = atof(row[3]);
-        if (row[4]) def-&gt;red       = atof(row[4]);
-        if (row[5]) def-&gt;contact   = atof(row[5]);
-        strcpy(def-&gt;hide, row[6] ? row[6] : &quot;no&quot;);
-        strcpy(def-&gt;email, row[7] ? row[7] : &quot;&quot;);
-        if (row[8]) def-&gt;delay = atoi(row[8]);
-        if (row[9]) def-&gt;pgroup = atoi(row[9]);
-      }
+      dbi_result_next_row(result);
+      def-&gt;ipaddress   = dbi_result_get_string_copy(result, &quot;ipaddress&quot;);
+      def-&gt;description = dbi_result_get_string_copy(result, &quot;description&quot;);
+      def-&gt;server      = dbi_result_get_uint(result, &quot;server&quot;);
+      def-&gt;yellow      = dbi_result_get_float(result, &quot;yellow&quot;);
+      def-&gt;red         = dbi_result_get_float(result, &quot;yellow&quot;);
+      def-&gt;contact     = dbi_result_get_uint(result, &quot;contact&quot;);
+      strcpy(def-&gt;hide, dbi_result_get_string(result, &quot;hide&quot;));
+      strcpy(def-&gt;email, dbi_result_get_string_copy(result, &quot;email&quot;));
+      def-&gt;delay       = dbi_result_get_uint(result, &quot;delay&quot;);
+      def-&gt;pgroup      = dbi_result_get_uint(result, &quot;pgroup&quot;);
     }
-    mysql_free_result(result);
+    dbi_result_free(result);
 
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                       &quot;select stattime from pr_%s_raw use index(probstat) &quot;
                       &quot;where probe = '%u' order by stattime desc limit 1&quot;,
                        res-&gt;name, res-&gt;probeid);
     if (result) {
-      if (mysql_num_rows(result) &gt; 0) {
-        row = mysql_fetch_row(result);
-        if (row &amp;&amp; row[0]) {
-          def-&gt;newest = atoi(row[0]);
-        }
+      if (dbi_result_get_numrows(result) &gt; 0) {
+        dbi_result_next_row(result);
+        def-&gt;newest = dbi_result_get_uint(result, &quot;stattime&quot;);
       }
-      mysql_free_result(result);
+      dbi_result_free(result);
     }
 
     def-&gt;probeid = res-&gt;probeid;
@@ -302,8 +299,7 @@
 {
   struct probe_def *def;
   struct probe_result *res = (struct probe_result *)t-&gt;res;
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
 
   def = g_malloc0(t-&gt;probe-&gt;def_size);
   def-&gt;stamp    = time(NULL);
@@ -311,60 +307,60 @@
   strcpy(def-&gt;hide, &quot;no&quot;);
 
   // first find the definition based on the serverid
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;select id, contact, hide, email, delay from pr_%s_def &quot;
                     &quot;where  server = '%u'&quot;, res-&gt;name, res-&gt;server);
   if (!result) {
     g_free(def);
     return(NULL);
   }
-  if (mysql_num_rows(result) == 0) { // DEF RECORD NOT FOUND
-    mysql_free_result(result);
-    result = my_query(t-&gt;probe-&gt;db, 0,
+  if (dbi_result_get_numrows(result) == 0) { // DEF RECORD NOT FOUND
+    dbi_result_free(result);
+    result = db_query(t-&gt;probe-&gt;db, 0,
                       &quot;insert into pr_%s_def set server = '%u', ipaddress = '%s', &quot; 
                       &quot;       description = '%s'&quot;, 
                        res-&gt;name, res-&gt;server, res-&gt;ipaddress ? res-&gt;ipaddress : &quot;&quot;, 
                        res-&gt;hostname);
-    mysql_free_result(result);
-    def-&gt;probeid = mysql_insert_id(t-&gt;probe-&gt;db);
+    dbi_result_free(result);
+    def-&gt;probeid = dbi_conn_sequence_last(t-&gt;probe-&gt;db, NULL);
     LOG(LOG_NOTICE, &quot;%s:%u@%s: pr_%s_def created for %s, id = %u&quot;, 
         res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, res-&gt;hostname, def-&gt;probeid);
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;select id, contact, hide, email, delay from pr_%s_def &quot;
                     &quot;where  server = '%u'&quot;, res-&gt;server, res-&gt;name);
     if (!result) return(NULL);
   }
-  row = mysql_fetch_row(result);
-  if (!row || !row[0]) {
+  if (dbi_result_get_numrows(result) == 0) {
     LOG(LOG_NOTICE, &quot;%s:%u@%s: no pr_%s_def found for server %u - skipped&quot;, 
         res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, res-&gt;server);
-    mysql_free_result(result);
+    dbi_result_free(result);
     return(NULL);
   }
 
-  if (row[0])  def-&gt;probeid = atoi(row[0]);
-  if (row[1])  def-&gt;contact = atoi(row[1]);
-  strcpy(def-&gt;hide, row[2] ? row[2] : &quot;no&quot;);
-  strcpy(def-&gt;email, row[3] ? row[3] : &quot;&quot;);
-  if (row[4]) def-&gt;delay = atoi(row[4]);
+  dbi_result_next_row(result);
+  def-&gt;probeid = dbi_result_get_uint(result, &quot;id&quot;);
+  def-&gt;contact = dbi_result_get_uint(result, &quot;contact&quot;);
+  strcpy(def-&gt;hide, dbi_result_get_string(result, &quot;hide&quot;));
+  strcpy(def-&gt;email, dbi_result_get_string_copy(result, &quot;email&quot;));
+  def-&gt;delay       = dbi_result_get_uint(result, &quot;delay&quot;);
 
-  mysql_free_result(result);
+  dbi_result_free(result);
 
   // definition found, get the pr_status
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;select color, stattime &quot;
                     &quot;from   pr_status &quot;
                     &quot;where  class = '%u' and probe = '%u'&quot;, t-&gt;probe-&gt;class, def-&gt;probeid);
   if (result) {
-    row = mysql_fetch_row(result);
-    if (row) {
-      if (row[0]) def-&gt;color   = atoi(row[0]);
-      if (row[1]) def-&gt;newest  = atoi(row[1]);
-    } else {
+    if (dbi_result_get_numrows(result) == 0) {
       LOG(LOG_NOTICE, &quot;%s:%u@%s: pr_status record for %s id %u (server %s) not found&quot;, 
                        res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, def-&gt;probeid, res-&gt;hostname);
+    } else {
+      dbi_result_next_row(result);
+      def-&gt;color = dbi_result_get_uint(result, &quot;color&quot;);
+      def-&gt;newest = dbi_result_get_uint(result, &quot;stattime&quot;);
     }
-    mysql_free_result(result);
+    dbi_result_free(result);
   }
   if (!def-&gt;color) def-&gt;color = res-&gt;color;
 

Modified: upwatch/libdbi/upwatch/pr_sysstat.c
===================================================================
--- upwatch/libdbi/upwatch/pr_sysstat.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/upwatch/pr_sysstat.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -83,26 +83,24 @@
 { 
   struct probe_def *def;
   struct sysstat_result *res = (struct sysstat_result *)t-&gt;res;
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   time_t now = time(NULL);
 
   if (res-&gt;color == STAT_PURPLE) { // generated by uw_purple, which knows the probe id but not the serverid
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                       &quot;select server from pr_%s_def where id = '%u'&quot;, res-&gt;name, res-&gt;probeid);
     if (!result) return(NULL);
 
-    row = mysql_fetch_row(result);
-    if (row &amp;&amp; row[0]) {
-      res-&gt;server = atoi(row[0]);
-    } else {
+    if (dbi_result_get_numrows(result) == 0) {
       LOG(LOG_NOTICE, &quot;%s:%u@%s: %s def %u not found&quot;, 
           res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, res-&gt;probeid);
-      mysql_free_result(result);
+      dbi_result_free(result);
       delete_pr_status(t, res-&gt;probeid);
       return(NULL);
     }
-    mysql_free_result(result);
+    dbi_result_next_row(result);
+    res-&gt;server = dbi_result_get_uint(result, &quot;server&quot;);
+    dbi_result_free(result);
   }
 
   def = g_hash_table_lookup(t-&gt;probe-&gt;cache, &amp;res-&gt;server);
@@ -117,78 +115,83 @@
     strcpy(def-&gt;hide, &quot;no&quot;);
     def-&gt;server = res-&gt;server;
     
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                       &quot;select id, yellow, red, contact, hide, email, delay, pgroup &quot;
                       &quot;from   pr_%s_def &quot;
                       &quot;where  server = '%u'&quot;, res-&gt;name, res-&gt;server);
     if (!result) return(NULL);
 
-    if (mysql_num_rows(result) == 0) { // DEF RECORD NOT FOUND
-      mysql_free_result(result);
+    if (dbi_result_get_numrows(result) == 0) { // DEF RECORD NOT FOUND
+      dbi_result_free(result);
       if (!create) {
         LOG(LOG_NOTICE, &quot;%s:%u@%s: pr_%s_def for server %u not found and not trusted - skipped&quot;, 
                          res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, def-&gt;server);
         return(NULL);
       }
-      result = my_query(t-&gt;probe-&gt;db, 0,
+      result = db_query(t-&gt;probe-&gt;db, 0,
                         &quot;insert into pr_%s_def set server = '%d', &quot;
                         &quot;        ipaddress = '%s', description = '%s'&quot;, 
                         res-&gt;name, res-&gt;server, t-&gt;res-&gt;ipaddress ? t-&gt;res-&gt;ipaddress : &quot;127.0.0.1&quot;, 
                         t-&gt;fromhost ? t-&gt;fromhost : &quot;automatically added&quot;);
-      mysql_free_result(result);
-      if (mysql_affected_rows(t-&gt;probe-&gt;db) == 0) { // nothing was actually inserted
+      dbi_result_free(result);
+      if (dbi_result_get_numrows_affected(t-&gt;probe-&gt;db) == 0) { // nothing was actually inserted
+        const char *errmsg;
+        dbi_conn_error(t-&gt;probe-&gt;db, &amp;errmsg);
         LOG(LOG_NOTICE, &quot;%s:%u@%s: insert missing pr_%s_def id %u: %s&quot;, 
                          res-&gt;realm, res-&gt;stattime, t-&gt;fromhost,
-                         res-&gt;name, def-&gt;probeid, mysql_error(t-&gt;probe-&gt;db));
+                         res-&gt;name, def-&gt;probeid, errmsg);
       }
-      result = my_query(t-&gt;probe-&gt;db, 0,
+      result = db_query(t-&gt;probe-&gt;db, 0,
                         &quot;select id, yellow, red, contact, hide, email, delay, pgroup &quot;
                         &quot;from   pr_%s_def &quot;
                         &quot;where  server = '%u'&quot;, res-&gt;name, res-&gt;server);
       if (!result) return(NULL);
     }
-    row = mysql_fetch_row(result); 
-    if (!row || !row[0]) {
-      LOG(LOG_NOTICE, &quot;%s:%u@%s: no pr_%s_def found for server %u - skipped&quot;, 
+    if (dbi_result_get_numrows(result) == 0) {
+      LOG(LOG_NOTICE, &quot;%s:%u@%s: no pr_%s_def found for server %u - skipped&quot;,
           res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, res-&gt;server);
-      mysql_free_result(result);
+      dbi_result_free(result);
+      g_free(def);
       return(NULL);
     }
-    if (row[0]) def-&gt;probeid  = atoi(row[0]);
-    if (row[1]) def-&gt;yellow   = atoi(row[1]);
-    if (row[2]) def-&gt;red      = atoi(row[2]);
-    if (row[3]) def-&gt;contact  = atoi(row[3]);
-    strcpy(def-&gt;hide, row[4] ? row[4] : &quot;no&quot;);
-    strcpy(def-&gt;email, row[5] ? row[5] : &quot;&quot;);
-    if (row[6]) def-&gt;delay = atoi(row[6]);
-    if (row[7]) def-&gt;pgroup = atoi(row[7]);
+    dbi_result_next_row(result);
 
-    mysql_free_result(result);
+    def-&gt;probeid = dbi_result_get_uint(result, &quot;id&quot;);
+    def-&gt;yellow = dbi_result_get_float(result, &quot;yellow&quot;);
+    def-&gt;red = dbi_result_get_float(result, &quot;red&quot;);
+    def-&gt;contact = dbi_result_get_uint(result, &quot;contact&quot;);
+    strcpy(def-&gt;hide, dbi_result_get_string(result, &quot;hide&quot;));
+    strcpy(def-&gt;email, dbi_result_get_string(result, &quot;email&quot;));
+    def-&gt;delay = dbi_result_get_uint(result, &quot;delay&quot;);
+    def-&gt;pgroup = dbi_result_get_uint(result, &quot;pgroup&quot;);
+    dbi_result_free(result);
 
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                       &quot;select color &quot;
                       &quot;from   pr_status &quot;
                       &quot;where  class = '%d' and probe = '%d'&quot;, t-&gt;probe-&gt;class, def-&gt;probeid);
     if (result) {
-      row = mysql_fetch_row(result);
-      if (row) {
-        def-&gt;color   = atoi(row[0]); 
+      if (dbi_result_get_numrows(result) == 0) {
+        LOG(LOG_NOTICE, &quot;%s:%u@%s: pr_status record for %s id %u not found&quot;,
+           res-&gt;realm, res-&gt;stattime, t-&gt;fromhost, res-&gt;name, def-&gt;probeid);
+      } else {
+        dbi_result_next_row(result);
+        def-&gt;color   = dbi_result_get_uint(result, &quot;color&quot;);
+        dbi_result_free(result);
       }
-      mysql_free_result(result);
-    } 
+    }
+    if (!def-&gt;color) def-&gt;color = res-&gt;color;
 
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                       &quot;select stattime from pr_%s_raw use index(probstat) &quot;
                       &quot;where probe = '%u' order by stattime desc limit 1&quot;,
                        res-&gt;name, def-&gt;probeid);
     if (result) {
-      if (mysql_num_rows(result) &gt; 0) {
-        row = mysql_fetch_row(result);
-        if (row &amp;&amp; row[0]) {
-          def-&gt;newest = atoi(row[0]);
-        }
+      if (dbi_result_get_numrows(result) &gt; 0) {
+        dbi_result_next_row(result);
+        def-&gt;newest  = dbi_result_get_uint(result, &quot;stattime&quot;);
+        dbi_result_free(result);
       }
-      mysql_free_result(result);
     }
 
     g_hash_table_insert(t-&gt;probe-&gt;cache, guintdup(res-&gt;server), def);

Modified: upwatch/libdbi/upwatch/probe.h
===================================================================
--- upwatch/libdbi/upwatch/probe.h	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/upwatch/probe.h	2006-07-21 20:34:40 UTC (rev 632)
@@ -68,7 +68,7 @@
 #define STANDARD_MODULE_STRUCT \
   int class;					/* numberic probe class (id of record in probe table) */ \
   char *module_name; 				/* name of the module */ \
-  MYSQL *db;					/* database handle the methods should use */ \
+  dbi_conn db;					/* database handle the methods should use */ \
   int needs_cache;				/* true if this probe caches def records */ \
   GHashTable *cache;				/* cached definition records */ \
   GPtrArray *insertc;				/* cache for doing multi value insert statements */ \
@@ -88,7 +88,7 @@
   void (*get_from_xml)(trx *t);			/* process one child of the &quot;result&quot; node */ \
   int (*accept_result)(trx *t);			/* accept (and maybe convert) result */ \
   char *get_def_fields;				/* list of fields to be inserted into SQL get_def query */ \
-  void (*set_def_fields)(trx *t, struct probe_def *def, MYSQL_RES *result);/* convert MySQL ROW into probe_def */ \
+  void (*set_def_fields)(trx *t, struct probe_def *def, dbi_result result);/* convert result into probe_def */ \
   void *(*get_def)(trx *t, int create);		/* retrieve probe definition */ \
   void (*adjust_result)(trx *t);		/* adjust result: usually compute our own colors */ \
   int (*end_result)(trx *t);                    /* maybe do some cleanup for this result */  \
@@ -120,7 +120,7 @@
 
 extern module *modules[];
 
-int set_result_value(trx *t, char *name, char *value);
+int set_result_value(trx *t, char *name, unsigned char *value);
 int extract_info_from_xml(trx *t);
 int accept_result(trx *t);
 void *get_def(trx *t, int create);
@@ -140,7 +140,7 @@
 #include &quot;../common/common.h&quot;
 };
 
-extern char *query_server_by_name;
+extern const char *query_server_by_name;
 void bb_free_res(void *res);
 void bb_xml_result_node(trx *t);
 int bb_accept_result(module *probe, void *probe_res);
@@ -218,7 +218,7 @@
   float slotday_avg_red;    //
 };
 
-extern char *query_server_by_ip;
+extern const char *query_server_by_ip;
 void iptraf_xml_result_node(trx *t);
 void iptraf_get_from_xml(trx *t);
 void *iptraf_get_def(trx *t, int create);

Modified: upwatch/libdbi/upwatch/spool.c
===================================================================
--- upwatch/libdbi/upwatch/spool.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/upwatch/spool.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -30,7 +30,7 @@
 static void alarm_handler(int sig); 
 static void set_handler(int sig, void (*h)());
  
-int spool_result(char *basedir, char *target, xmlDocPtr doc, char **targetname)
+int spool_result(const char *basedir, const char *target, xmlDocPtr doc, char **targetname)
 {
   struct stat filestat;
   int count;
@@ -123,7 +123,7 @@
   return 1;
 }
 
-void *spool_open(char *basedir, char *target, char *basename)
+void *spool_open(const char *basedir, const char *target, char *basename)
 {
   struct stat filestat;
   int count;

Modified: upwatch/libdbi/upwatch/spool.h
===================================================================
--- upwatch/libdbi/upwatch/spool.h	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/upwatch/spool.h	2006-07-21 20:34:40 UTC (rev 632)
@@ -1,8 +1,8 @@
-void *spool_open(char *basedir, char *target, char *basename);
+void *spool_open(const char *basedir, const char *target, char *basename);
 int spool_printf(void *sp_info, char *fmt, ...);
 int spool_write(void *sp_info, char *buffer, int len);
 int spool_close(void *sp_info, int complete);
 char *spool_tmpfilename(void *sp_info);
 char *spool_targfilename(void *sp_info);
 
-int spool_result(char *basedir, char *target, xmlDocPtr doc, char **targetname);
+int spool_result(const char *basedir, const char *target, xmlDocPtr doc, char **targetname);

Modified: upwatch/libdbi/upwatch-spec.spec
===================================================================
--- upwatch/libdbi/upwatch-spec.spec	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/upwatch-spec.spec	2006-07-21 20:34:40 UTC (rev 632)
@@ -6,7 +6,7 @@
 Release: 1
 Source: <A HREF="http://www.upwatch.com/%{name">http://www.upwatch.com/%{name</A>}-%{version}.tar.gz
 Packager: Ron Arts &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/upwatch-commits">raarts at upwatch.com</A>&gt;
-Copyright: Proprietary
+License: GPL 
 Group: Application/Monitoring
 BuildRoot: %{_tmppath}/%{name}-%{version}-root
 BuildRequires: gzip glib2-devel mysql-devel curl-devel autogen 

Modified: upwatch/libdbi/uw_accept/Makefile.am
===================================================================
--- upwatch/libdbi/uw_accept/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_accept/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -8,8 +8,8 @@
 init_DATA = $(INITFILES)
 
 uw_accept_SOURCES = run.c uw_accept.h uw_accept.c $(SPECFILES) $(INITFILES)
-uw_accept_CFLAGS = @MYSQL_CFLAGS@ @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS) 
-uw_accept_LDADD = uw_accept_$(DB_O) uw_accept_$(MAIN_O) $(LIBOPTS) $(LIBST) $(LIBUPWATCH) @MYSQL_LIBS@ @LIBGLIB2_LIBS@
+uw_accept_CFLAGS = @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS) 
+uw_accept_LDADD = uw_accept_$(DB_O) uw_accept_$(MAIN_O) $(LIBOPTS) $(LIBST) $(LIBUPWATCH) @LIBDBI_LIBS@ @LIBGLIB2_LIBS@
 
 BUILT_SOURCES = $(program:%=%.1) $(program:%=%.h) $(program:%=%.c) $(SPECFILES) $(INITFILES) 
 INCLUDES = -I../upwatch -I $(INCL_ST)

Modified: upwatch/libdbi/uw_accept/run.c
===================================================================
--- upwatch/libdbi/uw_accept/run.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_accept/run.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -20,7 +20,7 @@
   char db[64];
   char user[25];
   char password[25];
-  MYSQL *mysql;
+  dbi_conn conn;
 } *dblist;
 int dblist_cnt;
 
@@ -38,46 +38,45 @@
 
 void init_dblist(void)
 {
-  MYSQL *db;
+  dbi_conn conn;
 
-  db = open_database(OPT_ARG(DBHOST), OPT_VALUE_DBPORT, OPT_ARG(DBNAME),
+  conn = open_database(OPT_ARG(DBTYPE), OPT_ARG(DBHOST), OPT_ARG(DBPORT), OPT_ARG(DBNAME),
                      OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
-  if (db) {
-    MYSQL_RES *result;
+  if (conn) {
+    dbi_result result;
 
     if (dblist) free(dblist);
     dblist = calloc(100, sizeof(struct dbspec));
 
-    result = my_query(db, 0, &quot;select pr_realm.name, pr_realm.host, &quot;
+    result = db_query(conn, 0, &quot;select pr_realm.name, pr_realm.host, &quot;
                              &quot;       pr_realm.port, pr_realm.db, pr_realm.user, &quot;
                              &quot;       pr_realm.password &quot;
                              &quot;from   pr_realm &quot;
                              &quot;where  pr_realm.id &gt; 1&quot;);
     if (result) {
-      MYSQL_ROW row;
       dblist_cnt = 0;
-      while ((row = mysql_fetch_row(result)) != NULL) {
-        strcpy(dblist[dblist_cnt].realm, row[0]);
-        strcpy(dblist[dblist_cnt].host, row[1]);
-        dblist[dblist_cnt].port = atoi(row[2]);
-        strcpy(dblist[dblist_cnt].db, row[3]);
-        strcpy(dblist[dblist_cnt].user, row[4]);
-        strcpy(dblist[dblist_cnt].password, row[5]);
+      while (dbi_result_next_row(result)) {
+        strcpy(dblist[dblist_cnt].realm, dbi_result_get_string(result, &quot;name&quot;));
+        strcpy(dblist[dblist_cnt].host, dbi_result_get_string(result, &quot;host&quot;));
+        dblist[dblist_cnt].port = dbi_result_get_uint(result, &quot;port&quot;);
+        strcpy(dblist[dblist_cnt].db, dbi_result_get_string(result, &quot;db&quot;));
+        strcpy(dblist[dblist_cnt].user, dbi_result_get_string(result, &quot;user&quot;));
+        strcpy(dblist[dblist_cnt].password, dbi_result_get_string(result, &quot;password&quot;));
         dblist_cnt++;
       }
-      mysql_free_result(result);
+      dbi_result_free(result);
     }
-    close_database(db);
+    close_database(conn);
     LOG(LOG_INFO, &quot;read %u realms&quot;, dblist_cnt);
   } else {
-    LOG(LOG_NOTICE, &quot;could not open database %s@%s as user %s&quot;, OPT_ARG(DBNAME), OPT_ARG(DBHOST), OPT_ARG(DBUSER));
+    LOG(LOG_NOTICE, &quot;could not open %s database %s@%s as user %s&quot;, OPT_ARG(DBTYPE), OPT_ARG(DBNAME), OPT_ARG(DBHOST), OPT_ARG(DBUSER));
   } 
 }
 
-MYSQL *open_realm(char *realm)
+dbi_conn open_realm(char *realm)
 {
   int i;
-  MYSQL *mysql;
+  dbi_conn conn;
 static int call_cnt = 0;
 
   if (!dblist || ++call_cnt == 100) {
@@ -89,16 +88,22 @@
     }
   }
   if (realm == NULL || realm[0] == 0) {
-    mysql = open_database(dblist[0].host, dblist[0].port,
+    char buf[10];
+
+    sprintf(buf, &quot;%d&quot;, dblist[0].port);
+    conn = open_database(OPT_ARG(DBTYPE), dblist[0].host, buf,
             dblist[0].db, dblist[0].user, dblist[0].password);
-    return(mysql);
+    return(conn);
   }
 
   for (i=0; i &lt; dblist_cnt; i++) {
     if (strcmp(dblist[i].realm, realm) == 0) {
-      mysql = open_database(dblist[i].host, dblist[i].port,
+      char buf[10];
+
+      sprintf(buf, &quot;%d&quot;, dblist[0].port);
+      conn = open_database(OPT_ARG(DBTYPE), dblist[i].host, buf,
               dblist[i].db, dblist[i].user, dblist[i].password);
-      return(mysql);
+      return(conn);
     }
   }
   return(NULL);
@@ -106,8 +111,8 @@
 
 static int uw_password_ok(char *user, char *passwd) 
 {
-  MYSQL *mysql;
-  MYSQL_RES *result;
+  dbi_conn conn;
+  dbi_result result;
   char user_realm[256];
   char *realm;
 
@@ -116,33 +121,25 @@
   if (realm) { 
     *realm++ = 0; 
   }
-  mysql = open_realm(realm);
-  if (mysql) {
+  conn = open_realm(realm);
+  if (conn) {
     gchar buffer[256];
-    MYSQL_ROW row;
 
     sprintf(buffer, OPT_ARG(AUTHQUERY), user, passwd);
     LOG(LOG_DEBUG, buffer);
-    if (mysql_query(mysql, buffer)) {
-      close_database(mysql);
+    result = dbi_conn_query(conn, buffer);
+    if (!result) {
+      close_database(conn);
       return(FALSE);
     }
-    result = mysql_store_result(mysql);
-    if (!result || mysql_num_rows(result) &lt; 1) {
-      // LOG(LOG_NOTICE, &quot;user %s, pwd %s not found&quot;, user, passwd);
-      close_database(mysql);
-      return(FALSE);
-    }
-    if ((row = mysql_fetch_row(result))) {
-      int id;
-
-      id = atoi(row[0]);
+    if (dbi_result_next_row(result)) {
+      int id = dbi_result_get_uint_idx(result, 0);
       LOG(LOG_DEBUG, &quot;user %s, pwd %s resulted in id %d&quot;, user_realm, passwd, id);
     }
-    mysql_free_result(result);
-    close_database(mysql);
+    dbi_result_free(result);
+    close_database(conn);
   } else {
-    close_database(mysql);
+    close_database(conn);
     return(FALSE); // couldn't open database
   }
   return(TRUE);

Modified: upwatch/libdbi/uw_accept/uw_accept.def
===================================================================
--- upwatch/libdbi/uw_accept/uw_accept.def	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_accept/uw_accept.def	2006-07-21 20:34:40 UTC (rev 632)
@@ -16,7 +16,7 @@
 and copies incoming files to a queue.';
 
 // this section is for the generated specfile 
-spec-requires = &quot;/usr/bin/mysql glib2&quot;;
+spec-requires = &quot;libdbi &gt;= 0.8 glib2&quot;;
 spec-files = `echo &quot;%attr(0770,root,upwatch)&quot; $sbindir/uw_accept`;
 
 // describe commandline flags

Modified: upwatch/libdbi/uw_acceptbb/Makefile.am
===================================================================
--- upwatch/libdbi/uw_acceptbb/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_acceptbb/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -9,8 +9,8 @@
 
 uw_acceptbb_SOURCES = run.c uw_acceptbb.h uw_acceptbb.c \
  $(PROBFILES) $(SPECFILES) $(INITFILES)
-uw_acceptbb_CFLAGS = @MYSQL_CFLAGS@ @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
-uw_acceptbb_LDADD = uw_acceptbb_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) $(LIBST) @MYSQL_LIBS@ @LIBGLIB2_LIBS@
+uw_acceptbb_CFLAGS = @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
+uw_acceptbb_LDADD = uw_acceptbb_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) $(LIBST) @LIBDBI_LIBS@ @LIBGLIB2_LIBS@
 
 BUILT_SOURCES = $(program:%=%.1) $(program:%=%.h) $(program:%=%.c) $(PROBFILES) $(SPECFILES) $(INITFILES)
 INCLUDES = -I../upwatch -I $(INCL_ST)

Modified: upwatch/libdbi/uw_acceptbb/uw_acceptbb.def
===================================================================
--- upwatch/libdbi/uw_acceptbb/uw_acceptbb.def	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_acceptbb/uw_acceptbb.def	2006-07-21 20:34:40 UTC (rev 632)
@@ -14,7 +14,7 @@
 Big Brother package (www.bb4.com)';
 
 // this section is for the generated specfile 
-spec-requires = &quot;/usr/bin/mysql glib2&quot;;
+spec-requires = &quot;libdbi &gt;= 0.8 glib2&quot;;
 spec-files = `echo &quot;%attr(0770,root,upwatch)&quot; $sbindir/uw_acceptbb`;
 
 // describe commandline flags

Modified: upwatch/libdbi/uw_dns/Makefile.am
===================================================================
--- upwatch/libdbi/uw_dns/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_dns/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -8,8 +8,8 @@
 init_DATA = $(INITFILES)
 
 uw_dns_SOURCES = run.c uw_dns.h uw_dns.c $(PROBFILES) $(SPECFILES) $(INITFILES)
-uw_dns_CFLAGS = @LIBXML2_CFLAGS@ @MYSQL_CFLAGS@ @LIBGLIB2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS) 
-uw_dns_LDADD = uw_dns_$(DB_O) uw_dns_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) $(LIBST) @MYSQL_LIBS@ @LIBGLIB2_LIBS@
+uw_dns_CFLAGS = @LIBXML2_CFLAGS@ @LIBGLIB2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS) 
+uw_dns_LDADD = uw_dns_$(DB_O) uw_dns_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) $(LIBST) @LIBDBI_LIBS@ @LIBGLIB2_LIBS@
 
 BUILT_SOURCES = $(program:%=%.1) $(program:%=%.h) $(program:%=%.c) $(PROBFILES) $(SPECFILES) $(INITFILES)
 INCLUDES = -I../upwatch -I $(INCL_ST)

Modified: upwatch/libdbi/uw_dns/run.c
===================================================================
--- upwatch/libdbi/uw_dns/run.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_dns/run.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -113,13 +113,13 @@
   return(1);
 }
 
-void refresh_database(MYSQL *mysql);
+void refresh_database(dbi_conn conn);
 void run_actual_probes(void);
 void write_results(void);
 
 int run(void)
 {
-  MYSQL *mysql;
+  dbi_conn conn;
 
   if ((pktno &gt;&gt; 16) &gt; (getpid() &amp; 0xffff) + 10) {
     pktno = (getpid() &amp; 0xffff) &lt;&lt; 16;
@@ -131,11 +131,11 @@
   
   LOG(LOG_INFO, &quot;reading info from database&quot;);
   uw_setproctitle(&quot;reading info from database&quot;);
-  mysql = open_database(OPT_ARG(DBHOST), OPT_VALUE_DBPORT, OPT_ARG(DBNAME), 
+  conn = open_database(OPT_ARG(DBTYPE), OPT_ARG(DBHOST), OPT_ARG(DBPORT), OPT_ARG(DBNAME), 
 			OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
-  if (mysql) {
-    refresh_database(mysql);
-    close_database(mysql);
+  if (conn) {
+    refresh_database(conn);
+    close_database(conn);
   }
 
   if (g_hash_table_size(cache) &gt; 0) {
@@ -151,10 +151,9 @@
   return(g_hash_table_size(cache));
 }
 
-void refresh_database(MYSQL *mysql)
+void refresh_database(dbi_conn conn)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   char qry[1024];
 
   sprintf(qry,  &quot;SELECT pr_dns_def.id, pr_dns_def.domid, pr_dns_def.tblid, pr_realm.name, &quot;
@@ -165,23 +164,23 @@
                 &quot;       and pr_dns_def.pgroup = '%d' and pr_realm.id = pr_dns_def.domid&quot;,
                 (unsigned)OPT_VALUE_GROUPID);
 
-  result = my_query(mysql, 1, qry);
+  result = db_query(conn, 1, qry);
   if (!result) {
     return;
   }
     
-  while ((row = mysql_fetch_row(result))) {
+  while (dbi_result_next_row(result)) {
     int id;
     struct probedef *probe;
 
-    id = atol(row[0]);
+    id = dbi_result_get_uint(result, &quot;id&quot;);
     probe = g_hash_table_lookup(cache, &amp;id);
     if (!probe) {
       probe = g_malloc0(sizeof(struct probedef));
       probe-&gt;id = id;
-      if (atoi(row[1]) &gt; 1) {
-        probe-&gt;probeid = atoi(row[2]);
-        probe-&gt;realm = strdup(row[3]);
+      if (dbi_result_get_uint(result, &quot;domid&quot;) &gt; 1) {
+        probe-&gt;probeid = dbi_result_get_uint(result, &quot;tblid&quot;);
+        strcpy(probe-&gt;realm, dbi_result_get_string(result, &quot;name&quot;));
       } else {
         probe-&gt;probeid = probe-&gt;id;
       }
@@ -189,19 +188,22 @@
     }
 
     if (probe-&gt;ipaddress) g_free(probe-&gt;ipaddress);
-    probe-&gt;ipaddress = strdup(row[4]);
-    probe-&gt;yellow = atof(row[5]);
-    probe-&gt;red = atof(row[6]);
+    probe-&gt;ipaddress = dbi_result_get_string_copy(result, &quot;ipaddress&quot;);
+    probe-&gt;yellow = dbi_result_get_float(result, &quot;yellow&quot;);
+    probe-&gt;red = dbi_result_get_float(result, &quot;red&quot;);
     if (probe-&gt;msg) g_free(probe-&gt;msg);
     probe-&gt;msg = NULL;
     probe-&gt;seen = 1;
   }
-  mysql_free_result(result);
-  if (mysql_errno(mysql)) {
+  if (dbi_conn_error_flag(conn)) {
+    const char *errmsg;
+    dbi_conn_error(conn, &amp;errmsg);
+    LOG(LOG_ERR, &quot;%s&quot;, errmsg);
     g_hash_table_foreach(cache, reset_seen, NULL);
   } else {
     g_hash_table_foreach_remove(cache, return_seen, NULL);
   }
+  dbi_result_free(result);
 }
 
 void write_probe(gpointer key, gpointer value, gpointer user_data)

Modified: upwatch/libdbi/uw_dns/uw_dns.def
===================================================================
--- upwatch/libdbi/uw_dns/uw_dns.def	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_dns/uw_dns.def	2006-07-21 20:34:40 UTC (rev 632)
@@ -15,7 +15,7 @@
 so uw_dns can process thousands of hosts in a very short period.';
 
 // this section is for the generated specfile
-spec-requires = &quot;/usr/bin/mysql glib2&quot;;
+spec-requires = &quot;libdbi &gt;= 0.8 glib2&quot;;
 //spec-files = &quot;%attr(0770,root,upwatch) &quot; 
 spec-files = `echo &quot;%attr(0770,root,upwatch)&quot; $sbindir/uw_dns`;
 

Modified: upwatch/libdbi/uw_httpget/Makefile.am
===================================================================
--- upwatch/libdbi/uw_httpget/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_httpget/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -8,8 +8,8 @@
 init_DATA = $(INITFILES)
 
 uw_httpget_SOURCES = run.c uw_httpget.h uw_httpget.c $(PROBFILES) $(SPECFILES) $(INITFILES)
-uw_httpget_CFLAGS = @LIBXML2_CFLAGS@ @MYSQL_CFLAGS@ @LIBGLIB2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS) 
-uw_httpget_LDADD = uw_httpget_$(DB_O) uw_httpget_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) $(LIBST) @MYSQL_LIBS@ @LIBGLIB2_LIBS@
+uw_httpget_CFLAGS = @LIBXML2_CFLAGS@ @LIBGLIB2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS) 
+uw_httpget_LDADD = uw_httpget_$(DB_O) uw_httpget_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) $(LIBST) @LIBDBI_LIBS@ @LIBGLIB2_LIBS@
 
 BUILT_SOURCES = $(program:%=%.1) $(program:%=%.h) $(program:%=%.c) $(PROBFILES) $(SPECFILES) $(INITFILES)
 INCLUDES = -I../upwatch -I $(INCL_ST)

Modified: upwatch/libdbi/uw_httpget/run.c
===================================================================
--- upwatch/libdbi/uw_httpget/run.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_httpget/run.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -29,7 +29,7 @@
 static void *probe(void *user_data); 
 static void write_results(void);
 void run_actual_probes(void);
-void refresh_database(MYSQL *mysql);
+void refresh_database(dbi_conn conn);
 
 int thread_count = 0;
 
@@ -90,13 +90,13 @@
   return 1;
 }
 
-void refresh_database(MYSQL *mysql);
+void refresh_database(dbi_conn conn);
 void run_actual_probes(void);
 static void write_results(void);
 
 int run()
 {
-  MYSQL *mysql;
+  dbi_conn conn;
 
   if (!cache) {
     cache = g_hash_table_new_full(g_int_hash, g_int_equal, g_free, free_probe);
@@ -104,11 +104,11 @@
 
   LOG(LOG_INFO, &quot;reading info from database&quot;);
   uw_setproctitle(&quot;reading info from database&quot;);
-  mysql = open_database(OPT_ARG(DBHOST), OPT_VALUE_DBPORT, OPT_ARG(DBNAME),
+  conn = open_database(OPT_ARG(DBTYPE), OPT_ARG(DBHOST), OPT_ARG(DBPORT), OPT_ARG(DBNAME),
                         OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
-  if (mysql) {
-    refresh_database(mysql);
-    close_database(mysql);
+  if (conn) {
+    refresh_database(conn);
+    close_database(conn);
   }
 
   if (g_hash_table_size(cache) &gt; 0) {
@@ -124,10 +124,9 @@
   return(g_hash_table_size(cache));
 }
 
-void refresh_database(MYSQL *mysql)
+void refresh_database(dbi_conn conn)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   char qry[1024];
 
   //g_hash_table_foreach_remove(cache, delete_probe, NULL);
@@ -140,22 +139,22 @@
                 &quot;       and pr_httpget_def.pgroup = '%u' and pr_realm.id = pr_httpget_def.domid&quot;,
                 (unsigned) OPT_VALUE_GROUPID);
 
-  result = my_query(mysql, 1, qry);
+  result = db_query(conn, 1, qry);
   if (!result) {
     return;
   }
-  while ((row = mysql_fetch_row(result))) {
+  while (dbi_result_next_row(result)) {
     int id;
     struct probedef *probe;
 
-    id = atoi(row[0]);
+    id = dbi_result_get_uint(result, &quot;id&quot;);
     probe = g_hash_table_lookup(cache, &amp;id);
     if (!probe) {
       probe = g_malloc0(sizeof(struct probedef));
       probe-&gt;id = id;
-      if (atoi(row[1]) &gt; 1) {
-        probe-&gt;probeid = atoi(row[2]);
-        probe-&gt;realm = strdup(row[3]);
+      if (dbi_result_get_uint(result, &quot;domid&quot;) &gt; 1) {
+        probe-&gt;probeid = dbi_result_get_uint(result, &quot;tblid&quot;);
+        strcpy(probe-&gt;realm, dbi_result_get_string(result, &quot;name&quot;));
       } else {
         probe-&gt;probeid = probe-&gt;id;
       }
@@ -164,27 +163,29 @@
     }
 
     if (probe-&gt;ipaddress) g_free(probe-&gt;ipaddress);
-    probe-&gt;ipaddress = strdup(row[4]);
+    probe-&gt;ipaddress = dbi_result_get_string_copy(result, &quot;ipaddress&quot;);
     if (probe-&gt;uri) g_free(probe-&gt;uri);
-    probe-&gt;uri = strdup(row[5]);
+    probe-&gt;uri = dbi_result_get_string_copy(result, &quot;uri&quot;);
     if (probe-&gt;hostname) g_free(probe-&gt;hostname);
-    probe-&gt;hostname = strdup(row[6]);
-    probe-&gt;port = atoi(row[7]);
-    probe-&gt;yellow = atof(row[8]);
-    probe-&gt;red = atof(row[9]);
+    probe-&gt;hostname = dbi_result_get_string_copy(result, &quot;hostname&quot;);
+    probe-&gt;port = dbi_result_get_uint(result, &quot;port&quot;);
+    probe-&gt;yellow = dbi_result_get_float(result, &quot;yellow&quot;);
+    probe-&gt;red = dbi_result_get_float(result, &quot;red&quot;);
     if (probe-&gt;msg) g_free(probe-&gt;msg);
     probe-&gt;msg = NULL;
     if (probe-&gt;info) g_free(probe-&gt;info);
     probe-&gt;info = NULL;
     probe-&gt;seen = 1;
   }
-  mysql_free_result(result);
-  if (mysql_errno(mysql)) {
-    LOG(LOG_ERR, &quot;%s&quot;, mysql_error(mysql));
+  if (dbi_conn_error_flag(conn)) {
+    const char *errmsg;
+    dbi_conn_error(conn, &amp;errmsg);
+    LOG(LOG_ERR, &quot;%s&quot;, errmsg);
     g_hash_table_foreach(cache, reset_seen, NULL);
   } else {
     g_hash_table_foreach_remove(cache, return_seen, NULL);
   }
+  dbi_result_free(result);
 }
 
 void add_probe(gpointer key, gpointer value, gpointer user_data)
@@ -260,7 +261,7 @@
 static void write_results(void)
 {
   int ct  = STACKCT_OPT(OUTPUT);
-  char **output = STACKLST_OPT(OUTPUT);
+  const char **output = STACKLST_OPT(OUTPUT);
   int i;
   xmlDocPtr doc;
 

Modified: upwatch/libdbi/uw_httpget/uw_httpget.def
===================================================================
--- upwatch/libdbi/uw_httpget/uw_httpget.def	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_httpget/uw_httpget.def	2006-07-21 20:34:40 UTC (rev 632)
@@ -15,7 +15,7 @@
 so uw_httpget can process thousands of hosts in a very short period.';
 
 // this section is for the generated specfile
-spec-requires = &quot;/usr/bin/mysql glib2&quot;;
+spec-requires = &quot;libdbi &gt;= 0.8 glib2&quot;;
 //spec-files = &quot;%attr(0770,root,upwatch) &quot; 
 spec-files = `echo &quot;%attr(0770,root,upwatch)&quot; $sbindir/uw_httpget`;
 

Modified: upwatch/libdbi/uw_imap/Makefile.am
===================================================================
--- upwatch/libdbi/uw_imap/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_imap/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -8,8 +8,8 @@
 init_DATA = $(INITFILES)
 
 uw_imap_SOURCES = run.c uw_imap.h uw_imap.c $(PROBFILES) $(SPECFILES) $(INITFILES)
-uw_imap_CFLAGS = @MYSQL_CFLAGS@ @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
-uw_imap_LDADD = uw_imap_$(DB_O) uw_imap_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) $(LIBST) @MYSQL_LIBS@ @LIBGLIB2_LIBS@
+uw_imap_CFLAGS = @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
+uw_imap_LDADD = uw_imap_$(DB_O) uw_imap_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) $(LIBST) @LIBDBI_LIBS@ @LIBGLIB2_LIBS@
 
 BUILT_SOURCES = $(program:%=%.1) $(program:%=%.h) $(program:%=%.c) $(PROBFILES) $(SPECFILES) $(INITFILES)
 INCLUDES = -I../upwatch -I $(INCL_ST)

Modified: upwatch/libdbi/uw_imap/run.c
===================================================================
--- upwatch/libdbi/uw_imap/run.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_imap/run.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -68,13 +68,13 @@
   return(1);
 }
 
-void refresh_database(MYSQL *mysql);
+void refresh_database(dbi_conn conn);
 void run_actual_probes(void);
 void write_results(void);
 
 int run(void)
 {
-  MYSQL *mysql;
+  dbi_conn conn;
 
   if (!cache) {
     cache = g_hash_table_new_full(g_int_hash, g_int_equal, g_free, free_probe);
@@ -82,11 +82,11 @@
   
   LOG(LOG_INFO, &quot;reading info from database&quot;);
   uw_setproctitle(&quot;reading info from database&quot;);
-  mysql = open_database(OPT_ARG(DBHOST), OPT_VALUE_DBPORT, OPT_ARG(DBNAME), 
+  conn = open_database(OPT_ARG(DBTYPE), OPT_ARG(DBHOST), OPT_ARG(DBPORT), OPT_ARG(DBNAME), 
 			OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
-  if (mysql) {
-    refresh_database(mysql);
-    close_database(mysql);
+  if (conn) {
+    refresh_database(conn);
+    close_database(conn);
   }
 
   if (g_hash_table_size(cache) &gt; 0) {
@@ -102,10 +102,9 @@
   return(g_hash_table_size(cache));
 }
 
-void refresh_database(MYSQL *mysql)
+void refresh_database(dbi_conn conn)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   char qry[1024];
 
   sprintf(qry,  &quot;SELECT pr_imap_def.id, pr_imap_def.domid, pr_imap_def.tblid, pr_realm.name, &quot;
@@ -117,22 +116,22 @@
                 &quot;       and pr_imap_def.pgroup = '%d' and pr_realm.id = pr_imap_def.domid&quot;,
                 (unsigned)OPT_VALUE_GROUPID);
 
-  result = my_query(mysql, 1, qry);
+  result = db_query(conn, 1, qry);
   if (!result) {
     return;
   }
     
-  while ((row = mysql_fetch_row(result))) {
+  while (dbi_result_next_row(result)) {
     int id;
     struct probedef *probe;
 
-    id = atol(row[0]);
+    id = dbi_result_get_uint(result, &quot;id&quot;);
     probe = g_hash_table_lookup(cache, &amp;id);
     if (!probe) {
       probe = g_malloc0(sizeof(struct probedef));
-      if (atoi(row[1]) &gt; 1) {
-        probe-&gt;probeid = atoi(row[2]);
-        probe-&gt;realm = strdup(row[3]);
+      if (dbi_result_get_uint(result, &quot;domid&quot;) &gt; 1) {
+        probe-&gt;probeid = dbi_result_get_uint(result, &quot;tblid&quot;);
+        strcpy(probe-&gt;realm, dbi_result_get_string(result, &quot;name&quot;));
       } else {
         probe-&gt;probeid = probe-&gt;id;
       }
@@ -140,24 +139,26 @@
     }
 
     if (probe-&gt;ipaddress) g_free(probe-&gt;ipaddress);
-    probe-&gt;ipaddress = strdup(row[4]);
+    probe-&gt;ipaddress = dbi_result_get_string_copy(result, &quot;ipaddress&quot;);
     if (probe-&gt;username) g_free(probe-&gt;username);
-    probe-&gt;username = strdup(row[5]);
+    probe-&gt;username = dbi_result_get_string_copy(result, &quot;username&quot;);
     if (probe-&gt;password) g_free(probe-&gt;password);
-    probe-&gt;password = strdup(row[6]);
-    probe-&gt;yellow = atof(row[7]);
-    probe-&gt;red = atof(row[8]);
+    probe-&gt;password = dbi_result_get_string_copy(result, &quot;password&quot;);
+    probe-&gt;yellow = dbi_result_get_float(result, &quot;yellow&quot;);
+    probe-&gt;red = dbi_result_get_float(result, &quot;red&quot;);
     if (probe-&gt;msg) g_free(probe-&gt;msg);
     probe-&gt;msg = NULL;
     probe-&gt;seen = 1;
   }
-  mysql_free_result(result);
-  if (mysql_errno(mysql)) {
-    LOG(LOG_INFO, &quot;saw an error: not removing any probes&quot;);
+  if (dbi_conn_error_flag(conn)) {
+    const char *errmsg;
+    dbi_conn_error(conn, &amp;errmsg);
+    LOG(LOG_ERR, &quot;%s&quot;, errmsg);
     g_hash_table_foreach(cache, reset_seen, NULL);
   } else {
     g_hash_table_foreach_remove(cache, return_seen, NULL);
   }
+  dbi_result_free(result);
 }
 
 void *probe(void *user_data); 
@@ -226,7 +227,7 @@
 void write_results(void)
 {
   int ct  = STACKCT_OPT(OUTPUT);
-  char **output = STACKLST_OPT(OUTPUT);
+  const char **output = STACKLST_OPT(OUTPUT);
   int i;
   xmlDocPtr doc;
 

Modified: upwatch/libdbi/uw_imap/uw_imap.def
===================================================================
--- upwatch/libdbi/uw_imap/uw_imap.def	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_imap/uw_imap.def	2006-07-21 20:34:40 UTC (rev 632)
@@ -15,7 +15,7 @@
 so uw_imap can process thousands of hosts in a very short period.';
 
 // this section is for the generated specfile
-spec-requires = &quot;/usr/bin/mysql glib2&quot;;
+spec-requires = &quot;libdbi &gt;= 0.8 glib2&quot;;
 spec-files = `echo &quot;%attr(0770,root,upwatch)&quot; $sbindir/uw_imap`;
 
 // describe commandline flags

Modified: upwatch/libdbi/uw_investigate/cmd_options.def
===================================================================
--- upwatch/libdbi/uw_investigate/cmd_options.def	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_investigate/cmd_options.def	2006-07-21 20:34:40 UTC (rev 632)
@@ -13,7 +13,7 @@
 'uw_investigate does the following: ';
 
 // this section is for the generated specfile
-spec-requires = &quot;libpcap = 0.6.2-13uw /usr/bin/mysql glib2 &gt;= 2.0.4 curl &gt;= 7.9.3 libnet &gt;= 1.0.2&quot;;
+spec-requires = &quot;libpcap = 0.6.2-13uw libdbi &gt;= 0.8 glib2 &gt;= 2.0.4 curl &gt;= 7.9.3 libnet &gt;= 1.0.2&quot;;
 spec-files    = `echo %dir $spooldir/uw_investigate/new`;
 spec-files    = `echo %dir $spooldir/uw_investigate/tmp`;
 

Modified: upwatch/libdbi/uw_mssql/Makefile.am
===================================================================
--- upwatch/libdbi/uw_mssql/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_mssql/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -1,15 +1,17 @@
 include $(top_srcdir)/Makefile.am.path
 
 AM_CFLAGS += -DWITH_THREADS
+if HAVE_LIBTDS
 program = uw_mssql
+endif
 sbin_PROGRAMS = $(program)
 man_MANS = uw_mssql.1
 conf_DATA = $(program:%=%.conf)
 init_DATA = $(INITFILES)
 
 uw_mssql_SOURCES = run.c uw_mssql.h uw_mssql.c $(PROBFILES) $(SPECFILES) $(INITFILES)
-uw_mssql_CFLAGS = @MYSQL_CFLAGS@ @LIBGTHREAD2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
-uw_mssql_LDADD = uw_mssql_$(DB_O) uw_mssql_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCHT) @MYSQL_LIBS@ @LIBGTHREAD2_LIBS@ @LIBTDS_LIBS@
+uw_mssql_CFLAGS = @LIBGTHREAD2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
+uw_mssql_LDADD = uw_mssql_$(DB_O) uw_mssql_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCHT) @LIBDBI_LIBS@ @LIBGTHREAD2_LIBS@ @LIBTDS_LIBS@
 
 BUILT_SOURCES = $(program:%=%.1) $(program:%=%.h) $(program:%=%.c) $(PROBFILES) $(SPECFILES) $(INITFILES)
 INCLUDES = -I../upwatch

Modified: upwatch/libdbi/uw_mssql/run.c
===================================================================
--- upwatch/libdbi/uw_mssql/run.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_mssql/run.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -63,13 +63,13 @@
   return(1);
 }
 
-void refresh_database(MYSQL *mysql);
+void refresh_database(dbi_conn);
 void run_actual_probes(void);
 void write_results(void);
 
 int run(void)
 {
-  MYSQL *mysql;
+  dbi_conn conn;
 
   if (!cache) {
     cache = g_hash_table_new_full(g_int_hash, g_int_equal, g_free, free_probe);
@@ -77,11 +77,11 @@
   
   LOG(LOG_INFO, &quot;reading info from database&quot;);
   uw_setproctitle(&quot;reading info from database&quot;);
-  mysql = open_database(OPT_ARG(DBHOST), OPT_VALUE_DBPORT, OPT_ARG(DBNAME), 
+  conn = open_database(OPT_ARG(DBTYPE), OPT_ARG(DBHOST), OPT_ARG(DBPORT), OPT_ARG(DBNAME), 
 			OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
-  if (mysql) {
-    refresh_database(mysql);
-    close_database(mysql);
+  if (conn) {
+    refresh_database(conn);
+    close_database(conn);
   }
 
   if (g_hash_table_size(cache) &gt; 0) {
@@ -97,10 +97,9 @@
   return(g_hash_table_size(cache));
 }
 
-void refresh_database(MYSQL *mysql)
+void refresh_database(dbi_conn conn)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   char qry[1024];
 
   sprintf(qry,  &quot;SELECT pr_mssql_def.id, pr_mssql_def.domid, pr_mssql_def.tblid, pr_realm.name, &quot;
@@ -113,22 +112,22 @@
                 &quot;       and pr_mssql_def.pgroup = '%d' and pr_realm.id = pr_mssql_def.domid &quot;,
                 (unsigned)OPT_VALUE_GROUPID);
 
-  result = my_query(mysql, 1, qry);
+  result = db_query(conn, 1, qry);
   if (!result) {
     return;
   }
     
-  while ((row = mysql_fetch_row(result))) {
+  while (dbi_result_next_row(result)) {
     int id;
     struct probedef *probe;
 
-    id = atol(row[0]);
+    id = dbi_result_get_uint(result, &quot;id&quot;);
     probe = g_hash_table_lookup(cache, &amp;id);
     if (!probe) {
       probe = g_malloc0(sizeof(struct probedef));
-      if (atoi(row[1]) &gt; 1) {
-        probe-&gt;probeid = atoi(row[2]);
-        probe-&gt;realm = strdup(row[3]);
+      if (dbi_result_get_uint(result, &quot;domid&quot;) &gt; 1) {
+        probe-&gt;probeid = dbi_result_get_uint(result, &quot;tblid&quot;);
+        strcpy(probe-&gt;realm, dbi_result_get_string(result, &quot;name&quot;));
       } else {
         probe-&gt;probeid = probe-&gt;id;
       }
@@ -136,27 +135,30 @@
     }
 
     if (probe-&gt;ipaddress) g_free(probe-&gt;ipaddress);
-    probe-&gt;ipaddress = strdup(row[4]);
+    probe-&gt;ipaddress = dbi_result_get_string_copy(result, &quot;ipaddress&quot;);
     if (probe-&gt;dbname) g_free(probe-&gt;dbname);
-    probe-&gt;dbname = strdup(row[5]);
+    probe-&gt;dbname = dbi_result_get_string_copy(result, &quot;dbname&quot;);
     if (probe-&gt;dbuser) g_free(probe-&gt;dbuser);
-    probe-&gt;dbuser = strdup(row[6]);
+    probe-&gt;dbuser = dbi_result_get_string_copy(result, &quot;dbuser&quot;);
     if (probe-&gt;dbpasswd) g_free(probe-&gt;dbpasswd);
-    probe-&gt;dbpasswd = strdup(row[7]);
+    probe-&gt;dbpasswd = dbi_result_get_string_copy(result, &quot;dbpasswd&quot;);
     if (probe-&gt;query) g_free(probe-&gt;query);
-    probe-&gt;query = strdup(row[8]);
-    probe-&gt;yellow = atof(row[9]);
-    probe-&gt;red = atof(row[10]);
+    probe-&gt;query = dbi_result_get_string_copy(result, &quot;query&quot;);
+    probe-&gt;yellow = dbi_result_get_float(result, &quot;yellow&quot;);
+    probe-&gt;red = dbi_result_get_float(result, &quot;red&quot;);
     if (probe-&gt;msg) g_free(probe-&gt;msg);
     probe-&gt;msg = NULL;
     probe-&gt;seen = 1;
   }
-  mysql_free_result(result);
-  if (mysql_errno(mysql)) {
+  if (dbi_conn_error_flag(conn)) {
+    const char *errmsg;
+    dbi_conn_error(conn, &amp;errmsg);
+    LOG(LOG_ERR, &quot;%s&quot;, errmsg);
     g_hash_table_foreach(cache, reset_seen, NULL);
   } else {
     g_hash_table_foreach_remove(cache, return_seen, NULL);
   }
+  dbi_result_free(result);
 }
 
 void probe(gpointer data, gpointer user_data);

Modified: upwatch/libdbi/uw_mssql/uw_mssql.def
===================================================================
--- upwatch/libdbi/uw_mssql/uw_mssql.def	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_mssql/uw_mssql.def	2006-07-21 20:34:40 UTC (rev 632)
@@ -15,7 +15,7 @@
 so uw_mssql can process thousands of hosts in a very short period.';
 
 // this section is for the generated specfile
-spec-requires = &quot;/usr/bin/mysql glib2 freetds&quot;;
+spec-requires = &quot;libdbi &gt;= 0.8 glib2 freetds&quot;;
 spec-files = `echo &quot;%attr(0770,root,upwatch)&quot; $sbindir/uw_mssql`;
 
 // describe commandline flags

Modified: upwatch/libdbi/uw_mysql/Makefile.am
===================================================================
--- upwatch/libdbi/uw_mysql/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_mysql/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -1,7 +1,9 @@
 include $(top_srcdir)/Makefile.am.path
 
 AM_CFLAGS += -DWITH_THREADS
+if HAVE_LIBMYSQL
 program = uw_mysql
+endif
 sbin_PROGRAMS = $(program)
 man_MANS = uw_mysql.1
 conf_DATA = $(program:%=%.conf)
@@ -9,7 +11,7 @@
 
 uw_mysql_SOURCES = run.c uw_mysql.h uw_mysql.c $(PROBFILES) $(SPECFILES) $(INITFILES)
 uw_mysql_CFLAGS = @MYSQL_CFLAGS@ @LIBGTHREAD2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
-uw_mysql_LDADD = uw_mysql_$(DB_O) uw_mysql_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCHT) @MYSQL_LIBS@ @LIBGTHREAD2_LIBS@
+uw_mysql_LDADD = uw_mysql_$(DB_O) uw_mysql_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCHT) @MYSQL_LIBS@ @LIBDBI_LIBS@ @LIBGTHREAD2_LIBS@
 
 BUILT_SOURCES = $(program:%=%.1) $(program:%=%.h) $(program:%=%.c) $(PROBFILES) $(SPECFILES) $(INITFILES)
 INCLUDES = -I../upwatch

Modified: upwatch/libdbi/uw_mysql/run.c
===================================================================
--- upwatch/libdbi/uw_mysql/run.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_mysql/run.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -2,6 +2,7 @@
 #include &lt;db.h&gt;
 #include &lt;generic.h&gt;
 #include &lt;sys/time.h&gt;
+#include &lt;mysql.h&gt;
 
 #include &quot;uw_mysql.h&quot;
 
@@ -62,13 +63,13 @@
   return(1);
 }
 
-void refresh_database(MYSQL *mysql);
+void refresh_database(dbi_conn conn);
 void run_actual_probes(void);
 void write_results(void);
 
 int run(void)
 {
-  MYSQL *mysql;
+  dbi_conn conn;
 
   if (!cache) {
     cache = g_hash_table_new_full(g_int_hash, g_int_equal, g_free, free_probe);
@@ -76,11 +77,11 @@
   
   LOG(LOG_INFO, &quot;reading info from database&quot;); 
   uw_setproctitle(&quot;reading info from database&quot;);
-  mysql = open_database(OPT_ARG(DBHOST), OPT_VALUE_DBPORT, OPT_ARG(DBNAME), 
+  conn = open_database(OPT_ARG(DBTYPE), OPT_ARG(DBHOST), OPT_ARG(DBPORT), OPT_ARG(DBNAME), 
 			OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
-  if (mysql) {
-    refresh_database(mysql);
-    close_database(mysql);
+  if (conn) {
+    refresh_database(conn);
+    close_database(conn);
   }
 
   if (g_hash_table_size(cache) &gt; 0) {
@@ -96,10 +97,9 @@
   return(g_hash_table_size(cache));
 }
 
-void refresh_database(MYSQL *mysql)
+void refresh_database(dbi_conn conn)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   char qry[1024];
 
   sprintf(qry,  &quot;SELECT pr_mysql_def.id, pr_mysql_def.domid, pr_mysql_def.tblid, pr_realm.name, &quot;
@@ -112,22 +112,22 @@
                 &quot;       and pr_mysql_def.pgroup = '%d' and pr_realm.id = pr_mysql_def.domid&quot;,
                 (unsigned)OPT_VALUE_GROUPID);
 
-  result = my_query(mysql, 1, qry);
+  result = db_query(conn, 1, qry);
   if (!result) {
     return;
   }
     
-  while ((row = mysql_fetch_row(result))) {
+  while (dbi_result_next_row(result)) {
     int id;
     struct probedef *probe;
 
-    id = atol(row[0]);
+    id = dbi_result_get_uint(result, &quot;id&quot;);
     probe = g_hash_table_lookup(cache, &amp;id);
     if (!probe) {
       probe = g_malloc0(sizeof(struct probedef));
-      if (atoi(row[1]) &gt; 1) {
-        probe-&gt;probeid = atoi(row[2]);
-        probe-&gt;realm = strdup(row[3]);
+      if (dbi_result_get_uint(result, &quot;domid&quot;) &gt; 1) {
+        probe-&gt;probeid = dbi_result_get_uint(result, &quot;tblid&quot;);
+        strcpy(probe-&gt;realm, dbi_result_get_string(result, &quot;name&quot;));
       } else {
         probe-&gt;probeid = probe-&gt;id;
       }
@@ -135,27 +135,30 @@
     }
 
     if (probe-&gt;ipaddress) g_free(probe-&gt;ipaddress);
-    probe-&gt;ipaddress = strdup(row[4]);
+    probe-&gt;ipaddress = dbi_result_get_string_copy(result, &quot;ipaddress&quot;);
     if (probe-&gt;dbname) g_free(probe-&gt;dbname);
-    probe-&gt;dbname = strdup(row[5]);
+    probe-&gt;dbname = dbi_result_get_string_copy(result, &quot;dbname&quot;);
     if (probe-&gt;dbuser) g_free(probe-&gt;dbuser);
-    probe-&gt;dbuser = strdup(row[6]);
+    probe-&gt;dbuser = dbi_result_get_string_copy(result, &quot;dbuser&quot;);
     if (probe-&gt;dbpasswd) g_free(probe-&gt;dbpasswd);
-    probe-&gt;dbpasswd = strdup(row[7]);
+    probe-&gt;dbpasswd = dbi_result_get_string_copy(result, &quot;dbpasswd&quot;);
     if (probe-&gt;query) g_free(probe-&gt;query);
-    probe-&gt;query = strdup(row[8]);
-    probe-&gt;yellow = atof(row[9]);
-    probe-&gt;red = atof(row[10]);
+    probe-&gt;query = dbi_result_get_string_copy(result, &quot;query&quot;);
+    probe-&gt;yellow = dbi_result_get_float(result, &quot;yellow&quot;);
+    probe-&gt;red = dbi_result_get_float(result, &quot;red&quot;);
     if (probe-&gt;msg) g_free(probe-&gt;msg);
     probe-&gt;msg = NULL;
     probe-&gt;seen = 1;
   }
-  mysql_free_result(result);
-  if (mysql_errno(mysql)) {
+  if (dbi_conn_error_flag(conn)) {
+    const char *errmsg;
+    dbi_conn_error(conn, &amp;errmsg);
+    LOG(LOG_ERR, &quot;%s&quot;, errmsg);
     g_hash_table_foreach(cache, reset_seen, NULL);
   } else {
     g_hash_table_foreach_remove(cache, return_seen, NULL);
   }
+  dbi_result_free(result);
 }
 
 void probe(gpointer data, gpointer user_data);
@@ -228,7 +231,7 @@
 void write_results(void)
 {
   int ct  = STACKCT_OPT(OUTPUT);
-  char **output = STACKLST_OPT(OUTPUT);
+  const char **output = STACKLST_OPT(OUTPUT);
   int i;
   xmlDocPtr doc;
 
@@ -256,8 +259,8 @@
   dbuser = probe-&gt;dbuser;
   dbpasswd = probe-&gt;dbpasswd;
 
-  option = 0 ; mysql_options(mysql, MYSQL_OPT_COMPRESS, &amp;option);
-  option = 50; mysql_options(mysql, MYSQL_OPT_CONNECT_TIMEOUT, &amp;option);
+  option = 0 ; mysql_options(mysql, MYSQL_OPT_COMPRESS, (const char *)&amp;option);
+  option = 50; mysql_options(mysql, MYSQL_OPT_CONNECT_TIMEOUT, (const char *)&amp;option);
   gettimeofday(&amp;start, NULL);
   if (!mysql_real_connect(mysql, dbhost, dbuser, dbpasswd, dbname, 0, NULL, 0)) {
     probe-&gt;msg = strdup(mysql_error(mysql));

Modified: upwatch/libdbi/uw_mysql/uw_mysql.def
===================================================================
--- upwatch/libdbi/uw_mysql/uw_mysql.def	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_mysql/uw_mysql.def	2006-07-21 20:34:40 UTC (rev 632)
@@ -15,7 +15,7 @@
 so uw_mysql can process thousands of hosts in a very short period.';
 
 // this section is for the generated specfile
-spec-requires = &quot;/usr/bin/mysql glib2&quot;;
+spec-requires = &quot;libdbi &gt;= 0.8 /usr/bin/mysql glib2&quot;;
 spec-files = `echo &quot;%attr(0770,root,upwatch)&quot; $sbindir/uw_mysql`;
 
 // describe commandline flags

Modified: upwatch/libdbi/uw_mysqlstats/Makefile.am
===================================================================
--- upwatch/libdbi/uw_mysqlstats/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_mysqlstats/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -1,7 +1,9 @@
 include $(top_srcdir)/Makefile.am.path
 
 AM_CFLAGS += -DWITH_THREADS
+if HAVE_LIBMYSQL
 program = uw_mysqlstats
+endif
 sbin_PROGRAMS = $(program)
 man_MANS = uw_mysqlstats.1
 conf_DATA = $(program:%=%.conf)
@@ -9,7 +11,7 @@
 
 uw_mysqlstats_SOURCES = run.c uw_mysqlstats.h uw_mysqlstats.c $(PROBFILES) $(SPECFILES) $(INITFILES)
 uw_mysqlstats_CFLAGS = @MYSQL_CFLAGS@ @LIBGTHREAD2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
-uw_mysqlstats_LDADD = uw_mysqlstats_$(DB_O) uw_mysqlstats_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCHT) @MYSQL_LIBS@ @LIBGTHREAD2_LIBS@
+uw_mysqlstats_LDADD = uw_mysqlstats_$(DB_O) uw_mysqlstats_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCHT) @LIBDBI_LIBS@ @MYSQL_LIBS@ @LIBGTHREAD2_LIBS@
 
 BUILT_SOURCES = $(program:%=%.1) $(program:%=%.h) $(program:%=%.c) $(PROBFILES) $(SPECFILES) $(INITFILES)
 INCLUDES = -I../upwatch

Modified: upwatch/libdbi/uw_mysqlstats/run.c
===================================================================
--- upwatch/libdbi/uw_mysqlstats/run.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_mysqlstats/run.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -2,6 +2,7 @@
 #include &lt;generic.h&gt;
 #include &lt;db.h&gt;
 #include &lt;sys/time.h&gt;
+#include &lt;mysql.h&gt;
 
 #include &quot;uw_mysqlstats.h&quot;
 
@@ -65,13 +66,13 @@
   return(1);
 }
 
-void refresh_database(MYSQL *mysql);
+void refresh_database(dbi_conn conn);
 void run_actual_probes(void);
 void write_results(void);
 
 int run(void)
 {
-  MYSQL *mysql;
+  dbi_conn conn;
 
   if (!cache) {
     cache = g_hash_table_new_full(g_int_hash, g_int_equal, g_free, free_probe);
@@ -79,11 +80,11 @@
   
   LOG(LOG_INFO, &quot;reading info from database (group %u)&quot;, (unsigned)OPT_VALUE_GROUPID); 
   uw_setproctitle(&quot;reading info from database (group %u)&quot;, (unsigned)OPT_VALUE_GROUPID);
-  mysql = open_database(OPT_ARG(DBHOST), OPT_VALUE_DBPORT, OPT_ARG(DBNAME), 
+  conn = open_database(OPT_ARG(DBTYPE), OPT_ARG(DBHOST), OPT_ARG(DBPORT), OPT_ARG(DBNAME), 
 			OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
-  if (mysql) {
-    refresh_database(mysql);
-    close_database(mysql);
+  if (conn) {
+    refresh_database(conn);
+    close_database(conn);
   }
 
   if (g_hash_table_size(cache) &gt; 0) {
@@ -99,10 +100,9 @@
   return(g_hash_table_size(cache));
 }
 
-void refresh_database(MYSQL *mysql)
+void refresh_database(dbi_conn conn)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   char qry[1024];
 
   sprintf(qry,  &quot;SELECT pr_mysqlstats_def.id, pr_mysqlstats_def.domid, pr_mysqlstats_def.tblid, pr_realm.name, &quot;
@@ -114,22 +114,22 @@
                 &quot;       and pr_mysqlstats_def.pgroup = '%d' and pr_realm.id = pr_mysqlstats_def.domid&quot;,
                 (unsigned)OPT_VALUE_GROUPID);
 
-  result = my_query(mysql, 1, qry);
+  result = db_query(conn, 1, qry);
   if (!result) {
     return;
   }
     
-  while ((row = mysql_fetch_row(result))) {
+  while (dbi_result_next_row(result)) {
     int id;
     struct probedef *probe;
 
-    id = atol(row[0]);
+    id = dbi_result_get_uint(result, &quot;id&quot;);
     probe = g_hash_table_lookup(cache, &amp;id);
     if (!probe) {
       probe = g_malloc0(sizeof(struct probedef));
-      if (atoi(row[1]) &gt; 1) {
-        probe-&gt;probeid = atoi(row[2]);
-        probe-&gt;realm = strdup(row[3]);
+      if (dbi_result_get_uint(result, &quot;domid&quot;) &gt; 1) {
+        probe-&gt;probeid = dbi_result_get_uint(result, &quot;tblid&quot;);
+        strcpy(probe-&gt;realm, dbi_result_get_string(result, &quot;name&quot;));
       } else {
         probe-&gt;probeid = probe-&gt;id;
       }
@@ -137,25 +137,28 @@
     }
 
     if (probe-&gt;ipaddress) g_free(probe-&gt;ipaddress);
-    probe-&gt;ipaddress = strdup(row[4]);
+    probe-&gt;ipaddress = dbi_result_get_string_copy(result, &quot;ipaddress&quot;);
     if (probe-&gt;dbname) g_free(probe-&gt;dbname);
-    probe-&gt;dbname = strdup(row[5]);
+    probe-&gt;dbname = dbi_result_get_string_copy(result, &quot;dbname&quot;);
     if (probe-&gt;dbuser) g_free(probe-&gt;dbuser);
-    probe-&gt;dbuser = strdup(row[6]);
+    probe-&gt;dbuser = dbi_result_get_string_copy(result, &quot;dbuser&quot;);
     if (probe-&gt;dbpasswd) g_free(probe-&gt;dbpasswd);
-    probe-&gt;dbpasswd = strdup(row[7]);
-    probe-&gt;yellow = atof(row[8]);
-    probe-&gt;red = atof(row[9]);
+    probe-&gt;dbpasswd = dbi_result_get_string_copy(result, &quot;dbpasswd&quot;);
+    probe-&gt;yellow = dbi_result_get_float(result, &quot;yellow&quot;);
+    probe-&gt;red = dbi_result_get_float(result, &quot;red&quot;);
     if (probe-&gt;msg) g_free(probe-&gt;msg);
     probe-&gt;msg = NULL;
     probe-&gt;seen = 1;
   }
-  mysql_free_result(result);
-  if (mysql_errno(mysql)) {
+  if (dbi_conn_error_flag(conn)) {
+    const char *errmsg;
+    dbi_conn_error(conn, &amp;errmsg);
+    LOG(LOG_ERR, &quot;%s&quot;, errmsg);
     g_hash_table_foreach(cache, reset_seen, NULL);
   } else {
     g_hash_table_foreach_remove(cache, return_seen, NULL);
   }
+  dbi_result_free(result);
 }
 
 void probe(gpointer data, gpointer user_data);
@@ -224,7 +227,7 @@
 void write_results(void)
 {
   int ct  = STACKCT_OPT(OUTPUT);
-  char **output = STACKLST_OPT(OUTPUT);
+  const char **output = STACKLST_OPT(OUTPUT);
   int i;
   xmlDocPtr doc;
 
@@ -263,7 +266,7 @@
   dbpasswd = probe-&gt;dbpasswd;
 
   mysql_options(mysql, MYSQL_OPT_COMPRESS, 0);
-  mysql_options(mysql, MYSQL_OPT_CONNECT_TIMEOUT, &amp;timeout);
+  mysql_options(mysql, MYSQL_OPT_CONNECT_TIMEOUT, (const char *)&amp;timeout);
 
   LOG(LOG_DEBUG, &quot;%s %s %s %s&quot;, dbhost, dbuser, dbpasswd, dbname);
   if (!mysql_real_connect(mysql, dbhost, dbuser, dbpasswd, dbname, 0, NULL, 0)) {

Modified: upwatch/libdbi/uw_mysqlstats/uw_mysqlstats.def
===================================================================
--- upwatch/libdbi/uw_mysqlstats/uw_mysqlstats.def	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_mysqlstats/uw_mysqlstats.def	2006-07-21 20:34:40 UTC (rev 632)
@@ -14,7 +14,7 @@
 server like number of select queries etc.';
 
 // this section is for the generated specfile
-spec-requires = &quot;/usr/bin/mysqlstats glib2&quot;;
+spec-requires = &quot;libdbi &gt;= 0.8 /usr/bin/mysql glib2&quot;;
 spec-files = `echo &quot;%attr(0770,root,upwatch)&quot; $sbindir/uw_mysqlstats`;
 
 // describe commandline flags

Modified: upwatch/libdbi/uw_null/Makefile.am
===================================================================
--- upwatch/libdbi/uw_null/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_null/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -11,7 +11,7 @@
 init_DATA = $(INITFILES)
 
 uw_null_SOURCES = run.c uw_null.h uw_null.c $(SPECFILES) $(INITFILES) 
-uw_null_CFLAGS = @MYSQL_CFLAGS@ @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
+uw_null_CFLAGS = @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
 uw_null_LDADD = uw_null_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) @LIBGLIB2_LIBS@ $(SOLARISLIBS)
 
 BUILT_SOURCES = $(program:%=%.1) $(program:%=%.h) $(program:%=%.c) $(SPECFILES) $(INITFILES)

Modified: upwatch/libdbi/uw_ping/Makefile.am
===================================================================
--- upwatch/libdbi/uw_ping/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_ping/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -7,8 +7,8 @@
 init_DATA = $(INITFILES)
 
 uw_ping_SOURCES = run.c uw_ping.h uw_ping.c $(PROBFILES) $(SPECFILES) $(INITFILES)
-uw_ping_CFLAGS = @LIBGLIB2_CFLAGS@ @MYSQL_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
-uw_ping_LDADD = uw_ping_$(DB_O) uw_ping_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) @MYSQL_LIBS@ @LIBXML2_LIBS@ @LIBGLIB2_LIBS@
+uw_ping_CFLAGS = @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
+uw_ping_LDADD = uw_ping_$(DB_O) uw_ping_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) @LIBDBI_LIBS@ @LIBXML2_LIBS@ @LIBGLIB2_LIBS@
 
 BUILT_SOURCES = $(program:%=%.1) $(program:%=%.h) $(program:%=%.c) $(PROBFILES) $(SPECFILES) $(INITFILES)
 INCLUDES = -I../upwatch

Modified: upwatch/libdbi/uw_ping/run.c
===================================================================
--- upwatch/libdbi/uw_ping/run.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_ping/run.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -112,13 +112,13 @@
   return(1);
 }
 
-void refresh_database(MYSQL *mysql);
+void refresh_database(dbi_conn conn);
 void run_actual_probes(void);
 void write_results(void);
 
 int run(void)
 {
-  MYSQL *mysql;
+  dbi_conn conn;
 
   if ((pktno &gt;&gt; 16) &gt; (getpid() &amp; 0xffff) + 10) {
     pktno = (getpid() &amp; 0xffff) &lt;&lt; 16;
@@ -130,11 +130,11 @@
   
   LOG(LOG_INFO, &quot;reading info from database&quot;);
   uw_setproctitle(&quot;reading info from database&quot;);
-  mysql = open_database(OPT_ARG(DBHOST), OPT_VALUE_DBPORT, OPT_ARG(DBNAME), 
+  conn = open_database(OPT_ARG(DBTYPE), OPT_ARG(DBHOST), OPT_ARG(DBPORT), OPT_ARG(DBNAME), 
 			OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
-  if (mysql) {
-    refresh_database(mysql);
-    close_database(mysql);
+  if (conn) {
+    refresh_database(conn);
+    close_database(conn);
   }
 
   if (g_hash_table_size(cache) &gt; 0) {
@@ -150,10 +150,9 @@
   return(g_hash_table_size(cache));
 }
 
-void refresh_database(MYSQL *mysql)
+void refresh_database(dbi_conn conn)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   char qry[1024];
 
   sprintf(qry,  &quot;SELECT pr_ping_def.id, pr_ping_def.domid, pr_ping_def.tblid, pr_realm.name, &quot;
@@ -164,23 +163,23 @@
                 &quot;       and pr_ping_def.pgroup = '%d' and pr_realm.id = pr_ping_def.domid&quot;,
                 (unsigned)OPT_VALUE_GROUPID);
 
-  result = my_query(mysql, 1, qry);
+  result = db_query(conn, 1, qry);
   if (!result) {
     return;
   }
     
-  while ((row = mysql_fetch_row(result))) {
+  while (dbi_result_next_row(result)) {
     int id;
     struct probedef *probe;
 
-    id = atol(row[0]);
+    id = dbi_result_get_uint(result, &quot;id&quot;);
     probe = g_hash_table_lookup(cache, &amp;id);
     if (!probe) {
       probe = g_malloc0(sizeof(struct probedef));
       probe-&gt;id = id;
-      if (atoi(row[1]) &gt; 1) {
-        probe-&gt;probeid = atoi(row[2]);
-        probe-&gt;realm = strdup(row[3]);
+      if (dbi_result_get_uint(result, &quot;domid&quot;) &gt; 1) {
+        probe-&gt;probeid = dbi_result_get_uint(result, &quot;tblid&quot;);
+        strcpy(probe-&gt;realm, dbi_result_get_string(result, &quot;name&quot;));
       } else {
         probe-&gt;probeid = probe-&gt;id;
       }
@@ -188,21 +187,24 @@
     }
 
     if (probe-&gt;ipaddress) g_free(probe-&gt;ipaddress);
-    probe-&gt;ipaddress = strdup(row[4]);
-    probe-&gt;count = atoi(row[5]);
+    probe-&gt;ipaddress = dbi_result_get_string_copy(result, &quot;ipaddress&quot;);
+    probe-&gt;count = dbi_result_get_uint(result, &quot;count&quot;);
     if (probe-&gt;count &gt; 30) probe-&gt;count = 30;
-    probe-&gt;yellow = atof(row[6]);
-    probe-&gt;red = atof(row[7]);
+    probe-&gt;yellow = dbi_result_get_float(result, &quot;yellow&quot;);
+    probe-&gt;red = dbi_result_get_float(result, &quot;red&quot;);
     if (probe-&gt;msg) g_free(probe-&gt;msg);
     probe-&gt;msg = NULL;
     probe-&gt;seen = 1;
   }
-  mysql_free_result(result);
-  if (mysql_errno(mysql)) {
+  if (dbi_conn_error_flag(conn)) {
+    char *errmsg;
+    dbi_conn_error(conn, &amp;errmsg);
+    LOG(LOG_ERR, &quot;%s&quot;, errmsg);
     g_hash_table_foreach(cache, reset_seen, NULL);
   } else {
     g_hash_table_foreach_remove(cache, return_seen, NULL);
   }
+  dbi_result_free(result);
 }
 
 void write_probe(gpointer key, gpointer value, gpointer user_data)

Modified: upwatch/libdbi/uw_ping/uw_ping.def
===================================================================
--- upwatch/libdbi/uw_ping/uw_ping.def	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_ping/uw_ping.def	2006-07-21 20:34:40 UTC (rev 632)
@@ -15,7 +15,7 @@
 process thousands of hosts in a very short period.';
 
 // this section is for the generated specfile
-spec-requires = &quot;/usr/bin/mysql glib2&quot;;
+spec-requires = &quot;libdbi &gt;= 0.8 glib2&quot;;
 spec-files = `echo &quot;%attr(4770,root,upwatch)&quot; $sbindir/uw_ping`;
 
 // describe commandline flags

Modified: upwatch/libdbi/uw_pop3/Makefile.am
===================================================================
--- upwatch/libdbi/uw_pop3/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_pop3/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -8,8 +8,8 @@
 init_DATA = $(INITFILES)
 
 uw_pop3_SOURCES = run.c uw_pop3.h uw_pop3.c  $(PROBFILES) $(SPECFILES) $(INITFILES)
-uw_pop3_CFLAGS = @MYSQL_CFLAGS@ @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
-uw_pop3_LDADD = uw_pop3_$(DB_O) uw_pop3_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) $(LIBST) @MYSQL_LIBS@ @LIBGLIB2_LIBS@
+uw_pop3_CFLAGS = @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
+uw_pop3_LDADD = uw_pop3_$(DB_O) uw_pop3_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) $(LIBST) @LIBDBI_LIBS@ @LIBGLIB2_LIBS@
 
 BUILT_SOURCES = $(program:%=%.1) $(program:%=%.h) $(program:%=%.c) $(PROBFILES) $(SPECFILES) $(INITFILES)
 INCLUDES = -I../upwatch

Modified: upwatch/libdbi/uw_pop3/run.c
===================================================================
--- upwatch/libdbi/uw_pop3/run.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_pop3/run.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -68,13 +68,13 @@
   return(1);
 }
 
-void refresh_database(MYSQL *mysql);
+void refresh_database(dbi_conn conn);
 void run_actual_probes(void);
 void write_results(void);
 
 int run(void)
 {
-  MYSQL *mysql;
+  dbi_conn conn;
 
   if (!cache) {
     cache = g_hash_table_new_full(g_int_hash, g_int_equal, g_free, free_probe);
@@ -82,11 +82,11 @@
   
   LOG(LOG_INFO, &quot;reading info from database&quot;);
   uw_setproctitle(&quot;reading info from database&quot;);
-  mysql = open_database(OPT_ARG(DBHOST), OPT_VALUE_DBPORT, OPT_ARG(DBNAME), 
+  conn = open_database(OPT_ARG(DBTYPE), OPT_ARG(DBHOST), OPT_ARG(DBPORT), OPT_ARG(DBNAME), 
 			OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
-  if (mysql) {
-    refresh_database(mysql);
-    close_database(mysql);
+  if (conn) {
+    refresh_database(conn);
+    close_database(conn);
   }
 
   if (g_hash_table_size(cache) &gt; 0) {
@@ -102,10 +102,9 @@
   return(g_hash_table_size(cache));
 }
 
-void refresh_database(MYSQL *mysql)
+void refresh_database(dbi_conn conn)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   char qry[1024];
 
   sprintf(qry,  &quot;SELECT pr_pop3_def.id, pr_pop3_def.domid, pr_pop3_def.tblid, pr_realm.name, &quot;
@@ -117,22 +116,22 @@
                 &quot;       and pr_pop3_def.pgroup = '%d' and pr_realm.id = pr_pop3_def.domid&quot;,
                 (unsigned)OPT_VALUE_GROUPID);
 
-  result = my_query(mysql, 1, qry);
+  result = db_query(conn, 1, qry);
   if (!result) {
     return;
   }
     
-  while ((row = mysql_fetch_row(result))) {
+  while (dbi_result_next_row(result)) {
     int id;
     struct probedef *probe;
 
-    id = atol(row[0]);
+    id = dbi_result_get_uint(result, &quot;id&quot;);
     probe = g_hash_table_lookup(cache, &amp;id);
     if (!probe) {
       probe = g_malloc0(sizeof(struct probedef));
-      if (atoi(row[1]) &gt; 1) {
-        probe-&gt;probeid = atoi(row[2]);
-        probe-&gt;realm = strdup(row[3]);
+      if (dbi_result_get_uint(result, &quot;domid&quot;) &gt; 1) {
+        probe-&gt;probeid = dbi_result_get_uint(result, &quot;tblid&quot;);
+        strcpy(probe-&gt;realm, dbi_result_get_string(result, &quot;name&quot;));
       } else {
         probe-&gt;probeid = probe-&gt;id;
       }
@@ -140,23 +139,26 @@
     }
 
     if (probe-&gt;ipaddress) g_free(probe-&gt;ipaddress);
-    probe-&gt;ipaddress = strdup(row[4]);
+    probe-&gt;ipaddress = dbi_result_get_string_copy(result, &quot;ipaddress&quot;);
     if (probe-&gt;username) g_free(probe-&gt;username);
-    probe-&gt;username = strdup(row[5]);
+    probe-&gt;username = dbi_result_get_string_copy(result, &quot;username&quot;);
     if (probe-&gt;password) g_free(probe-&gt;password);
-    probe-&gt;password = strdup(row[6]);
-    probe-&gt;yellow = atof(row[7]);
-    probe-&gt;red = atof(row[8]);
+    probe-&gt;password = dbi_result_get_string_copy(result, &quot;password&quot;);
+    probe-&gt;yellow = dbi_result_get_float(result, &quot;yellow&quot;);
+    probe-&gt;red = dbi_result_get_float(result, &quot;red&quot;);
     if (probe-&gt;msg) g_free(probe-&gt;msg);
     probe-&gt;msg = NULL;
     probe-&gt;seen = 1;
   }
-  mysql_free_result(result);
-  if (mysql_errno(mysql)) {
+  if (dbi_conn_error_flag(conn)) {
+    const char *errmsg;
+    dbi_conn_error(conn, &amp;errmsg);
+    LOG(LOG_ERR, &quot;%s&quot;, errmsg);
     g_hash_table_foreach(cache, reset_seen, NULL);
   } else {
     g_hash_table_foreach_remove(cache, return_seen, NULL);
   }
+  dbi_result_free(result);
 }
 
 void *probe(void *user_data); 

Modified: upwatch/libdbi/uw_pop3/uw_pop3.def
===================================================================
--- upwatch/libdbi/uw_pop3/uw_pop3.def	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_pop3/uw_pop3.def	2006-07-21 20:34:40 UTC (rev 632)
@@ -15,7 +15,7 @@
 so uw_pop3 can process thousands of hosts in a very short period.';
 
 // this section is for the generated specfile
-spec-requires = &quot;/usr/bin/mysql glib2&quot;;
+spec-requires = &quot;libdbi &gt;= 0.8 glib2&quot;;
 spec-files = `echo &quot;%attr(0770,root,upwatch)&quot; $sbindir/uw_pop3`;
 
 // describe commandline flags

Modified: upwatch/libdbi/uw_postgresql/Makefile.am
===================================================================
--- upwatch/libdbi/uw_postgresql/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_postgresql/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -8,8 +8,8 @@
 init_DATA = $(INITFILES)
 
 uw_postgresql_SOURCES = run.c uw_postgresql.h uw_postgresql.c $(PROBFILES) $(SPECFILES) $(INITFILES)
-uw_postgresql_CFLAGS = @MYSQL_CFLAGS@ @LIBGTHREAD2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBPQ_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
-uw_postgresql_LDADD = uw_postgresql_$(DB_O) uw_postgresql_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCHT) @MYSQL_LIBS@ @LIBGTHREAD2_LIBS@ @LIBPQ_LIBS@
+uw_postgresql_CFLAGS = @LIBGTHREAD2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBPQ_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
+uw_postgresql_LDADD = uw_postgresql_$(DB_O) uw_postgresql_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCHT) @LIBDBI_LIBS@ @LIBGTHREAD2_LIBS@ @LIBPQ_LIBS@
 
 BUILT_SOURCES = $(program:%=%.1) $(program:%=%.h) $(program:%=%.c) $(PROBFILES) $(SPECFILES) $(INITFILES)
 INCLUDES = -I../upwatch

Modified: upwatch/libdbi/uw_postgresql/run.c
===================================================================
--- upwatch/libdbi/uw_postgresql/run.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_postgresql/run.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -64,13 +64,13 @@
   return(1);
 }
 
-void refresh_database(MYSQL *mysql);
+void refresh_database(dbi_conn conn);
 void run_actual_probes(void);
 void write_results(void);
 
 int run(void)
 {
-  MYSQL *mysql;
+  dbi_conn conn;
 
   if (!cache) {
     cache = g_hash_table_new_full(g_int_hash, g_int_equal, g_free, free_probe);
@@ -78,11 +78,11 @@
   
   LOG(LOG_INFO, &quot;reading info from database&quot;);
   uw_setproctitle(&quot;reading info from database&quot;);
-  mysql = open_database(OPT_ARG(DBHOST), OPT_VALUE_DBPORT, OPT_ARG(DBNAME), 
+  conn = open_database(OPT_ARG(DBTYPE), OPT_ARG(DBHOST), OPT_ARG(DBPORT), OPT_ARG(DBNAME), 
 			OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
-  if (mysql) {
-    refresh_database(mysql);
-    close_database(mysql);
+  if (conn) {
+    refresh_database(conn);
+    close_database(conn);
   }
 
   if (g_hash_table_size(cache) &gt; 0) {
@@ -98,10 +98,9 @@
   return(g_hash_table_size(cache));
 }
 
-void refresh_database(MYSQL *mysql)
+void refresh_database(dbi_conn conn)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   char qry[1024];
 
   sprintf(qry,  &quot;SELECT pr_postgresql_def.id, pr_postgresql_def.domid, pr_postgresql_def.tblid, pr_realm.name, &quot;
@@ -114,22 +113,22 @@
                 &quot;       and pr_postgresql_def.pgroup = '%d' and pr_realm.id = pr_postgresql_def.domid&quot;,
                 (unsigned)OPT_VALUE_GROUPID);
 
-  result = my_query(mysql, 1, qry);
+  result = db_query(conn, 1, qry);
   if (!result) {
     return;
   }
     
-  while ((row = mysql_fetch_row(result))) {
+  while (dbi_result_next_row(result)) {
     int id;
     struct probedef *probe;
 
-    id = atol(row[0]);
+    id = dbi_result_get_uint(result, &quot;id&quot;);
     probe = g_hash_table_lookup(cache, &amp;id);
     if (!probe) {
       probe = g_malloc0(sizeof(struct probedef));
-      if (atoi(row[1]) &gt; 1) {
-        probe-&gt;probeid = atoi(row[2]);
-        probe-&gt;realm = strdup(row[3]);
+      if (dbi_result_get_uint(result, &quot;domid&quot;) &gt; 1) {
+        probe-&gt;probeid = dbi_result_get_uint(result, &quot;tblid&quot;);
+        strcpy(probe-&gt;realm, dbi_result_get_string(result, &quot;name&quot;));
       } else {
         probe-&gt;probeid = probe-&gt;id;
       }
@@ -137,27 +136,30 @@
     }
 
     if (probe-&gt;ipaddress) g_free(probe-&gt;ipaddress);
-    probe-&gt;ipaddress = strdup(row[4]);
+    probe-&gt;ipaddress = dbi_result_get_string_copy(result, &quot;ipaddress&quot;);
     if (probe-&gt;dbname) g_free(probe-&gt;dbname);
-    probe-&gt;dbname = strdup(row[5]);
+    probe-&gt;dbname = dbi_result_get_string_copy(result, &quot;dbname&quot;);
     if (probe-&gt;dbuser) g_free(probe-&gt;dbuser);
-    probe-&gt;dbuser = strdup(row[6]);
+    probe-&gt;dbuser = dbi_result_get_string_copy(result, &quot;dbuser&quot;);
     if (probe-&gt;dbpasswd) g_free(probe-&gt;dbpasswd);
-    probe-&gt;dbpasswd = strdup(row[7]);
+    probe-&gt;dbpasswd = dbi_result_get_string_copy(result, &quot;dbpasswd&quot;);
     if (probe-&gt;query) g_free(probe-&gt;query);
-    probe-&gt;query = strdup(row[8]);
-    probe-&gt;yellow = atof(row[9]);
-    probe-&gt;red = atof(row[10]);
+    probe-&gt;query = dbi_result_get_string_copy(result, &quot;query&quot;);
+    probe-&gt;yellow = dbi_result_get_float(result, &quot;yellow&quot;);
+    probe-&gt;red = dbi_result_get_float(result, &quot;red&quot;);
     if (probe-&gt;msg) g_free(probe-&gt;msg);
     probe-&gt;msg = NULL;
     probe-&gt;seen = 1;
   }
-  mysql_free_result(result);
-  if (mysql_errno(mysql)) {
+  if (dbi_conn_error_flag(conn)) {
+    const char *errmsg;
+    dbi_conn_error(conn, &amp;errmsg);
+    LOG(LOG_ERR, &quot;%s&quot;, errmsg);
     g_hash_table_foreach(cache, reset_seen, NULL);
   } else {
     g_hash_table_foreach_remove(cache, return_seen, NULL);
   }
+  dbi_result_free(result);
 }
 
 void probe(gpointer data, gpointer user_data);
@@ -230,7 +232,7 @@
 void write_results(void)
 {
   int ct  = STACKCT_OPT(OUTPUT);
-  char **output = STACKLST_OPT(OUTPUT);
+  const char **output = STACKLST_OPT(OUTPUT);
   int i;
   xmlDocPtr doc;
 

Modified: upwatch/libdbi/uw_postgresql/uw_postgresql.def
===================================================================
--- upwatch/libdbi/uw_postgresql/uw_postgresql.def	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_postgresql/uw_postgresql.def	2006-07-21 20:34:40 UTC (rev 632)
@@ -15,7 +15,7 @@
 so uw_postgresql can process thousands of hosts in a very short period.';
 
 // this section is for the generated specfile
-spec-requires = &quot;/usr/bin/mysql postgresql-libs glib2&quot;;
+spec-requires = &quot;libdbi &gt;= 0.8 postgresql-libs glib2&quot;;
 spec-files = `echo &quot;%attr(0770,root,upwatch)&quot; $sbindir/uw_postgresql`;
 
 // describe commandline flags

Modified: upwatch/libdbi/uw_process/Makefile.am
===================================================================
--- upwatch/libdbi/uw_process/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -33,9 +33,9 @@
  ping.c httpget.c iptraf.c sysstat.c mysql.c mysqlstats.c bb_cpu.c bb.c pop3.c smtp.c tcpconnect.c \
 $(USE_LIBPQ) $(USE_LIBSNMP) $(USE_LIBTDS) imap.c errlog.c diskfree.c hwstat.c \
  uw_process.h uw_process_glob.h modules.inc $(SPECFILES) $(INITFILES)
-uw_process_CFLAGS = @MYSQL_CFLAGS@ @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS) \
+uw_process_CFLAGS = @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS) \
   $(DEF_LIBPQ) $(DEF_LIBSNMP) $(DEF_LIBTDS) $(DEF_LIBESMTP) 
-uw_process_LDADD = uw_process_$(DB_O) uw_process_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) @MYSQL_LIBS@ \
+uw_process_LDADD = uw_process_$(DB_O) uw_process_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) @LIBDBI_LIBS@ \
   @LIBESMTP_LIBS@ @LIBGLIB2_LIBS@ @LIBXML2_LIBS@ $(SOLARISLIBS)
 
 BUILT_SOURCES = $(program:%=%.1) $(program:%=%.h) $(program:%=%.c) $(SPECFILES) $(INITFILES) ../probes.enum

Modified: upwatch/libdbi/uw_process/bb_cpu.c
===================================================================
--- upwatch/libdbi/uw_process/bb_cpu.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/bb_cpu.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -32,31 +32,34 @@
 //*******************************************************************
 static gint bb_cpu_store_raw_result(trx *t)
 {
-  MYSQL_RES *result;
+  dbi_result result;
   struct bb_cpu_result *res = (struct bb_cpu_result *)t-&gt;res;
   struct probe_def *def = (struct probe_def *)t-&gt;def;
   char *escmsg;
+  const char *errmsg;
+  int lasterr;
 
   if (t-&gt;res-&gt;color == STAT_PURPLE) return 1;
   t-&gt;seen_before = FALSE;
   if (res-&gt;message) {
-    escmsg = g_malloc(strlen(res-&gt;message) * 2 + 1);
-    mysql_real_escape_string(t-&gt;probe-&gt;db, escmsg, res-&gt;message, strlen(res-&gt;message)) ;
+    escmsg = strdup(res-&gt;message);
+    dbi_conn_quote_string(t-&gt;probe-&gt;db, &amp;escmsg);
   } else {
     escmsg = strdup(&quot;&quot;);
   }
     
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;insert into pr_bb_cpu_raw &quot;
                     &quot;set    probe = '%u', stattime = '%u', color = '%u', loadavg = '%f', &quot;
                     &quot;       user = '%u',  idle = '%u', free = '%u', used = '%u', message = '%s'&quot;,
                     def-&gt;probeid, res-&gt;stattime, res-&gt;color, res-&gt;loadavg,
                     res-&gt;user, res-&gt;idle, res-&gt;free, res-&gt;used, escmsg);
   g_free(escmsg);
-  if (result) mysql_free_result(result);
-  if (mysql_errno(t-&gt;probe-&gt;db) == ER_DUP_ENTRY) {
+  if (result) dbi_result_free(result);
+  lasterr = dbi_conn_error(t-&gt;probe-&gt;db, &amp;errmsg);
+  if (errmsg &amp;&amp; (lasterr == 1062)) { // MySQL ER_DUP_ENTRY(1062)
     t-&gt;seen_before = TRUE;
-  } else if (mysql_errno(t-&gt;probe-&gt;db)) {
+  } else if (lasterr &gt; -1) { // otther error
     return 0; // other failure
   }
   return 1; // success
@@ -67,8 +70,7 @@
 //*******************************************************************
 static void bb_cpu_summarize(trx *t, char *from, char *into, guint slot, guint slotlow, guint slothigh, gint resummarize)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   struct probe_def *def = (struct probe_def *)t-&gt;def;
   float avg_yellow, avg_red;
   gfloat avg_loadavg;
@@ -79,56 +81,57 @@
 
   stattime = slotlow + ((slothigh-slotlow)/2);
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
-                    &quot;select avg(loadavg), avg(user), avg(system), avg(idle), &quot;
-                    &quot;       avg(swapped), avg(free), avg(buffered), avg(cached), &quot;
-                    &quot;       avg(used), max(color), avg(yellow), avg(red) &quot; 
+  result = db_query(t-&gt;probe-&gt;db, 0,
+                    &quot;select avg(loadavg) as avg_loadavg, avg(user) as avg_user, avg(system) as avg_system, &quot;
+                    &quot;       avg(idle) as avg_idle, avg(swapped) avg_swapped, avg(free) as avg_free, &quot; 
+                    &quot;       avg(buffered) as avg_buffered, avg(cached) as avg_cached, &quot;
+                    &quot;       avg(used) as avg_used, max(color) as max_color, &quot;
+                    &quot;       avg(yellow) as avg_yellow, avg(red) as avg_red &quot; 
                     &quot;from   pr_bb_cpu_%s use index(probstat) &quot;
                     &quot;where  probe = '%d' and stattime &gt;= %d and stattime &lt; %d&quot;,
                     from, def-&gt;probeid, slotlow, slothigh);
   
   if (!result) return;
-  if (mysql_num_rows(result) == 0) { // no records found
+  if (dbi_result_get_numrows(result) == 0) { // no records found
     LOG(LOG_NOTICE, &quot;nothing to summarize from %s for probe %u %u %u&quot;,
                        from, def-&gt;probeid, slotlow, slothigh);
-    mysql_free_result(result);
+    dbi_result_free(result);
     return;
   }
 
-  row = mysql_fetch_row(result);
-  if (!row) {
-    mysql_free_result(result);
+  if (!dbi_result_next_row(result)) {
+    dbi_result_free(result);
     return;
   }
-  if (row[0] == NULL) {
+  if (dbi_result_get_string(result, &quot;avg_loadavg&quot;) == NULL) {
     LOG(LOG_NOTICE, &quot;nothing to summarize from %s for probe %u %u %u&quot;, 
                        from, def-&gt;probeid, slotlow, slothigh);
-    mysql_free_result(result);
+    dbi_result_free(result);
     return;
   }
 
-  avg_loadavg = atof(row[0]);
-  avg_user    = atoi(row[1]);
-  avg_system  = atoi(row[2]);
-  avg_idle    = atoi(row[3]);
-  avg_swapped = atoi(row[4]);
-  avg_free    = atoi(row[5]);
-  avg_buffered= atoi(row[6]);
-  avg_cached  = atoi(row[7]);
-  avg_used    = atoi(row[8]);
-  max_color   = atoi(row[9]);
-  avg_yellow  = atof(row[10]);
-  avg_red     = atof(row[11]);
-  mysql_free_result(result);
+  avg_loadavg = dbi_result_get_float(result, &quot;avg_loadavg&quot;);
+  avg_user    = dbi_result_get_uint(result, &quot;avg_user&quot;);
+  avg_system  = dbi_result_get_uint(result, &quot;avg_system&quot;);
+  avg_idle    = dbi_result_get_uint(result, &quot;avg_idle&quot;);
+  avg_swapped = dbi_result_get_uint(result, &quot;avg_swapped&quot;);
+  avg_free    = dbi_result_get_uint(result, &quot;avg_free&quot;);
+  avg_buffered= dbi_result_get_uint(result, &quot;avg_buffered&quot;);
+  avg_cached  = dbi_result_get_uint(result, &quot;avg_cached&quot;);
+  avg_used    = dbi_result_get_uint(result, &quot;avg_used&quot;);
+  max_color   = dbi_result_get_uint(result, &quot;max_color&quot;);
+  avg_yellow  = dbi_result_get_float(result, &quot;avg_yellow&quot;);
+  avg_red     = dbi_result_get_float(result, &quot;avg_red&quot;);
+  dbi_result_free(result);
 
   if (resummarize) {
     // delete old values
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;delete from pr_bb_cpu_%s where probe = '%u' and stattime = '%u'&quot;,
                     into, def-&gt;probeid, stattime);
-    mysql_free_result(result);
+    dbi_result_free(result);
   }
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;insert into pr_bb_cpu_%s &quot; 
                     &quot;set    loadavg = '%f', user = '%u', system = '%u', idle = '%u', &quot;
                     &quot;       swapped = '%u', free = '%u', buffered = '%u', cached = '%u', &quot;
@@ -139,7 +142,7 @@
                     avg_swapped, avg_free, avg_buffered, avg_cached, 
                     avg_used, def-&gt;probeid, max_color, stattime,
                     avg_yellow, avg_red, slot);
-  mysql_free_result(result);
+  dbi_result_free(result);
 }
 
 module bb_cpu_module  = {

Modified: upwatch/libdbi/uw_process/generic_ct.c
===================================================================
--- upwatch/libdbi/uw_process/generic_ct.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/generic_ct.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -19,22 +19,24 @@
 //*******************************************************************
 gint ct_store_raw_result(trx *t)
 {
-  MYSQL_RES *result;
+  dbi_result result;
   struct ct_result *res = (struct ct_result *)t-&gt;res;
   struct probe_def *def = (struct probe_def *)t-&gt;def;
   char *escmsg;
+  const char *errmsg;
+  int lasterr;
 
   if (t-&gt;res-&gt;color == STAT_PURPLE) return 1;
 
   t-&gt;seen_before = FALSE;
   if (res-&gt;message) {
-    escmsg = g_malloc(strlen(res-&gt;message) * 2 + 1);
-    mysql_real_escape_string(t-&gt;probe-&gt;db, escmsg, res-&gt;message, strlen(res-&gt;message)) ;
+    escmsg = strdup(res-&gt;message);
+    dbi_conn_quote_string(t-&gt;probe-&gt;db, &amp;escmsg);
   } else {
     escmsg = strdup(&quot;&quot;);
   }
     
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;insert into pr_%s_raw &quot;
                     &quot;set    probe = '%u', yellow = '%f', red = '%f', stattime = '%u', color = '%u', &quot;
                     &quot;       connect = '%f', total = '%f', &quot;
@@ -42,10 +44,11 @@
                     res-&gt;name, def-&gt;probeid, def-&gt;yellow, def-&gt;red, res-&gt;stattime, res-&gt;color, 
                     res-&gt;connect, res-&gt;total, escmsg);
   g_free(escmsg);
-  if (result) mysql_free_result(result);
-  if (mysql_errno(t-&gt;probe-&gt;db) == ER_DUP_ENTRY) {
+  if (result) dbi_result_free(result);
+  lasterr = dbi_conn_error(t-&gt;probe-&gt;db, &amp;errmsg);
+  if (errmsg &amp;&amp; (lasterr == 1062)) { // MySQL ER_DUP_ENTRY(1062)
     t-&gt;seen_before = TRUE;
-  } else if (mysql_errno(t-&gt;probe-&gt;db)) {
+  } else if (lasterr &gt; -1) { // otther error
     return 0; // other failure
   }
   return 1; // success
@@ -56,8 +59,7 @@
 //*******************************************************************
 void ct_summarize(trx *t, char *from, char *into, guint slot, guint slotlow, guint slothigh, gint resummarize)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   struct ct_result *res = (struct ct_result *)t-&gt;res;
   struct probe_def *def = (struct probe_def *)t-&gt;def;
   float avg_yellow, avg_red;
@@ -67,49 +69,48 @@
 
   stattime = slotlow + ((slothigh-slotlow)/2);
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
-                    &quot;select avg(connect), avg(total), &quot;
-                    &quot;       max(color), avg(yellow), avg(red) &quot;
+  result = db_query(t-&gt;probe-&gt;db, 0,
+                    &quot;select avg(connect) as avg_connect, avg(total) as avg_total, &quot;
+                    &quot;       max(color) as max_color, avg(yellow) as avg_yellow, avg(red) as avg_red &quot;
                     &quot;from   pr_%s_%s use index(probstat) &quot;
                     &quot;where  probe = '%d' and stattime &gt;= %d and stattime &lt; %d&quot;,
                     res-&gt;name, from, def-&gt;probeid, slotlow, slothigh);
 
   if (!result) return;
-  if (mysql_num_rows(result) == 0) { // no records found
+  if (dbi_result_get_numrows(result) == 0) { // no records found
     LOG(LOG_NOTICE, &quot;nothing to summarize from %s for probe %u %u %u&quot;,
                        from, def-&gt;probeid, slotlow, slothigh);
-    mysql_free_result(result);
+    dbi_result_free(result);
     return;
   }
 
-  row = mysql_fetch_row(result);
-  if (!row) {
-    mysql_free_result(result);
+  if (!dbi_result_next_row(result)) {
+    dbi_result_free(result);
     return;
   }
-  if (row[0] == NULL) {
+  if (dbi_result_get_string(result, &quot;avg_connect&quot;) == NULL) {
     LOG(LOG_NOTICE, &quot;nothing to summarize from %s for probe %u %u %u&quot;, 
                        from, def-&gt;probeid, slotlow, slothigh);
-    mysql_free_result(result);
+    dbi_result_free(result);
     return;
   }
 
-  avg_connect = atof(row[0]);
-  avg_total = atof(row[1]);
-  max_color   = atoi(row[2]);
-  avg_yellow  = atof(row[3]);
-  avg_red     = atof(row[4]);
-  mysql_free_result(result);
+  avg_connect = dbi_result_get_float(result, &quot;avg_connect&quot;);
+  avg_total = dbi_result_get_float(result, &quot;avg_total&quot;);
+  max_color   = dbi_result_get_uint(result, &quot;max_color&quot;);
+  avg_yellow  = dbi_result_get_float(result, &quot;avg_yellow&quot;);
+  avg_red     = dbi_result_get_float(result, &quot;avg_red&quot;);
+  dbi_result_free(result);
 
   if (resummarize) {
     // delete old values
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;delete from pr_%s_%s where probe = '%u' and stattime = '%u'&quot;,
                     res-&gt;name, into, def-&gt;probeid, stattime);
-    mysql_free_result(result);
+    dbi_result_free(result);
   }
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;insert into pr_%s_%s &quot;
                     &quot;set    connect = '%f', total = '%f', &quot;
                     &quot;       probe = %d, color = '%u', stattime = %d, &quot;
@@ -117,6 +118,6 @@
                     res-&gt;name, into, avg_connect, avg_total, def-&gt;probeid, 
                     max_color, stattime, avg_yellow, avg_red, slot);
 
-  mysql_free_result(result);
+  dbi_result_free(result);
 }
 

Modified: upwatch/libdbi/uw_process/httpget.c
===================================================================
--- upwatch/libdbi/uw_process/httpget.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/httpget.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -13,21 +13,23 @@
 //*******************************************************************
 static gint httpget_store_raw_result(trx *t)
 {
-  MYSQL_RES *result;
+  dbi_result result;
   struct httpget_result *res = (struct httpget_result *)t-&gt;res;
   struct probe_def *def = (struct probe_def *)t-&gt;def;
   char *escmsg;
+  const char *errmsg;
+  int lasterr;
 
   if (t-&gt;res-&gt;color == STAT_PURPLE) return 1;
   t-&gt;seen_before = FALSE;
   if (res-&gt;message) {
-    escmsg = g_malloc(strlen(res-&gt;message) * 2 + 1);
-    mysql_real_escape_string(t-&gt;probe-&gt;db, escmsg, res-&gt;message, strlen(res-&gt;message)) ;
+    escmsg = strdup(res-&gt;message);
+    dbi_conn_quote_string(t-&gt;probe-&gt;db, &amp;escmsg);
   } else {
     escmsg = strdup(&quot;&quot;);
   }
     
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;insert into pr_httpget_raw &quot;
                     &quot;set    probe = '%u', yellow = '%f', red = '%f', stattime = '%u', color = '%u', &quot;
                     &quot;       lookup = '%f', connect = '%f', pretransfer = '%f', total = '%f', &quot;
@@ -35,10 +37,11 @@
                     def-&gt;probeid, def-&gt;yellow, def-&gt;red, res-&gt;stattime, res-&gt;color, 
                     res-&gt;lookup, res-&gt;connect, res-&gt;pretransfer, res-&gt;total, escmsg);
   g_free(escmsg);
-  if (result) mysql_free_result(result);
-  if (mysql_errno(t-&gt;probe-&gt;db) == ER_DUP_ENTRY) {
+  if (result) dbi_result_free(result);
+  lasterr = dbi_conn_error(t-&gt;probe-&gt;db, &amp;errmsg);
+  if (errmsg &amp;&amp; (lasterr == 1062)) { // MySQL ER_DUP_ENTRY(1062)
     t-&gt;seen_before = TRUE;
-  } else if (mysql_errno(t-&gt;probe-&gt;db)) {
+  } else if (lasterr &gt; -1) { // otther error
     return 0; // other failure
   }
   return 1; // success
@@ -49,8 +52,7 @@
 //*******************************************************************
 static void httpget_summarize(trx *t, char *from, char *into, guint slot, guint slotlow, guint slothigh, gint resummarize)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   struct probe_def *def = (struct probe_def *)t-&gt;def;
   float avg_yellow, avg_red;
   float avg_lookup, avg_connect, avg_pretransfer, avg_total;
@@ -59,51 +61,51 @@
 
   stattime = slotlow + ((slothigh-slotlow)/2);
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
-                    &quot;select avg(lookup), avg(connect), avg(pretransfer), avg(total), &quot;
-                    &quot;       max(color), avg(yellow), avg(red) &quot;
+  result = db_query(t-&gt;probe-&gt;db, 0,
+                    &quot;select avg(lookup) as avg_lookup, avg(connect) as avg_connect, &quot;
+                    &quot;       avg(pretransfer) as avg_pretransfer, avg(total) as avg_total, &quot;
+                    &quot;       max(color) as max_color, avg(yellow) avg_yellow, avg(red) as avg_red &quot;
                     &quot;from   pr_httpget_%s use index(probstat) &quot;
                     &quot;where  probe = '%d' and stattime &gt;= %d and stattime &lt; %d&quot;,
                     from, def-&gt;probeid, slotlow, slothigh);
 
   if (!result) return;
-  if (mysql_num_rows(result) == 0) { // no records found
+  if (dbi_result_get_numrows(result) == 0) { // no records found
     LOG(LOG_NOTICE, &quot;nothing to summarize from %s for probe %u %u %u&quot;,
                        from, def-&gt;probeid, slotlow, slothigh);
-    mysql_free_result(result);
+    dbi_result_free(result);
     return;
   }
 
-  row = mysql_fetch_row(result);
-  if (!row) {
-    mysql_free_result(result);
+  if (!dbi_result_next_row(result)) {
+    dbi_result_free(result);
     return;
   }
-  if (row[0] == NULL) {
+  if (dbi_result_get_string(result, &quot;avg_lookup&quot;) == NULL) {
     LOG(LOG_NOTICE, &quot;nothing to summarize from %s for probe %u %u %u&quot;, 
                        from, def-&gt;probeid, slotlow, slothigh);
-    mysql_free_result(result);
+    dbi_result_free(result);
     return;
   }
 
-  avg_lookup = atof(row[0]);
-  avg_connect = atof(row[1]);
-  avg_pretransfer = atof(row[2]);
-  avg_total = atof(row[3]);
-  max_color   = atoi(row[4]);
-  avg_yellow  = atof(row[5]);
-  avg_red     = atof(row[6]);
-  mysql_free_result(result);
+  avg_lookup = dbi_result_get_float(result, &quot;avg_lookup&quot;);
+  avg_connect = dbi_result_get_float(result, &quot;avg_connect&quot;);
+  avg_pretransfer = dbi_result_get_float(result, &quot;avg_pretransfer&quot;);
+  avg_total = dbi_result_get_float(result, &quot;avg_total&quot;);
+  max_color   = dbi_result_get_uint(result, &quot;max_color&quot;);
+  avg_yellow  = dbi_result_get_float(result, &quot;avg_yellow&quot;);
+  avg_red     = dbi_result_get_float(result, &quot;avg_red&quot;);
+  dbi_result_free(result);
 
   if (resummarize) {
     // delete old values
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;delete from pr_httpget_%s where probe = '%u' and stattime = '%u'&quot;,
                     into, def-&gt;probeid, stattime);
-    mysql_free_result(result);
+    dbi_result_free(result);
   }
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;insert into pr_httpget_%s &quot;
                     &quot;set    lookup = '%f', connect = '%f', pretransfer = '%f', total = '%f', &quot;
                     &quot;       probe = %d, color = '%u', stattime = %d, &quot;
@@ -111,7 +113,7 @@
                     into, avg_lookup, avg_connect, avg_pretransfer, avg_total, def-&gt;probeid, 
                     max_color, stattime, avg_yellow, avg_red, slot);
 
-  mysql_free_result(result);
+  dbi_result_free(result);
 }
 
 module httpget_module  = {

Modified: upwatch/libdbi/uw_process/hwstat.c
===================================================================
--- upwatch/libdbi/uw_process/hwstat.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/hwstat.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -13,21 +13,23 @@
 //*******************************************************************
 static gint hwstat_store_raw_result(trx *t)
 {
-  MYSQL_RES *result;
+  dbi_result result;
   struct hwstat_result *res = (struct hwstat_result *)t-&gt;res;
   struct probe_def *def = (struct probe_def *)t-&gt;def;
   char *escmsg;
+  const char *errmsg;
+  int lasterr;
 
   if (t-&gt;res-&gt;color == STAT_PURPLE) return 1;
   t-&gt;seen_before = FALSE;
   if (res-&gt;message) {
-    escmsg = g_malloc(strlen(res-&gt;message) * 2 + 1);
-    mysql_real_escape_string(t-&gt;probe-&gt;db, escmsg, res-&gt;message, strlen(res-&gt;message)) ;
+    escmsg = strdup(res-&gt;message);
+    dbi_conn_quote_string(t-&gt;probe-&gt;db, &amp;escmsg);
   } else {
     escmsg = strdup(&quot;&quot;);
   }
     
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;insert into pr_hwstat_raw &quot;
                     &quot;set    probe = '%u', yellow = '%f', red = '%f', stattime = '%u', color = '%u', &quot;
                     &quot;       temp1 = '%f', temp2 = '%f', temp3 = '%f', &quot;
@@ -42,10 +44,11 @@
                     res-&gt;v50p, res-&gt;v12p, res-&gt;v12n, res-&gt;v50n, 
                     escmsg);
   g_free(escmsg);
-  if (result) mysql_free_result(result);
-  if (mysql_errno(t-&gt;probe-&gt;db) == ER_DUP_ENTRY) {
+  if (result) dbi_result_free(result);
+  lasterr = dbi_conn_error(t-&gt;probe-&gt;db, &amp;errmsg);
+  if (errmsg &amp;&amp; (lasterr == 1062)) { // MySQL ER_DUP_ENTRY(1062)
     t-&gt;seen_before = TRUE;
-  } else if (mysql_errno(t-&gt;probe-&gt;db)) {
+  } else if (lasterr &gt; -1) { // otther error
     return 0; // other failure
   }
   return 1; // success
@@ -56,8 +59,7 @@
 //*******************************************************************
 static void hwstat_summarize(trx *t, char *from, char *into, guint slot, guint slotlow, guint slothigh, gint resummarize)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   struct probe_def *def = (struct probe_def *)t-&gt;def;
   gfloat avg_yellow, avg_red;
   gfloat avg_temp1, avg_temp2, avg_temp3;
@@ -68,61 +70,61 @@
 
   stattime = slotlow + ((slothigh-slotlow)/2);
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
-                    &quot;select avg(temp1), avg(temp2), avg(temp3), &quot;
-                    &quot;       avg(rot1), avg(rot2), avg(rot3), &quot;
-                    &quot;       avg(vc0), avg(vc1), avg(v33), avg(v50p), &quot;
-                    &quot;       avg(v50n), avg(v50n), max(color), avg(yellow), avg(red) &quot; 
+  result = db_query(t-&gt;probe-&gt;db, 0,
+                    &quot;select avg(temp1) as avg_temp1, avg(temp2) as avg_temp2, avg(temp3) as avg_temp3, &quot;
+                    &quot;       avg(rot1) as avg_rot1, avg(rot2) as avg_rot2, avg(rot3) as avg_rot3, &quot;
+                    &quot;       avg(vc0) as avg_vc0, avg(vc1) as avg_vc1, avg(v33) as avg_v33, avg(v50p) as avg_v50p, &quot;
+                    &quot;       avg(v12p) as avg_v12p, avg(v12n) as avg_v12n, avg(v50n) as avg_v50n, &quot;
+                    &quot;       max(color) as max_color, avg(yellow) as avg_yellow, avg(red) as avg_red &quot; 
                     &quot;from   pr_hwstat_%s use index(probstat) &quot;
                     &quot;where  probe = '%d' and stattime &gt;= %d and stattime &lt; %d&quot;,
                     from, def-&gt;probeid, slotlow, slothigh);
   
   if (!result) return;
-  if (mysql_num_rows(result) == 0) { // no records found
+  if (dbi_result_get_numrows(result) == 0) { // no records found
     LOG(LOG_NOTICE, &quot;nothing to summarize from %s for probe %u %u %u&quot;, 
                        from, def-&gt;probeid, slotlow, slothigh);
-    mysql_free_result(result);
+    dbi_result_free(result);
     return;
   }
-  row = mysql_fetch_row(result);
-  if (!row) {
-    mysql_free_result(result);
+  if (!dbi_result_next_row(result)) {
+    dbi_result_free(result);
     return;
   }
-  if (row[0] == NULL) {
+  if (dbi_result_get_string(result, &quot;avg_temp1&quot;) == NULL) {
     LOG(LOG_NOTICE, &quot;NULL values found in summarizing from %s for probe %u %u %u&quot;, 
                       from, def-&gt;probeid, slotlow, slothigh);
-    mysql_free_result(result);
+    dbi_result_free(result);
     return;
   }
 
-  avg_temp1   = atof(row[0]);
-  avg_temp2   = atof(row[1]);
-  avg_temp3   = atof(row[2]);
-  avg_rot1    = atoi(row[3]);
-  avg_rot2    = atoi(row[4]);
-  avg_rot3    = atoi(row[5]);
-  avg_vc0     = atof(row[6]);
-  avg_vc1     = atof(row[7]);
-  avg_v33     = atof(row[8]);
-  avg_v50p    = atof(row[9]);
-  avg_v12p    = atof(row[10]);
-  avg_v12n    = atof(row[11]);
-  avg_v50n    = atof(row[12]);
-  max_color   = atoi(row[13]);
-  avg_yellow  = atof(row[14]);
-  avg_red     = atof(row[15]);
-  mysql_free_result(result);
+  avg_temp1   = dbi_result_get_float(result, &quot;avg_temp1&quot;);
+  avg_temp2   = dbi_result_get_float(result, &quot;avg_temp2&quot;);
+  avg_temp3   = dbi_result_get_float(result, &quot;avg_temp3&quot;);
+  avg_rot1    = dbi_result_get_uint(result, &quot;avg_rot1&quot;);
+  avg_rot2    = dbi_result_get_uint(result, &quot;avg_rot2&quot;);
+  avg_rot3    = dbi_result_get_uint(result, &quot;avg_rot3&quot;);
+  avg_vc0     = dbi_result_get_float(result, &quot;avg_vc0&quot;);
+  avg_vc1     = dbi_result_get_float(result, &quot;avg_vc1&quot;);
+  avg_v33     = dbi_result_get_float(result, &quot;avg_v33&quot;);
+  avg_v50p    = dbi_result_get_float(result, &quot;avg_v50p&quot;);
+  avg_v12p    = dbi_result_get_float(result, &quot;avg_v12p&quot;);
+  avg_v12n    = dbi_result_get_float(result, &quot;avg_v12n&quot;);
+  avg_v50n    = dbi_result_get_float(result, &quot;avg_yellow&quot;);
+  max_color   = dbi_result_get_uint(result, &quot;max_color&quot;);
+  avg_yellow  = dbi_result_get_float(result, &quot;avg_yellow&quot;);
+  avg_red     = dbi_result_get_float(result, &quot;avg_red&quot;);
+  dbi_result_free(result);
 
   if (resummarize) {
     // delete old values
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;delete from pr_hwstat_%s where probe = '%u' and stattime = '%u'&quot;,
                     into, def-&gt;probeid, stattime);
-    mysql_free_result(result);
+    dbi_result_free(result);
   }
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;insert into pr_hwstat_%s &quot; 
                     &quot;set    temp1 = '%f', temp2 = '%f', temp3 = '%f', &quot;
                     &quot;       rot1 = '%u', rot2 = '%u', rot3 = '%u', &quot;
@@ -137,7 +139,7 @@
                     avg_v12p, avg_v12n, avg_v50n, 
                     def-&gt;probeid, max_color, stattime,
                     avg_yellow, avg_red, slot);
-  mysql_free_result(result);
+  dbi_result_free(result);
 }
 
 module hwstat_module  = {

Modified: upwatch/libdbi/uw_process/imap.c
===================================================================
--- upwatch/libdbi/uw_process/imap.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/imap.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -25,23 +25,30 @@
 //*******************************************************************
 // Get the results of the MySQL query into our probe_def structure
 //*******************************************************************
-static void imap_set_def_fields(trx *t, struct probe_def *probedef, MYSQL_RES *result)
+static void imap_set_def_fields(trx *t, struct probe_def *probedef, dbi_result result)
 {
   struct imap_def *def = (struct imap_def *) probedef;
-  MYSQL_ROW row = mysql_fetch_row(result);
 
-  if (row) {
-    if (row[0]) def-&gt;ipaddress   = strdup(row[0]);
-    if (row[1]) def-&gt;description = strdup(row[1]);
-    if (row[2]) def-&gt;server   = atoi(row[2]);
-    if (row[3]) def-&gt;yellow   = atof(row[3]);
-    if (row[4]) def-&gt;red      = atof(row[4]);
-    if (row[5]) def-&gt;contact  = atof(row[5]);
-    strcpy(def-&gt;hide, row[6] ? row[6] : &quot;no&quot;);
-    strcpy(def-&gt;email, row[7] ? row[7] : &quot;&quot;);
-    if (row[8]) def-&gt;delay = atoi(row[8]);
-    if (row[9]) def-&gt;username = strdup(row[9]);
-    if (row[10]) def-&gt;password = strdup(row[10]);
+  if (dbi_result_next_row(result)) {
+    def-&gt;ipaddress   = dbi_result_get_string_copy_idx(result, 0);
+    def-&gt;description = dbi_result_get_string_copy_idx(result, 1);
+    def-&gt;server   = dbi_result_get_uint_idx(result, 2);
+    def-&gt;yellow   = dbi_result_get_float_idx(result, 3);
+    def-&gt;red      = dbi_result_get_float_idx(result, 4);
+    def-&gt;contact  = dbi_result_get_float_idx(result, 5);
+    if (dbi_result_get_string_idx(result, 6)) {
+      strcpy(def-&gt;hide, dbi_result_get_string_idx(result, 6));
+    } else {
+      strcpy(def-&gt;hide, &quot;no&quot;);
+    }
+    if (dbi_result_get_string_idx(result, 7)) {
+      strcpy(def-&gt;email, dbi_result_get_string_idx(result, 7));
+    } else {
+      strcpy(def-&gt;email, &quot;&quot;);
+    }
+    def-&gt;delay = dbi_result_get_uint_idx(result, 8);
+    def-&gt;username = dbi_result_get_string_copy_idx(result, 9);
+    def-&gt;password = dbi_result_get_string_copy_idx(result, 10);
   }
 }
 

Modified: upwatch/libdbi/uw_process/insertcache.c
===================================================================
--- upwatch/libdbi/uw_process/insertcache.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/insertcache.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -19,7 +19,7 @@
 {
   int i, len=0;
   char *sql, *start;
-  MYSQL_RES *result;
+  dbi_result result;
 
   if (probe-&gt;insertc-&gt;len == 0) return;
   for (i=0; i &lt; probe-&gt;insertc-&gt;len; i++) {
@@ -35,8 +35,8 @@
   }
   g_ptr_array_free(probe-&gt;insertc, TRUE); 
   probe-&gt;insertc = g_ptr_array_new();
-  result = my_query(probe-&gt;db, 0, sql);
+  result = db_query(probe-&gt;db, 0, sql);
   free(sql);
-  if (result) mysql_free_result(result);
+  if (result) dbi_result_free(result);
   // note we ignore dupes/errors for the sake of speed.
 }

Modified: upwatch/libdbi/uw_process/iptraf.c
===================================================================
--- upwatch/libdbi/uw_process/iptraf.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/iptraf.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -59,13 +59,16 @@
   if (HAVE_OPT(MULTI_VALUE_INSERTS)) {
     mod_ic_add(t-&gt;probe, &quot;pr_iptraf_raw&quot;, strdup(buf));
   } else {
-    MYSQL_RES *result;
+    dbi_result result;
+    const char *errmsg;
+    int lasterr;
 
-    result = my_query(t-&gt;probe-&gt;db, 0, &quot;insert into pr_iptraf_raw values %s&quot;, buf);
-    if (result) mysql_free_result(result);
-    if (mysql_errno(t-&gt;probe-&gt;db) == ER_DUP_ENTRY) {
+    result = db_query(t-&gt;probe-&gt;db, 0, &quot;insert into pr_iptraf_raw values %s&quot;, buf);
+    if (result) dbi_result_free(result);
+    lasterr = dbi_conn_error(t-&gt;probe-&gt;db, &amp;errmsg);
+    if (errmsg &amp;&amp; (lasterr == 1062)) { // MySQL ER_DUP_ENTRY(1062)
       t-&gt;seen_before = TRUE;
-    } else if (mysql_errno(t-&gt;probe-&gt;db)) {
+    } else if (lasterr &gt; -1) { // otther error
       return 0; // other failure
     }
   }
@@ -77,8 +80,7 @@
 //*******************************************************************
 static void iptraf_summarize(trx *t, char *from, char *into, guint slot, guint slotlow, guint slothigh, gint resummarize)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   struct iptraf_def *def = (struct iptraf_def *)t-&gt;def;
   struct iptraf_result *res = (struct iptraf_result *)t-&gt;res;
   float avg_yellow, avg_red;
@@ -100,55 +102,55 @@
     def-&gt;slotday_avg_yellow = def-&gt;yellow;
     def-&gt;slotday_avg_red = def-&gt;red;
   } else {
-    result = my_query(t-&gt;probe-&gt;db, 0,
-                      &quot;select sum(incoming), sum(outgoing), max(color), avg(yellow), avg(red) &quot;
+    result = db_query(t-&gt;probe-&gt;db, 0,
+                      &quot;select sum(incoming) as incoming, sum(outgoing) as outgoing, &quot;
+                      &quot;       max(color) max_color, avg(yellow) as avg_yellow, avg(red) as avg_red &quot;
                       &quot;from   pr_iptraf_%s use index(probstat) &quot;
                       &quot;where  probe = '%u' and stattime &gt;= '%u' and stattime &lt; '%u'&quot;,
                       from, def-&gt;probeid, slotlow, slothigh);
 
     if (!result) return;
-    if (mysql_num_rows(result) == 0) { // no records found
+    if (dbi_result_get_numrows(result) == 0) { // no records found
       LOG(LOG_NOTICE, &quot;nothing to summarize from %s for probe %u %u %u&quot;,
                          from, def-&gt;probeid, slotlow, slothigh);
-      mysql_free_result(result);
+      dbi_result_free(result);
       return;
     }
 
-    row = mysql_fetch_row(result);
-    if (!row) {
-      mysql_free_result(result);
+    if (!dbi_result_next_row(result)) {
+      dbi_result_free(result);
       return;
     }
-    if (row[0] == NULL) {
+    if (dbi_result_get_string(result, &quot;incoming&quot;) == NULL) {
       LOG(LOG_NOTICE, &quot;nothing to summarize from %s for probe %u %u %u&quot;, 
                        from, def-&gt;probeid, slotlow, slothigh);
-      mysql_free_result(result);
+      dbi_result_free(result);
       return;
     }
 
-    incoming    = atof(row[0]);
-    outgoing    = atof(row[1]);
-    max_color   = atoi(row[2]);
-    avg_yellow  = atof(row[3]);
-    avg_red     = atof(row[4]);
-    mysql_free_result(result);
+    incoming    = dbi_result_get_float(result, &quot;incoming&quot;);
+    outgoing    = dbi_result_get_float(result, &quot;outgoing&quot;);
+    max_color   = dbi_result_get_uint(result, &quot;max_color&quot;);
+    avg_yellow  = dbi_result_get_float(result, &quot;avg_yellow&quot;);
+    avg_red     = dbi_result_get_float(result, &quot;avg_red&quot;);
+    dbi_result_free(result);
   }
 
   if (resummarize) {
     // delete old values
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;delete from pr_iptraf_%s where probe = '%u' and stattime = '%u'&quot;,
                     into, def-&gt;probeid, stattime);
-    mysql_free_result(result);
+    dbi_result_free(result);
   }
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;insert into pr_iptraf_%s &quot;
                     &quot;set    incoming = '%f', outgoing = '%f', &quot;
                     &quot;       probe = '%u', color = '%u', stattime = '%u', &quot;
                     &quot;       yellow = '%f', red = '%f', slot = '%u'&quot;,
                     into, incoming, outgoing, def-&gt;probeid, max_color, stattime, 
                     avg_yellow, avg_red, slot);
-  mysql_free_result(result);
+  dbi_result_free(result);
 }
 
 module iptraf_module  = {

Modified: upwatch/libdbi/uw_process/mssql.c
===================================================================
--- upwatch/libdbi/uw_process/mssql.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/mssql.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -27,25 +27,32 @@
 //*******************************************************************
 // Get the results of the MySQL query into our probe_def structure
 //*******************************************************************
-static void mssql_set_def_fields(trx *t, struct probe_def *probedef, MYSQL_RES *result)
+static void mssql_set_def_fields(trx *t, struct probe_def *probedef, dbi_result result)
 {
   struct mssql_def *def = (struct mssql_def *) probedef;
-  MYSQL_ROW row = mysql_fetch_row(result);
 
-  if (row) {
-    if (row[0]) def-&gt;ipaddress = strdup(row[0]);
-    if (row[1]) def-&gt;description = strdup(row[1]);
-    if (row[2]) def-&gt;server   = atoi(row[2]);
-    if (row[3]) def-&gt;yellow   = atof(row[3]);
-    if (row[4]) def-&gt;red      = atof(row[4]);
-    if (row[5]) def-&gt;contact  = atof(row[5]);
-    strcpy(def-&gt;hide, row[6] ? row[6] : &quot;no&quot;);
-    strcpy(def-&gt;email, row[7] ? row[7] : &quot;&quot;);
-    if (row[8]) def-&gt;delay = atoi(row[8]);
-    if (row[9]) def-&gt;dbname = strdup(row[9]);
-    if (row[10]) def-&gt;dbuser = strdup(row[10]);
-    if (row[9]) def-&gt;dbpasswd = strdup(row[9]);
-    if (row[10]) def-&gt;query = strdup(row[10]);
+  if (dbi_result_next_row(result)) {
+    def-&gt;ipaddress   = dbi_result_get_string_copy_idx(result, 0);
+    def-&gt;description = dbi_result_get_string_copy_idx(result, 1);
+    def-&gt;server   = dbi_result_get_uint_idx(result, 2);
+    def-&gt;yellow   = dbi_result_get_float_idx(result, 3);
+    def-&gt;red      = dbi_result_get_float_idx(result, 4);
+    def-&gt;contact  = dbi_result_get_float_idx(result, 5);
+    if (dbi_result_get_string_idx(result, 6)) {
+      strcpy(def-&gt;hide, dbi_result_get_string_idx(result, 6));
+    } else {
+      strcpy(def-&gt;hide, &quot;no&quot;);
+    }
+    if (dbi_result_get_string_idx(result, 7)) {
+      strcpy(def-&gt;email, dbi_result_get_string_idx(result, 7));
+    } else {
+      strcpy(def-&gt;email, &quot;&quot;);
+    }
+    def-&gt;delay = dbi_result_get_uint_idx(result, 8);
+    def-&gt;dbname = dbi_result_get_string_copy_idx(result, 9);
+    def-&gt;dbuser = dbi_result_get_string_copy_idx(result, 10);
+    def-&gt;dbpasswd = dbi_result_get_string_copy_idx(result, 11);
+    def-&gt;query = dbi_result_get_string_copy_idx(result, 12);
   }
 }
 

Modified: upwatch/libdbi/uw_process/mysql.c
===================================================================
--- upwatch/libdbi/uw_process/mysql.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/mysql.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -27,25 +27,32 @@
 //*******************************************************************
 // Get the results of the MySQL query into our probe_def structure
 //*******************************************************************
-static void mysql_set_def_fields(trx *t, struct probe_def *probedef, MYSQL_RES *result)
+static void mysql_set_def_fields(trx *t, struct probe_def *probedef, dbi_result result)
 {
   struct mysql_def *def = (struct mysql_def *) probedef;
-  MYSQL_ROW row = mysql_fetch_row(result);
 
-  if (row) {
-    if (row[0]) def-&gt;ipaddress = strdup(row[0]);
-    if (row[1]) def-&gt;description = strdup(row[1]);
-    if (row[2]) def-&gt;server   = atoi(row[2]);
-    if (row[3]) def-&gt;yellow   = atof(row[3]);
-    if (row[4]) def-&gt;red      = atof(row[4]);
-    if (row[5]) def-&gt;contact  = atof(row[5]);
-    strcpy(def-&gt;hide, row[6] ? row[6] : &quot;no&quot;);
-    strcpy(def-&gt;email, row[7] ? row[7] : &quot;&quot;);
-    if (row[8]) def-&gt;delay = atoi(row[8]);
-    if (row[9]) def-&gt;dbname = strdup(row[9]);
-    if (row[10]) def-&gt;dbuser = strdup(row[10]);
-    if (row[11]) def-&gt;dbpasswd = strdup(row[11]);
-    if (row[12]) def-&gt;query = strdup(row[12]);
+  if (dbi_result_next_row(result)) {
+    def-&gt;ipaddress = dbi_result_get_string_copy_idx(result, 0);
+    def-&gt;description = dbi_result_get_string_copy_idx(result, 1);
+    def-&gt;server   = dbi_result_get_uint_idx(result, 2);
+    def-&gt;yellow   = dbi_result_get_float_idx(result, 3);
+    def-&gt;red      = dbi_result_get_float_idx(result, 4);
+    def-&gt;contact  = dbi_result_get_float_idx(result, 5);
+    if (dbi_result_get_string_idx(result, 6)) {
+      strcpy(def-&gt;hide, dbi_result_get_string_idx(result, 6));
+    } else {
+      strcpy(def-&gt;hide, &quot;no&quot;);
+    }
+    if (dbi_result_get_string_idx(result, 7)) {
+      strcpy(def-&gt;email, dbi_result_get_string_idx(result, 7));
+    } else {
+      strcpy(def-&gt;email, &quot;&quot;);
+    }
+    def-&gt;delay = dbi_result_get_uint_idx(result, 8);
+    def-&gt;dbname = dbi_result_get_string_copy_idx(result, 9);
+    def-&gt;dbuser = dbi_result_get_string_copy_idx(result, 10);
+    def-&gt;dbpasswd = dbi_result_get_string_copy_idx(result, 11);
+    def-&gt;query = dbi_result_get_string_copy_idx(result, 12);
   }
 }
 

Modified: upwatch/libdbi/uw_process/mysqlstats.c
===================================================================
--- upwatch/libdbi/uw_process/mysqlstats.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/mysqlstats.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -13,21 +13,23 @@
 //*******************************************************************
 static gint mysqlstats_store_raw_result(trx *t)
 {
-  MYSQL_RES *result;
+  dbi_result result;
   struct mysqlstats_result *res = (struct mysqlstats_result *)t-&gt;res;
   struct probe_def *def = (struct probe_def *)t-&gt;def;
   char *escmsg;
+  const char *errmsg;
+  int lasterr;
 
   if (t-&gt;res-&gt;color == STAT_PURPLE) return 1;
   t-&gt;seen_before = FALSE;
   if (res-&gt;message) {
-    escmsg = g_malloc(strlen(res-&gt;message) * 2 + 1);
-    mysql_real_escape_string(t-&gt;probe-&gt;db, escmsg, res-&gt;message, strlen(res-&gt;message)) ;
+    escmsg = strdup(res-&gt;message);
+    dbi_conn_quote_string(t-&gt;probe-&gt;db, &amp;escmsg);
   } else {
     escmsg = strdup(&quot;&quot;);
   }
     
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;insert into pr_mysqlstats_raw &quot;
                     &quot;set    probe = '%u', yellow = '%f', red = '%f', stattime = '%u', color = '%u', &quot;
                     &quot;       selectq = '%u', insertq = '%u', updateq = '%u', deleteq = '%u',` &quot;
@@ -35,10 +37,11 @@
                     def-&gt;probeid, def-&gt;yellow, def-&gt;red, res-&gt;stattime, res-&gt;color, 
                     res-&gt;selectq, res-&gt;insertq, res-&gt;updateq, res-&gt;deleteq,escmsg);
   g_free(escmsg);
-  if (result) mysql_free_result(result);
-  if (mysql_errno(t-&gt;probe-&gt;db) == ER_DUP_ENTRY) {
+  if (result) dbi_result_free(result);
+  lasterr = dbi_conn_error(t-&gt;probe-&gt;db, &amp;errmsg);
+  if (errmsg &amp;&amp; (lasterr == 1062)) { // MySQL ER_DUP_ENTRY(1062)
     t-&gt;seen_before = TRUE;
-  } else if (mysql_errno(t-&gt;probe-&gt;db)) {
+  } else if (lasterr &gt; -1) { // otther error
     return 0; // other failure
   }
   return 1; // success
@@ -59,8 +62,7 @@
 //*******************************************************************
 static void mysqlstats_summarize(trx *t, char *from, char *into, guint slot, guint slotlow, guint slothigh, gint resummarize)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   struct probe_def *def = (struct probe_def *)t-&gt;def;
   float avg_yellow, avg_red;
   int avg_selectq;
@@ -72,51 +74,52 @@
 
   stattime = slotlow + ((slothigh-slotlow)/2);
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
-                    &quot;select avg(selectq), avg(insertq), avg(updateq), avg(deleteq), &quot;
-                    &quot;       max(color), avg(yellow), avg(red) &quot;
+  result = db_query(t-&gt;probe-&gt;db, 0,
+                    &quot;select avg(selectq) as avg_selectq, avg(insertq) as avg_insertq, &quot;
+                    &quot;       avg(updateq) as avg_updateq, avg(deleteq) as avg_deleteq, &quot;
+                    &quot;       max(color) as max_color, &quot;
+                    &quot;       avg(yellow) as avg_yellow, avg(red) as avg_red &quot;
                     &quot;from   pr_mysqlstats_%s use index(probstat) &quot;
                     &quot;where  probe = '%d' and stattime &gt;= %d and stattime &lt; %d&quot;,
                     from, def-&gt;probeid, slotlow, slothigh);
 
   if (!result) return;
-  if (mysql_num_rows(result) == 0) { // no records found
+  if (dbi_result_get_numrows(result) == 0) { // no records found
     LOG(LOG_NOTICE, &quot;nothing to summarize from %s for probe %u %u %u&quot;,
                        from, def-&gt;probeid, slotlow, slothigh);
-    mysql_free_result(result);
+    dbi_result_free(result);
     return;
   }
 
-  row = mysql_fetch_row(result);
-  if (!row) {
-    mysql_free_result(result);
+  if (!dbi_result_next_row(result)) {
+    dbi_result_free(result);
     return;
   }
-  if (row[0] == NULL) {
+  if (dbi_result_get_string(result, &quot;avg_selectq&quot;) == NULL) {
     LOG(LOG_NOTICE, &quot;nothing to summarize from %s for probe %u %u %u&quot;, 
                        from, def-&gt;probeid, slotlow, slothigh);
-    mysql_free_result(result);
+    dbi_result_free(result);
     return;
   }
 
-  avg_selectq = atoi(row[0]);
-  avg_insertq = atoi(row[1]);
-  avg_updateq = atoi(row[2]);
-  avg_deleteq = atoi(row[3]);
-  max_color   = atoi(row[4]);
-  avg_yellow  = atof(row[5]);
-  avg_red     = atof(row[6]);
-  mysql_free_result(result);
+  avg_selectq = dbi_result_get_uint(result, &quot;avg_selectq&quot;);
+  avg_insertq = dbi_result_get_uint(result, &quot;avg_insertq&quot;);
+  avg_updateq = dbi_result_get_uint(result, &quot;avg_updateq&quot;);
+  avg_deleteq = dbi_result_get_uint(result, &quot;avg_deleteq&quot;);
+  max_color   = dbi_result_get_uint(result, &quot;max_color&quot;);
+  avg_yellow  = dbi_result_get_float(result, &quot;avg_yellow&quot;);
+  avg_red     = dbi_result_get_float(result, &quot;avg_red&quot;);
+  dbi_result_free(result);
 
   if (resummarize) {
     // delete old values
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;delete from pr_mysqlstats_%s where probe = '%u' and stattime = '%u'&quot;,
                     into, def-&gt;probeid, stattime);
-    mysql_free_result(result);
+    dbi_result_free(result);
   }
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;insert into pr_mysqlstats_%s &quot;
                     &quot;set    selectq = '%u', insertq = '%u', updateq = '%u', deleteq = '%u', &quot;
                     &quot;       probe = %d, color = '%u', stattime = %d, &quot;
@@ -124,7 +127,7 @@
                     into,  avg_selectq, avg_insertq, avg_updateq, avg_deleteq, def-&gt;probeid, 
                     max_color, stattime, avg_yellow, avg_red, slot);
 
-  mysql_free_result(result);
+  dbi_result_free(result);
 }
 
 module mysqlstats_module  = {

Modified: upwatch/libdbi/uw_process/notify.c
===================================================================
--- upwatch/libdbi/uw_process/notify.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/notify.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -18,8 +18,7 @@
 int notify(trx *t)
 {
   int notified = FALSE;
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
 
   if (debug &gt; 3) fprintf(stderr, &quot;%s %u %s (was %s). %s\n&quot;, t-&gt;probe-&gt;module_name, t-&gt;def-&gt;probeid, 
                   color2string(t-&gt;res-&gt;color), color2string(t-&gt;res-&gt;prevhistcolor), t-&gt;res-&gt;hostname);
@@ -32,7 +31,7 @@
 
   // now go back to the last time the user received a warning, and
   // retrieve the color we had at that time
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;select   color &quot;
                     &quot;from     pr_hist  &quot;
                     &quot;where    probe = '%u' and class = '%u' and stattime &lt;= '%u' &quot;
@@ -40,13 +39,12 @@
                     &quot;order by stattime desc limit 1&quot;,
                     t-&gt;def-&gt;probeid, t-&gt;probe-&gt;class, t-&gt;res-&gt;stattime);
   if (!result) return(notified);
-  row = mysql_fetch_row(result);
-  if (row) {
-    t-&gt;res-&gt;prevhistcolor = atoi(row[0]);
+  if (dbi_result_next_row(result)) {
+    t-&gt;res-&gt;prevhistcolor = dbi_result_get_uint(result, &quot;color&quot;);
   } else {
     t-&gt;res-&gt;prevhistcolor = 0;
   }
-  mysql_free_result(result);
+  dbi_result_free(result);
 
   // if it's the same, we don't really need to warn right?
   if (t-&gt;res-&gt;prevhistcolor == t-&gt;res-&gt;color) {
@@ -93,7 +91,7 @@
   return *buf;
 }
 
-int mail(char *to, char *subject, char *body, time_t date)
+int mail(const char *to, const char *subject, const char *body, time_t date)
 {
   int notified = FALSE;
 

Modified: upwatch/libdbi/uw_process/ping.c
===================================================================
--- upwatch/libdbi/uw_process/ping.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/ping.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -11,22 +11,29 @@
 //*******************************************************************
 // Get the results of the MySQL query into our probe_def structure
 //*******************************************************************
-static void ping_set_def_fields(trx *t, struct probe_def *probedef, MYSQL_RES *result)
+static void ping_set_def_fields(trx *t, struct probe_def *probedef, dbi_result result)
 {
   struct ping_def *def = (struct ping_def *) probedef;
-  MYSQL_ROW row = mysql_fetch_row(result);
 
-  if (row) {
-    if (row[0]) def-&gt;ipaddress   = strdup(row[0]);
-    if (row[1]) def-&gt;description = strdup(row[1]);
-    if (row[2]) def-&gt;server   = atoi(row[2]);
-    if (row[3]) def-&gt;yellow   = atof(row[3]);
-    if (row[4]) def-&gt;red      = atof(row[4]);
-    if (row[5]) def-&gt;contact  = atof(row[5]);
-    strcpy(def-&gt;hide, row[6] ? row[6] : &quot;no&quot;);
-    strcpy(def-&gt;email, row[7] ? row[7] : &quot;&quot;);
-    if (row[8]) def-&gt;delay = atoi(row[8]);
-    if (row[9]) def-&gt;count = atoi(row[9]);
+  if (dbi_result_next_row(result)) {
+    def-&gt;ipaddress   = dbi_result_get_string_copy_idx(result, 0);
+    def-&gt;description = dbi_result_get_string_copy_idx(result, 1);
+    def-&gt;server   = dbi_result_get_uint_idx(result, 2);
+    def-&gt;yellow   = dbi_result_get_float_idx(result, 3);
+    def-&gt;red      = dbi_result_get_float_idx(result, 4);
+    def-&gt;contact  = dbi_result_get_float_idx(result, 5);
+    if (dbi_result_get_string_idx(result, 6)) {
+      strcpy(def-&gt;hide, dbi_result_get_string_idx(result, 6));
+    } else {
+      strcpy(def-&gt;hide, &quot;no&quot;);
+    }
+    if (dbi_result_get_string_idx(result, 7)) {
+      strcpy(def-&gt;email, dbi_result_get_string_idx(result, 7));
+    } else {
+      strcpy(def-&gt;email, &quot;&quot;);
+    }
+    def-&gt;delay = dbi_result_get_uint_idx(result, 8);
+    def-&gt;count = dbi_result_get_uint_idx(result, 9);
   }
 }
 
@@ -35,31 +42,34 @@
 //*******************************************************************
 static gint ping_store_raw_result(trx *t)
 {
-  MYSQL_RES *result;
+  dbi_result result;
   struct ping_result *res = (struct ping_result *)t-&gt;res;
   struct probe_def *def = (struct probe_def *)t-&gt;def;
   char *escmsg;
+  const char *errmsg;
+  int lasterr;
 
   if (t-&gt;res-&gt;color == STAT_PURPLE) return 1;
   t-&gt;seen_before = FALSE;
   if (res-&gt;message) {
-    escmsg = g_malloc(strlen(res-&gt;message) * 2 + 1);
-    mysql_real_escape_string(t-&gt;probe-&gt;db, escmsg, res-&gt;message, strlen(res-&gt;message)) ;
+    escmsg = strdup(res-&gt;message);
+    dbi_conn_quote_string(t-&gt;probe-&gt;db, &amp;escmsg);
   } else {
     escmsg = strdup(&quot;&quot;);
   }
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;insert into pr_ping_raw &quot;
                     &quot;set    probe = '%u', yellow = '%f', red = '%f', stattime = '%u', color = '%u', &quot;
                     &quot;       average = '%f', lowest = '%f', highest = '%f', message = '%s'&quot;,
                     def-&gt;probeid, def-&gt;yellow, def-&gt;red, res-&gt;stattime, res-&gt;color, 
                     res-&gt;average, res-&gt;lowest, res-&gt;highest, escmsg);
   g_free(escmsg);
-  if (result) mysql_free_result(result);
-  if (mysql_errno(t-&gt;probe-&gt;db) == ER_DUP_ENTRY) {
+  if (result) dbi_result_free(result);
+  lasterr = dbi_conn_error(t-&gt;probe-&gt;db, &amp;errmsg);
+  if (errmsg &amp;&amp; (lasterr == 1062)) { // MySQL ER_DUP_ENTRY(1062)
     t-&gt;seen_before = TRUE;
-  } else if (mysql_errno(t-&gt;probe-&gt;db)) {
+  } else if (lasterr &gt; -1) { // otther error
     return 0; // other failure
   }
   return 1; // success
@@ -77,6 +87,7 @@
                &quot;%-20s: %s\n&quot;
                &quot;%-20s: %u\n&quot;
                &quot;%-20s: %f\n&quot;
+               &quot;%-20s: %f\n&quot;
                &quot;%-20s: %f\n&quot;,
   &quot;IP Address&quot;, def-&gt;ipaddress,
   &quot;Description&quot;, def-&gt;description,
@@ -91,8 +102,7 @@
 //*******************************************************************
 static void ping_summarize(trx *t, char *from, char *into, guint slot, guint slotlow, guint slothigh, gint resummarize)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   struct probe_def *def = (struct probe_def *)t-&gt;def;
   float avg_yellow, avg_red;
   float avg_average, min_lowest, max_highest; 
@@ -101,56 +111,56 @@
 
   stattime = slotlow + ((slothigh-slotlow)/2);
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
-                    &quot;select avg(lowest), avg(average), avg(highest), &quot;
-                    &quot;       max(color), avg(yellow), avg(red) &quot; 
+  result = db_query(t-&gt;probe-&gt;db, 0,
+                    &quot;select avg(lowest) as avg_lowest, avg(average) asavg_average, &quot;
+                    &quot;       avg(highest) as avg_highest, max(color) as max_color, &quot;
+                    &quot;       avg(yellow) as avg_yellow, avg(red) as avg_red &quot; 
                     &quot;from   pr_ping_%s use index(probstat) &quot;
                     &quot;where  probe = '%d' and stattime &gt;= %d and stattime &lt; %d&quot;,
                     from, def-&gt;probeid, slotlow, slothigh);
   
   if (!result) return;
-  if (mysql_num_rows(result) == 0) { // no records found
+  if (dbi_result_get_numrows(result) == 0) { // no records found
     LOG(LOG_NOTICE, &quot;nothing to summarize from %s for probe %u %u %u&quot;,
                        from, def-&gt;probeid, slotlow, slothigh);
-    mysql_free_result(result);
+    dbi_result_free(result);
     return;
   }
 
-  row = mysql_fetch_row(result);
-  if (!row) {
-    mysql_free_result(result);
+  if (!dbi_result_next_row(result)) {
+    dbi_result_free(result);
     return;
   }
-  if (row[0] == NULL) {
+  if (dbi_result_get_string(result, &quot;avg_lowest&quot;) == NULL) {
     LOG(LOG_NOTICE, &quot;nothing to summarize from %s for probe %u %u %u&quot;, 
                        from, def-&gt;probeid, slotlow, slothigh);
-    mysql_free_result(result);
+    dbi_result_free(result);
     return;
   }
 
-  min_lowest  = atof(row[0]);
-  avg_average = atof(row[1]);
-  max_highest = atof(row[2]);
-  max_color   = atoi(row[3]);
-  avg_yellow  = atof(row[4]);
-  avg_red     = atof(row[5]);
-  mysql_free_result(result);
+  min_lowest  = dbi_result_get_float(result, &quot;min_lowest&quot;);
+  avg_average = dbi_result_get_float(result, &quot;avg_average&quot;);
+  max_highest = dbi_result_get_float(result, &quot;max_highest&quot;);
+  max_color   = dbi_result_get_uint(result, &quot;max_color&quot;);
+  avg_yellow  = dbi_result_get_float(result, &quot;avg_yellow&quot;);
+  avg_red     = dbi_result_get_float(result, &quot;avg_red&quot;);
+  dbi_result_free(result);
 
   if (resummarize) {
     // delete old values
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;delete from pr_ping_%s where probe = '%u' and stattime = '%u'&quot;,
                     into, def-&gt;probeid, stattime);
-    mysql_free_result(result);
+    dbi_result_free(result);
   }
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;insert into pr_ping_%s &quot; 
                     &quot;set    average = %f, lowest = %f, highest = %f, probe = %d, color = '%u', &quot; 
                     &quot;       stattime = %d, yellow = '%f', red = '%f', slot = '%u'&quot;,
                     into, avg_average, min_lowest, max_highest, def-&gt;probeid, 
                     max_color, stattime, avg_yellow, avg_red, slot);
-  mysql_free_result(result);
+  dbi_result_free(result);
 }
 
 module ping_module  = {

Modified: upwatch/libdbi/uw_process/pop3.c
===================================================================
--- upwatch/libdbi/uw_process/pop3.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/pop3.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -25,23 +25,30 @@
 //*******************************************************************
 // Get the results of the MySQL query into our probe_def structure
 //*******************************************************************
-static void pop3_set_def_fields(trx *t, struct probe_def *probedef, MYSQL_RES *result)
+static void pop3_set_def_fields(trx *t, struct probe_def *probedef, dbi_result result)
 {
   struct pop3_def *def = (struct pop3_def *) probedef;
-  MYSQL_ROW row = mysql_fetch_row(result);
 
-  if (row) {
-    if (row[0]) def-&gt;ipaddress = strdup(row[0]);
-    if (row[1]) def-&gt;description = strdup(row[1]);
-    if (row[2]) def-&gt;server   = atoi(row[2]);
-    if (row[3]) def-&gt;yellow   = atof(row[3]);
-    if (row[4]) def-&gt;red      = atof(row[4]);
-    if (row[5]) def-&gt;contact  = atof(row[5]);
-    strcpy(def-&gt;hide, row[6] ? row[6] : &quot;no&quot;);
-    strcpy(def-&gt;email, row[7] ? row[7] : &quot;&quot;);
-    if (row[8]) def-&gt;delay = atoi(row[8]);
-    if (row[9]) def-&gt;username = strdup(row[9]);
-    if (row[8]) def-&gt;password = strdup(row[8]);
+  if (dbi_result_next_row(result)) {
+    def-&gt;ipaddress   = dbi_result_get_string_copy_idx(result, 0);
+    def-&gt;description = dbi_result_get_string_copy_idx(result, 1);
+    def-&gt;server   = dbi_result_get_uint_idx(result, 2);
+    def-&gt;yellow   = dbi_result_get_float_idx(result, 3);
+    def-&gt;red      = dbi_result_get_float_idx(result, 4);
+    def-&gt;contact  = dbi_result_get_float_idx(result, 5);
+    if (dbi_result_get_string_idx(result, 6)) {
+      strcpy(def-&gt;hide, dbi_result_get_string_idx(result, 6));
+    } else {
+      strcpy(def-&gt;hide, &quot;no&quot;);
+    }
+    if (dbi_result_get_string_idx(result, 7)) {
+      strcpy(def-&gt;email, dbi_result_get_string_idx(result, 7));
+    } else {
+      strcpy(def-&gt;email, &quot;&quot;);
+    }
+    def-&gt;delay = dbi_result_get_uint_idx(result, 8);
+    def-&gt;password = dbi_result_get_string_copy_idx(result, 8);
+    def-&gt;username = dbi_result_get_string_copy_idx(result, 9);
   }
 }
 

Modified: upwatch/libdbi/uw_process/postgresql.c
===================================================================
--- upwatch/libdbi/uw_process/postgresql.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/postgresql.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -27,25 +27,32 @@
 //*******************************************************************
 // Get the results of the MySQL query into our probe_def structure
 //*******************************************************************
-static void postgresql_set_def_fields(trx *t, struct probe_def *probedef, MYSQL_RES *result)
+static void postgresql_set_def_fields(trx *t, struct probe_def *probedef, dbi_result result)
 {
   struct postgresql_def *def = (struct postgresql_def *) probedef;
-  MYSQL_ROW row = mysql_fetch_row(result);
 
-  if (row) {
-    if (row[0]) def-&gt;ipaddress = strdup(row[0]);
-    if (row[1]) def-&gt;description = strdup(row[1]);
-    if (row[2]) def-&gt;server   = atoi(row[2]);
-    if (row[3]) def-&gt;yellow   = atof(row[3]);
-    if (row[4]) def-&gt;red      = atof(row[4]);
-    if (row[5]) def-&gt;contact  = atof(row[5]);
-    strcpy(def-&gt;hide, row[6] ? row[6] : &quot;no&quot;);
-    strcpy(def-&gt;email, row[7] ? row[7] : &quot;&quot;);
-    if (row[8]) def-&gt;delay = atoi(row[8]);
-    if (row[9]) def-&gt;dbname = strdup(row[9]);
-    if (row[10]) def-&gt;dbuser = strdup(row[10]);
-    if (row[9]) def-&gt;dbpasswd = strdup(row[9]);
-    if (row[10]) def-&gt;query = strdup(row[10]);
+  if (dbi_result_next_row(result)) {
+    def-&gt;ipaddress   = dbi_result_get_string_copy_idx(result, 0);
+    def-&gt;description = dbi_result_get_string_copy_idx(result, 1);
+    def-&gt;server   = dbi_result_get_uint_idx(result, 2);
+    def-&gt;yellow   = dbi_result_get_float_idx(result, 3);
+    def-&gt;red      = dbi_result_get_float_idx(result, 4);
+    def-&gt;contact  = dbi_result_get_float_idx(result, 5);
+    if (dbi_result_get_string_idx(result, 6)) {
+      strcpy(def-&gt;hide, dbi_result_get_string_idx(result, 6));
+    } else {
+      strcpy(def-&gt;hide, &quot;no&quot;);
+    }
+    if (dbi_result_get_string_idx(result, 7)) {
+      strcpy(def-&gt;email, dbi_result_get_string_idx(result, 7));
+    } else {
+      strcpy(def-&gt;email, &quot;&quot;);
+    }
+    def-&gt;delay = dbi_result_get_uint_idx(result, 8);
+    def-&gt;dbname = dbi_result_get_string_copy_idx(result, 9);
+    def-&gt;dbuser = dbi_result_get_string_copy_idx(result, 10);
+    def-&gt;dbpasswd = dbi_result_get_string_copy_idx(result, 11);
+    def-&gt;query = dbi_result_get_string_copy_idx(result, 12);
   }
 }
 

Modified: upwatch/libdbi/uw_process/process.c
===================================================================
--- upwatch/libdbi/uw_process/process.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/process.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -43,8 +43,7 @@
 //*******************************************************************
 static struct probe_result *get_previous_record(trx *t)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   struct probe_result *prv;
 
   prv = g_malloc0(sizeof(struct probe_result));
@@ -56,19 +55,18 @@
 
   if (!t-&gt;probe-&gt;store_results) return(prv); // we probably don't have a xxxx_raw table
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;select   color, stattime &quot;
                     &quot;from     pr_%s_raw use index(probstat) &quot;
                     &quot;where    probe = '%u' and stattime &lt; '%u' &quot;
                     &quot;order by stattime desc limit 1&quot;, 
                     t-&gt;res-&gt;name, t-&gt;def-&gt;probeid, t-&gt;res-&gt;stattime);
   if (!result) return(prv);
-  row = mysql_fetch_row(result);
-  if (row) {
-    prv-&gt;color = atoi(row[0]);
-    prv-&gt;stattime = atoi(row[1]);
+  if (dbi_result_next_row(result)) {
+    prv-&gt;color = dbi_result_get_uint(result, &quot;color&quot;);
+    prv-&gt;stattime = dbi_result_get_uint(result, &quot;stattime&quot;);
   }
-  mysql_free_result(result);
+  dbi_result_free(result);
   t-&gt;res-&gt;prevcolor = prv-&gt;color;
   return(prv);
 }
@@ -90,28 +88,25 @@
 //*******************************************************************
 static struct probe_result *get_following_record(trx *t)
 {
-  MYSQL_RES *result;
+  dbi_result result;
   struct probe_result *nxt = NULL;
 
   if (!t-&gt;probe-&gt;store_results) return(NULL); // we probably don't have a xxxx_raw table
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;select   color, stattime &quot;
                     &quot;from     pr_%s_raw use index(probstat) &quot;
                     &quot;where    probe = '%u' and stattime &gt; '%u' &quot;
                     &quot;order by stattime asc limit 1&quot;, 
                     t-&gt;res-&gt;name, t-&gt;def-&gt;probeid, t-&gt;res-&gt;stattime);
   if (result) {
-    MYSQL_ROW row;
-
-    row = mysql_fetch_row(result);
-    if (row) {
+    if (dbi_result_next_row(result)) {
       nxt = g_malloc0(sizeof(struct probe_result));
 
-      nxt-&gt;color = atoi(row[0]);
-      nxt-&gt;stattime = atoi(row[1]);
+      nxt-&gt;color = dbi_result_get_uint(result, &quot;color&quot;);
+      nxt-&gt;stattime = dbi_result_get_uint(result, &quot;stattime&quot;);
     }
-    mysql_free_result(result);
+    dbi_result_free(result);
   }
   return(nxt);
 }
@@ -119,9 +114,9 @@
 //*******************************************************************
 // UPDATE PR_STATUS
 //*******************************************************************
-static void update_pr_status(trx *t, struct probe_result *prv)
+static dbi_result update_pr_status(trx *t, struct probe_result *prv)
 {
-  MYSQL_RES *result;
+  dbi_result result;
   char *qry;
 
   qry = g_malloc(512 + (t-&gt;res-&gt;message ? strlen(t-&gt;res-&gt;message)*2 : 0));
@@ -145,8 +140,8 @@
   if (t-&gt;res-&gt;message) {
     char *escmsg;
 
-    escmsg = g_malloc(strlen(t-&gt;res-&gt;message) * 2 + 1);
-    mysql_real_escape_string(t-&gt;probe-&gt;db, escmsg, t-&gt;res-&gt;message, strlen(t-&gt;res-&gt;message));
+    escmsg = strdup(t-&gt;res-&gt;message);
+    dbi_conn_quote_string(t-&gt;probe-&gt;db, &amp;escmsg);
 
     if (t-&gt;res-&gt;color != prv-&gt;color) {
       sprintf(&amp;qry[strlen(qry)], &quot;, message = '%s'&quot;, escmsg);
@@ -157,9 +152,9 @@
   }
 
   sprintf(&amp;qry[strlen(qry)], &quot; where probe = '%u' and class = '%u'&quot;, t-&gt;def-&gt;probeid, t-&gt;probe-&gt;class);
-  result = my_rawquery(t-&gt;probe-&gt;db, 0, qry);
-  mysql_free_result(result);
+  result = db_rawquery(t-&gt;probe-&gt;db, 0, qry);
   g_free(qry);
+  return(result);
 }
 
 //*******************************************************************
@@ -167,24 +162,24 @@
 //*******************************************************************
 static void insert_pr_status(trx *t)
 {
-  MYSQL_RES *result;
+  dbi_result result;
   char *escmsg;
 
   if (t-&gt;res-&gt;message) {
-    escmsg = g_malloc(strlen(t-&gt;res-&gt;message) * 2 + 1);
-    mysql_real_escape_string(t-&gt;probe-&gt;db, escmsg, t-&gt;res-&gt;message, strlen(t-&gt;res-&gt;message)) ;
+    escmsg = strdup(t-&gt;res-&gt;message);
+    dbi_conn_quote_string(t-&gt;probe-&gt;db, &amp;escmsg);
   } else {
     escmsg = strdup(&quot;&quot;);
   }
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;insert into pr_status &quot;
                     &quot;set    class =  '%u', probe = '%u', stattime = '%u', expires = '%u', &quot;
                     &quot;       color = '%u', server = '%u', message = '%s', &quot;
                     &quot;       contact = '%u', hide = '%s'&quot;,
                     t-&gt;probe-&gt;class, t-&gt;def-&gt;probeid, t-&gt;res-&gt;stattime, t-&gt;res-&gt;expires, 
                     t-&gt;def-&gt;color, t-&gt;def-&gt;server, escmsg, t-&gt;def-&gt;contact, t-&gt;def-&gt;hide);
-  mysql_free_result(result);
+  dbi_result_free(result);
   g_free(escmsg);
 }
 
@@ -193,17 +188,17 @@
 //*******************************************************************
 static void create_pr_hist(trx *t, struct probe_result *prv)
 {
-  MYSQL_RES *result;
+  dbi_result result;
   char *escmsg;
 
   if (t-&gt;res-&gt;message) {
-    escmsg = g_malloc(strlen(t-&gt;res-&gt;message) * 2 + 1);
-    mysql_real_escape_string(t-&gt;probe-&gt;db, escmsg, t-&gt;res-&gt;message, strlen(t-&gt;res-&gt;message)) ;
+    escmsg = strdup(t-&gt;res-&gt;message);
+    dbi_conn_quote_string(t-&gt;probe-&gt;db, &amp;escmsg);
   } else {
     escmsg = strdup(&quot;&quot;);
   }
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;insert into pr_hist &quot;
                     &quot;set    server = '%u', class = '%u', probe = '%u', stattime = '%u', &quot;
                     &quot;       prv_color = '%d', color = '%d', message = '%s', contact = '%u', &quot;
@@ -211,7 +206,7 @@
                     t-&gt;def-&gt;server, t-&gt;probe-&gt;class, t-&gt;def-&gt;probeid, t-&gt;res-&gt;stattime,
                     /* (t-&gt;res-&gt;received &gt; t-&gt;res-&gt;expires) ? STAT_PURPLE : */ prv-&gt;color, 
                     t-&gt;res-&gt;color, escmsg, t-&gt;def-&gt;contact, t-&gt;def-&gt;hide, t-&gt;def-&gt;pgroup);
-  mysql_free_result(result);
+  dbi_result_free(result);
   g_free(escmsg);
 }
 
@@ -220,18 +215,18 @@
 //*******************************************************************
 static void delete_history(trx *t, struct probe_result *nxt)
 {
-  MYSQL_RES *result;
+  dbi_result result;
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;delete from pr_hist &quot;
                     &quot;where stattime = '%u' and probe = '%u' and class = '%d'&quot;,
                     nxt-&gt;stattime, t-&gt;def-&gt;probeid, t-&gt;probe-&gt;class);
-  mysql_free_result(result);
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  dbi_result_free(result);
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;delete from pr_status &quot;
                     &quot;where stattime = '%u' and probe = '%u' and class = '%d'&quot;,
                     nxt-&gt;stattime, t-&gt;def-&gt;probeid, t-&gt;probe-&gt;class);
-  mysql_free_result(result);
+  dbi_result_free(result);
 }
 
 //*******************************************************************
@@ -239,7 +234,7 @@
 //*******************************************************************
 static void update_server_color(trx *t, struct probe_result *prv)
 {
-  MYSQL_RES *result;
+  dbi_result result;
   int maxcolor, newcolor;
 
   if (t-&gt;def-&gt;server &lt; 2) return;
@@ -252,24 +247,20 @@
   }
   maxcolor = newcolor; // init
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;select max(color) as color from pr_status where server = '%u'&quot;, t-&gt;def-&gt;server);
-  if (result) {
-    MYSQL_ROW row;
-    row = mysql_fetch_row(result);
-    if (row &amp;&amp; row[0]) {
-      maxcolor = atoi(row[0]);
-    }
+  if (result &amp;&amp; dbi_result_next_row(result)) {
+    maxcolor = dbi_result_get_uint(result, &quot;color&quot;);
   }
-  mysql_free_result(result);
+  dbi_result_free(result);
   //if (t-&gt;res-&gt;color &lt;= maxcolor) return;
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     // update server set color = '200' where id = '345'
                     &quot;update %s set %s = '%u' where %s = '%u'&quot;,
                      OPT_ARG(SERVER_TABLE_NAME), OPT_ARG(SERVER_TABLE_COLOR_FIELD), 
                      maxcolor, OPT_ARG(SERVER_TABLE_ID_FIELD), t-&gt;def-&gt;server);
-  mysql_free_result(result);
+  dbi_result_free(result);
 }
 
 //*******************************************************************
@@ -277,26 +268,24 @@
 //*******************************************************************
 void get_previous_pr_hist(trx *t)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
 
   t-&gt;res-&gt;changed = 0;
   strcpy(t-&gt;res-&gt;notified, &quot;yes&quot;); // if we cannot find pr_hist record, assume the user has already been warned
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;select   id, stattime, notified, prv_color &quot;
                     &quot;from     pr_hist  &quot;
                     &quot;where    probe = '%u' and class = '%u' and stattime &lt;= '%u' &quot;
                     &quot;order by stattime desc limit 1&quot;,
                     t-&gt;def-&gt;probeid, t-&gt;probe-&gt;class, t-&gt;res-&gt;stattime);
   if (!result) return;
-  row = mysql_fetch_row(result);
-  if (row) {
-    t-&gt;res-&gt;prevhistid = atoll(row[0]);
-    t-&gt;res-&gt;changed = atoi(row[1]);
-    strcpy(t-&gt;res-&gt;notified, row[2]);
-    t-&gt;res-&gt;prevhistcolor = atoi(row[3]);
+  if (dbi_result_next_row(result)) {
+    t-&gt;res-&gt;prevhistid = dbi_result_get_longlong(t-&gt;probe-&gt;db, &quot;id&quot;);
+    t-&gt;res-&gt;changed = dbi_result_get_uint(t-&gt;probe-&gt;db, &quot;stattime&quot;);
+    strcpy(t-&gt;res-&gt;notified, dbi_result_get_string(t-&gt;probe-&gt;db, &quot;notified&quot;));
+    t-&gt;res-&gt;prevhistcolor = dbi_result_get_uint(t-&gt;probe-&gt;db, &quot;prv_color&quot;);
   }
-  mysql_free_result(result);
+  dbi_result_free(result);
   return;
 }
 
@@ -305,12 +294,12 @@
 //*******************************************************************
 void set_pr_hist_notified(trx *t)
 {
-  MYSQL_RES *result;
+  dbi_result result;
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;update pr_hist set notified = 'yes' &quot;
                     &quot;where  id = '%ull'&quot;, t-&gt;res-&gt;prevhistid);
-  mysql_free_result(result);
+  dbi_result_free(result);
 }
 
 //*******************************************************************
@@ -318,8 +307,7 @@
 //*******************************************************************
 int slot_is_complete(trx *t, int i, guint slotlow, guint slothigh)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   int val = FALSE;
 
   /* 
@@ -327,18 +315,17 @@
    * so we fake it is filled, so it'll always be summarized
    */
   if (i == 0) return 1;
-  result = my_query(t-&gt;probe-&gt;db, 0,
-                    &quot;select count(*) from pr_%s_%s use index(probstat) &quot;
+  result = db_query(t-&gt;probe-&gt;db, 0,
+                    &quot;select count(*) as count from pr_%s_%s use index(probstat) &quot;
                     &quot;where  probe = '%u' and stattime &gt;= '%u' and stattime &lt;= '%u'&quot;,
                     t-&gt;res-&gt;name, summ_info[i].from, t-&gt;def-&gt;probeid, slotlow, slothigh);
   if (!result) return(FALSE);
-  row = mysql_fetch_row(result);
-  if (row &amp;&amp; row[0]) {
-    if (atoi(row[0]) &gt;= summ_info[i].perslot) {
+  if (dbi_result_next_row(result)) {
+    if (dbi_result_get_uint(result, &quot;count&quot;) &gt;= summ_info[i].perslot) {
       val = TRUE;
     }
   }
-  mysql_free_result(result);
+  dbi_result_free(result);
   return(val);
 }
 
@@ -496,11 +483,14 @@
       create_pr_hist(t, prv); // CREATE PR_HIST
     }
     if (t-&gt;res-&gt;stattime &gt; t-&gt;def-&gt;newest) { // IF THIS RAW RECORD IS THE MOST RECENT EVER RECEIVED
+      dbi_result result;
+
       if (debug &gt; 3) fprintf(stderr, &quot;THIS RAW RECORD IS THE MOST RECENT EVER RECEIVED - UPDATE PR_STATUS\n&quot;);
-      update_pr_status(t, prv);    // UPDATE PR_STATUS
-      if (mysql_affected_rows(t-&gt;probe-&gt;db) == 0) { // nothing was actually updated, need to insert new
+      result = update_pr_status(t, prv);    // UPDATE PR_STATUS
+      if (dbi_result_get_numrows_affected(result) == 0) { // nothing was actually updated, need to insert new
         insert_pr_status(t); 
       }
+      dbi_result_free(result);
       if (debug &gt; 3) fprintf(stderr, &quot;UPDATE SERVER COLOR\n&quot;);
       update_server_color(t, prv); // UPDATE SERVER COLOR
       must_update_def = TRUE;
@@ -519,11 +509,14 @@
   } else {
     if (debug &gt; 3) fprintf(stderr, &quot;COLOR SAME AS PRECEDING RAW RECORD\n&quot;);
     if (t-&gt;res-&gt;stattime &gt; t-&gt;def-&gt;newest) { // IF THIS RAW RECORD IS THE MOST RECENT EVER RECEIVED
+      dbi_result result;
+
       if (debug &gt; 3) fprintf(stderr, &quot;THIS RAW RECORD IS THE MOST RECENT EVER RECEIVED - UPDATE PR_STATUS\n&quot;);
-      update_pr_status(t, prv);  // UPDATE PR_STATUS (not for the color, but for the expiry time)
-      if (mysql_affected_rows(t-&gt;probe-&gt;db) == 0) { // nothing was actually updated, need to insert new
+      result = update_pr_status(t, prv);  // UPDATE PR_STATUS (not for the color, but for the expiry time)
+      if (dbi_result_get_numrows_affected(result) == 0) { // nothing was actually updated, need to insert new
         insert_pr_status(t); 
       }
+      dbi_result_free(result);
       must_update_def = TRUE;
     }
   }

Modified: upwatch/libdbi/uw_process/run.c
===================================================================
--- upwatch/libdbi/uw_process/run.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/run.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -30,15 +30,15 @@
 
 void update_last_seen(module *probe)
 {
-  MYSQL_RES *result;
+  dbi_result result;
 
-  result = my_query(probe-&gt;db, 0,
+  result = db_query(probe-&gt;db, 0,
                     &quot;update probe set lastseen = %u where id = '%u'&quot;,
                     probe-&gt;lastseen, probe-&gt;class);
-  if (result) mysql_free_result(result);
+  if (result) dbi_result_free(result);
 }
 
-int realm_exists(char *realm)
+int realm_exists(const char *realm)
 {
   int i;
 
@@ -57,7 +57,7 @@
   return FALSE;
 }
 
-MYSQL *open_realm(char *realm)
+dbi_conn open_realm(const char *realm)
 {
   int i;
 
@@ -66,29 +66,28 @@
     return NULL;
   }
   if (realm == NULL || realm[0] == 0) {
-    if (dblist[0].mysql) return(dblist[0].mysql);
-    dblist[0].mysql = open_database(dblist[0].host, dblist[0].port, 
+    if (dblist[0].conn) return(dblist[0].conn);
+    dblist[0].conn = open_database(OPT_ARG(DBTYPE), dblist[0].host, dblist[0].port, 
                       dblist[0].db, dblist[0].user, dblist[0].password);
-    return(dblist[0].mysql);
+    return(dblist[0].conn);
   }
 
   for (i=0; i &lt; dblist_cnt; i++) {
     if (strcmp(dblist[i].realm, realm) == 0) {
-      if (dblist[i].mysql) return(dblist[i].mysql);
-      dblist[i].mysql = open_database(dblist[i].host, dblist[i].port, 
+      if (dblist[i].conn) return(dblist[i].conn);
+      dblist[i].conn = open_database(OPT_ARG(DBTYPE), dblist[i].host, dblist[i].port, 
                         dblist[i].db, dblist[i].user, dblist[i].password);
-      return(dblist[i].mysql);
+      return(dblist[i].conn);
     }
   }
   LOG(LOG_ERR, &quot;could not find realm %s&quot;, realm);
   return(NULL);
 }
 
-int realm_server_by_name(char *realm, char *name)
+int realm_server_by_name(const char *realm, const char *name)
 {
   int i, id = -1;
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
 
   if (!dblist) {
     LOG(LOG_ERR, &quot;realm_server_by_name but no dblist found&quot;);
@@ -105,19 +104,19 @@
   }
   if (i == dblist_cnt) return id;
   if (!dblist[i].db) return id;
-  result = my_query(dblist[i].mysql, 0, dblist[i].srvrbyname, name, name, name, name, name);
+  result = db_query(dblist[i].conn, 0, dblist[i].srvrbyname, name, name, name, name, name);
   if (!result) return id;
-  row = mysql_fetch_row(result);
-  if (row) id = atoi(row[0]);
-  mysql_free_result(result);
+  if (dbi_result_next_row(result)) {
+    id = dbi_result_get_uint(result, &quot;id&quot;);
+  }
+  dbi_result_free(result);
   return(id);
 }
 
-int realm_server_by_ip(char *realm, char *ip)
+int realm_server_by_ip(const char *realm, char *ip)
 {
   int i, id = -1;
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
 
   if (!dblist) {
     LOG(LOG_ERR, &quot;realm_server_by_name but no dblist found&quot;);
@@ -134,20 +133,20 @@
   }
   if (i == dblist_cnt) return id;
   if (!dblist[i].db) return id;
-  result = my_query(dblist[i].mysql, 0, dblist[i].srvrbyip, ip, ip, ip, ip, ip);
+  result = db_query(dblist[i].conn, 0, dblist[i].srvrbyip, ip, ip, ip, ip, ip);
   if (!result) return id;
-  row = mysql_fetch_row(result);
-  if (row) id = atoi(row[0]);
-  mysql_free_result(result);
+  if (dbi_result_next_row(result)) {
+    id = dbi_result_get_uint(result, &quot;id&quot;);
+  }
+  dbi_result_free(result);
   return(id);
 }
 
-char *realm_server_by_id(char *realm, int id)
+char *realm_server_by_id(const char *realm, int id)
 {
   int i;
   char *name = NULL;
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
 
   if (!dblist) {
     LOG(LOG_ERR, &quot;realm_server_by_name but no dblist found&quot;);
@@ -164,11 +163,12 @@
   }
   if (i == dblist_cnt) return name;
   if (!dblist[i].db) return name;
-  result = my_query(dblist[i].mysql, 0, dblist[i].srvrbyid, id, id, id, id, id);
+  result = db_query(dblist[i].conn, 0, dblist[i].srvrbyid, id, id, id, id, id);
   if (!result) return name;
-  row = mysql_fetch_row(result);
-  if (row) name = strdup(row[0]);
-  mysql_free_result(result);
+  if (dbi_result_next_row(result)) {
+    id = dbi_result_get_uint(result, &quot;id&quot;);
+  }
+  dbi_result_free(result);
   return(name);
 }
 
@@ -182,17 +182,18 @@
   buf[0] = 0;
 
   for (i=0; i &lt; dblist_cnt; i++) {
-    if (dblist[i].realm) free(dblist[i].realm);
-    if (dblist[i].host) free(dblist[i].host);
-    if (dblist[i].db) free(dblist[i].db);
-    if (dblist[i].user) free(dblist[i].user);
-    if (dblist[i].password) free(dblist[i].password);
-    if (dblist[i].srvrbyname) free(dblist[i].srvrbyname);
-    if (dblist[i].srvrbyid) free(dblist[i].srvrbyid);
-    if (dblist[i].srvrbyip) free(dblist[i].srvrbyip);
+    if (dblist[i].realm) free((void *)dblist[i].realm);
+    if (dblist[i].host) free((void *)dblist[i].host);
+    if (dblist[i].port) free((void *)dblist[i].port);
+    if (dblist[i].db) free((void *)dblist[i].db);
+    if (dblist[i].user) free((void *)dblist[i].user);
+    if (dblist[i].password) free((void *)dblist[i].password);
+    if (dblist[i].srvrbyname) free((void *)dblist[i].srvrbyname);
+    if (dblist[i].srvrbyid) free((void *)dblist[i].srvrbyid);
+    if (dblist[i].srvrbyip) free((void *)dblist[i].srvrbyip);
 
-    if (dblist[i].mysql) {
-      close_database(dblist[i].mysql);
+    if (dblist[i].conn) {
+      close_database(dblist[i].conn);
     }
   }
   free(dblist);
@@ -241,61 +242,58 @@
 static void modules_start_run(void)
 {
   int i;
-  MYSQL *db;
+  dbi_conn db;
 
-  db = open_database(OPT_ARG(DBHOST), OPT_VALUE_DBPORT, OPT_ARG(DBNAME),
+  db = open_database(OPT_ARG(DBTYPE), OPT_ARG(DBHOST), OPT_ARG(DBPORT), OPT_ARG(DBNAME),
                      OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
   if (db) {
-    MYSQL_RES *result;
+    dbi_result result;
     dblist = calloc(100, sizeof(struct dbspec));
     dblist_cnt = 0;
     
-    result = my_query(db, 0, &quot;select pr_realm.name, pr_realm.host, &quot;
+    result = db_query(db, 0, &quot;select pr_realm.name, pr_realm.host, &quot;
                              &quot;       pr_realm.port, pr_realm.db, pr_realm.user, &quot;
                              &quot;       pr_realm.password, pr_realm.srvrbyname, &quot;
                              &quot;       pr_realm.srvrbyid, pr_realm.srvrbyip &quot;
                              &quot;from   pr_realm &quot;
                              &quot;where  pr_realm.id &gt; 1&quot;);
     if (result) {
-      MYSQL_ROW row;
-      while ((row = mysql_fetch_row(result)) != NULL) {
-        dblist[dblist_cnt].realm = strdup(row[0]);
-        dblist[dblist_cnt].host = strdup(row[1]);
-        dblist[dblist_cnt].port = atoi(row[2]);
-        dblist[dblist_cnt].db = strdup(row[3]);
-        dblist[dblist_cnt].user = strdup(row[4]);
-        dblist[dblist_cnt].password = strdup(row[5]);
-        dblist[dblist_cnt].srvrbyname = strdup(row[6]);
-        dblist[dblist_cnt].srvrbyid = strdup(row[7]);
-        dblist[dblist_cnt].srvrbyip = strdup(row[8]);
+      while (dbi_result_next_row(result)) {
+        dblist[dblist_cnt].realm = dbi_result_get_string_copy(result, &quot;name&quot;);
+        dblist[dblist_cnt].host = dbi_result_get_string_copy(result, &quot;host&quot;);
+        dblist[dblist_cnt].port = dbi_result_get_string_copy(result, &quot;port&quot;);
+        dblist[dblist_cnt].db = dbi_result_get_string_copy(result, &quot;db&quot;);
+        dblist[dblist_cnt].user = dbi_result_get_string_copy(result, &quot;user&quot;);
+        dblist[dblist_cnt].password = dbi_result_get_string_copy(result, &quot;password&quot;);
+        dblist[dblist_cnt].srvrbyname = dbi_result_get_string_copy(result, &quot;srvrbyname&quot;);
+        dblist[dblist_cnt].srvrbyid = dbi_result_get_string_copy(result, &quot;srvrbyid&quot;);
+        dblist[dblist_cnt].srvrbyip = dbi_result_get_string_copy(result, &quot;srvrbyip&quot;);
         dblist_cnt++;
       }
-      mysql_free_result(result);
+      dbi_result_free(result);
     }
     close_database(db);
   }
 
   for (i = 0; modules[i]; i++) {
-    MYSQL_RES *result;
+    dbi_result result;
 
     modules[i]-&gt;filecount = 0;
     modules[i]-&gt;resultcount = 0;
     modules[i]-&gt;errors = 0;
 
-    modules[i]-&gt;db = open_database(OPT_ARG(DBHOST), OPT_VALUE_DBPORT, OPT_ARG(DBNAME),
+    modules[i]-&gt;db = open_database(OPT_ARG(DBTYPE), OPT_ARG(DBHOST), OPT_ARG(DBPORT), OPT_ARG(DBNAME),
                                    OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
     if (modules[i]-&gt;db) {
-      result = my_query(modules[i]-&gt;db, 0, &quot;select fuse, lastseen from probe where id = '%d'&quot;, modules[i]-&gt;class);
+      result = db_query(modules[i]-&gt;db, 0, &quot;select fuse, lastseen from probe where id = '%d'&quot;, modules[i]-&gt;class);
       if (result) {
-        MYSQL_ROW row;
-        row = mysql_fetch_row(result);
-        if (row) {
-          if (row[0]) modules[i]-&gt;fuse  = (strcmp(row[0], &quot;yes&quot;) == 0) ? 1 : 0;
-          if (row[1]) modules[i]-&gt;lastseen = atoi(row[1]);
+        if (dbi_result_next_row(result)) {
+          modules[i]-&gt;fuse  = (strcmp(dbi_result_get_string(result, &quot;fuse&quot;), &quot;yes&quot;) == 0) ? 1 : 0;
+          modules[i]-&gt;lastseen = dbi_result_get_uint(result, &quot;lastseen&quot;);
         } else {
           LOG(LOG_NOTICE, &quot;probe record for id %u not found&quot;, modules[i]-&gt;class);
         }
-        mysql_free_result(result);
+        dbi_result_free(result);
       }
       close_database(modules[i]-&gt;db);
       modules[i]-&gt;db = NULL;
@@ -395,7 +393,7 @@
   if (HAVE_OPT(TRUST)) {
     int i, found=0;
     int     ct  = STACKCT_OPT( TRUST );
-    char**  pn = STACKLST_OPT( TRUST );
+    const char**  pn = STACKLST_OPT( TRUST );
 
     while (ct--) {
       for (i=0; modules[i]; i++) {
@@ -458,7 +456,7 @@
 {
   int trust;
   int     ct  = STACKCT_OPT( TRUST );
-  char**  pn = STACKLST_OPT( TRUST );
+  const char**  pn = STACKLST_OPT( TRUST );
 
   for (trust=0; trust &lt; ct; trust++) {
     if (strcmp(pn[trust], &quot;all&quot;) == 0) {
@@ -526,7 +524,7 @@
     trx t;
     int j;
     int output_ct = STACKCT_OPT(OUTPUT);
-    char **output_pn = STACKLST_OPT(OUTPUT);
+    const char **output_pn = STACKLST_OPT(OUTPUT);
     char *filebase;
 
     filebase = strrchr((char *)g_ptr_array_index(arr,i), '/');
@@ -589,7 +587,7 @@
 {
   int i;
   int     ct  = STACKCT_OPT( INPUT );
-  char**  pn = STACKLST_OPT( INPUT );
+  const char**  pn = STACKLST_OPT( INPUT );
 
   childpidcnt = ct;
   if (debug &gt; 2) fprintf(stderr, &quot;pondering..\n&quot;);
@@ -617,22 +615,19 @@
   } 
 
   for (i = 0; modules[i]; i++) {
-    modules[i]-&gt;db = open_database(OPT_ARG(DBHOST), OPT_VALUE_DBPORT, OPT_ARG(DBNAME),
+    modules[i]-&gt;db = open_database(OPT_ARG(DBTYPE), OPT_ARG(DBHOST), OPT_ARG(DBPORT), OPT_ARG(DBNAME),
                                    OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
     if (modules[i]-&gt;db) {
-      MYSQL_RES *result;
+      dbi_result result;
 
-      result = my_query(modules[i]-&gt;db, 0, &quot;select lastseen, maxlag, lagwarn from probe where id = '%u'&quot;, 
+      result = db_query(modules[i]-&gt;db, 0, &quot;select lastseen, maxlag, lagwarn from probe where id = '%u'&quot;, 
                                            modules[i]-&gt;class);
       if (result) {
-        MYSQL_ROW row;
-
-        row = mysql_fetch_row(result);
-        if (row &amp;&amp; row[0]) {
+        if (dbi_result_next_row(result)) {
           unsigned now;
-          int lastseen = atoi(row[0]);
-          int maxlag = atoi(row[1]);
-          int lagwarn = strcmp(row[2], &quot;yes&quot;) == 0;
+          int lastseen = dbi_result_get_uint(result, &quot;lastseen&quot;);
+          int maxlag = dbi_result_get_uint(result, &quot;maxlag&quot;);
+          int lagwarn = strcmp(dbi_result_get_string(result, &quot;lagwarn&quot;), &quot;yes&quot;) == 0;
 
           now = (int) time(NULL);
           if ((now - lastseen) &gt; maxlag) {
@@ -641,7 +636,7 @@
 
               sprintf(subject, &quot;UPWATCH: probe %s is lagging in processing&quot;, modules[i]-&gt;module_name);
               mail(OPT_ARG(NOC_MAIL), subject, subject, (time_t)NULL);
-              my_query(modules[i]-&gt;db, 0, &quot;update probe set lagwarn = 'yes' where id = '%u'&quot;,
+              db_query(modules[i]-&gt;db, 0, &quot;update probe set lagwarn = 'yes' where id = '%u'&quot;,
                                            modules[i]-&gt;class);
             }
           } else {
@@ -650,14 +645,14 @@
 
               sprintf(subject, &quot;UPWATCH: probe %s is up-to-date again&quot;, modules[i]-&gt;module_name);
               mail(OPT_ARG(NOC_MAIL), subject, subject, (time_t)NULL);
-              my_query(modules[i]-&gt;db, 0, &quot;update probe set lagwarn = 'no' where id = '%u'&quot;,
+              db_query(modules[i]-&gt;db, 0, &quot;update probe set lagwarn = 'no' where id = '%u'&quot;,
                                            modules[i]-&gt;class);
             }
           }
         } else {
           LOG(LOG_NOTICE, &quot;probe record for id %u not found&quot;, modules[i]-&gt;class);
         }
-        mysql_free_result(result);
+        dbi_result_free(result);
       }
       close_database(modules[i]-&gt;db);
       modules[i]-&gt;db = NULL;
@@ -696,14 +691,13 @@
   trx t;
   struct probe_result res;
   struct probe_def def;
-  MYSQL *mysql;
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_conn conn;
+  dbi_result result;
 extern int forever;
   guint lowtime, hightime; 
   char *p;
 
-  res.name = strtok(OPT_ARG(SUMMARIZE), &quot;,&quot;);
+  res.name = strtok((char *)OPT_ARG(SUMMARIZE), &quot;,&quot;);
   lowtime = 0;
   hightime = time(NULL);
   p = strtok(NULL, &quot;,&quot;);
@@ -739,34 +733,33 @@
     return 0;
   }
 
-  mysql = open_database(OPT_ARG(DBHOST), OPT_VALUE_DBPORT, OPT_ARG(DBNAME), 
+  conn = open_database(OPT_ARG(DBTYPE), OPT_ARG(DBHOST), OPT_ARG(DBPORT), OPT_ARG(DBNAME), 
 			OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
-  if (!mysql) {
+  if (!conn) {
     return 0;
   }
   modules_start_run();
   found = 0;
-  result = my_query(mysql, 1, &quot;select id, server from pr_%s_def where id &gt; 1&quot;, res.name);
+  result = db_query(conn, 1, &quot;select id, server from pr_%s_def where id &gt; 1&quot;, res.name);
   if (result == NULL) return(0);
-  while ((row = mysql_fetch_row(result)) &amp;&amp; forever) {
-    MYSQL_RES *presult;
-    MYSQL_ROW prow;
+  while (dbi_result_next_row(result) &amp;&amp; forever) {
+    dbi_result presult;
 
-    def.probeid = atoi(row[0]);
-    def.server = atoi(row[1]);
+    def.probeid = dbi_result_get_uint(result, &quot;id&quot;);
+    def.server = dbi_result_get_uint(result, &quot;server&quot;);
     //printf(&quot;%u server %u\n&quot;, def.probeid, def.server);
 
-    presult = my_query(mysql, 1, &quot;select stattime from pr_%s_raw where probe = '%u' &quot;
+    presult = db_query(conn, 1, &quot;select stattime from pr_%s_raw where probe = '%u' &quot;
                                  &quot;and stattime &gt;= '%u' and stattime &lt;= '%u'&quot;, 
                                  res.name, def.probeid, lowtime, hightime);
     if (presult == NULL) continue;
-    while ((prow = mysql_fetch_row(presult)) &amp;&amp; forever) {
+    while (dbi_result_next_row(presult) &amp;&amp; forever) {
       guint cur_slot, prev_slot;
       gulong dummy_low, dummy_high;
       gulong slotlow, slothigh;
       int i;
 
-      res.stattime = atoi(prow[0]);
+      res.stattime  = dbi_result_get_uint(presult, &quot;stattime&quot;);
       if (def.newest == 0) def.newest = res.stattime;
       found++;
 
@@ -788,12 +781,12 @@
         if (debug &gt; 2) { fprintf(stderr, &quot;%8u records processed\r&quot;, found); }
       }
     }
-    mysql_free_result(presult);
+    dbi_result_free(presult);
 
   }
-  mysql_free_result(result);
+  dbi_result_free(result);
   modules_end_run();
-  close_database(mysql);
+  close_database(conn);
   return(found);
 }
 

Modified: upwatch/libdbi/uw_process/snmpget.c
===================================================================
--- upwatch/libdbi/uw_process/snmpget.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/snmpget.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -27,27 +27,38 @@
 //*******************************************************************
 // Get the results of the MySQL query into our probe_def structure
 //*******************************************************************
-static void snmpget_set_def_fields(trx *t, struct probe_def *probedef, MYSQL_RES *result)
+static void snmpget_set_def_fields(trx *t, struct probe_def *probedef, dbi_result result)
 {
   struct snmpget_def *def = (struct snmpget_def *) probedef;
-  MYSQL_ROW row = mysql_fetch_row(result);
 
-  if (row) {
-    if (row[0]) def-&gt;ipaddress = strdup(row[0]);
-    if (row[1]) def-&gt;description = strdup(row[1]);
-    if (row[2]) def-&gt;server   = atoi(row[2]);
-    if (row[3]) def-&gt;yellow   = atof(row[3]);
-    if (row[4]) def-&gt;red      = atof(row[4]);
-    if (row[5]) def-&gt;contact  = atof(row[5]);
-    strcpy(def-&gt;hide, row[6] ? row[6] : &quot;no&quot;);
-    strcpy(def-&gt;email, row[7] ? row[7] : &quot;&quot;);
-    if (row[8]) def-&gt;delay = atoi(row[8]);
-    if (row[9]) def-&gt;community = strdup(row[9]);  /* community string for SNMPv1/v2c transactions */
-    if (row[10]) def-&gt;OID = strdup(row[10]);      /* Object ID */
-    if (row[11]) def-&gt;dispname = strdup(row[11]); /* Display Name */
-    if (row[12]) def-&gt;dispunit = strdup(row[12]); /* Display Unit */
-    if (row[13]) def-&gt;multiplier = atof(row[13]); /* Multiplier for result values */
-    if (row[14]) strcpy(def-&gt;mode, row[14]);      /* plot absolute or relative values */
+  if (dbi_result_next_row(result)) {
+    def-&gt;ipaddress   = dbi_result_get_string_copy_idx(result, 0);
+    def-&gt;description = dbi_result_get_string_copy_idx(result, 1);
+    def-&gt;server   = dbi_result_get_uint_idx(result, 2);
+    def-&gt;yellow   = dbi_result_get_float_idx(result, 3);
+    def-&gt;red      = dbi_result_get_float_idx(result, 4);
+    def-&gt;contact  = dbi_result_get_float_idx(result, 5);
+    if (dbi_result_get_string_idx(result, 6)) {
+      strcpy(def-&gt;hide, dbi_result_get_string_idx(result, 6));
+    } else {
+      strcpy(def-&gt;hide, &quot;no&quot;);
+    }
+    if (dbi_result_get_string_idx(result, 7)) {
+      strcpy(def-&gt;email, dbi_result_get_string_idx(result, 7));
+    } else {
+      strcpy(def-&gt;email, &quot;&quot;);
+    }
+    def-&gt;delay = dbi_result_get_uint_idx(result, 8);
+    def-&gt;community = dbi_result_get_string_copy_idx(result, 9); /* community string for SNMPv1/v2c transactions */
+    def-&gt;OID = dbi_result_get_string_copy_idx(result, 10);      /* Object ID */
+    def-&gt;dispname = dbi_result_get_string_copy_idx(result, 11); /* Display Name */
+    def-&gt;dispunit = dbi_result_get_string_copy_idx(result, 12); /* Display Unit */
+    def-&gt;multiplier = dbi_result_get_float_idx(result, 13);     /* Multiplier for result values */
+    if (dbi_result_get_string_idx(result, 14)) {
+      strcpy(def-&gt;mode, dbi_result_get_string_idx(result, 14)); /* plot absolute or relative values */
+    } else {
+      strcpy(def-&gt;mode, &quot;&quot;);
+    }
   }
 }
 
@@ -56,21 +67,23 @@
 //*******************************************************************
 static gint snmpget_store_raw_result(trx *t)
 {
-  MYSQL_RES *result;
+  dbi_result result;
   struct snmpget_result *res = (struct snmpget_result *)t-&gt;res;
   struct probe_def *def = (struct probe_def *)t-&gt;def;
   char *escmsg;
+  const char *errmsg;
+  int lasterr;
 
   if (t-&gt;res-&gt;color == STAT_PURPLE) return 1;
   t-&gt;seen_before = FALSE;
   if (res-&gt;message) {
-    escmsg = g_malloc(strlen(res-&gt;message) * 2 + 1);
-    mysql_real_escape_string(t-&gt;probe-&gt;db, escmsg, res-&gt;message, strlen(res-&gt;message)) ;
+    escmsg = strdup(res-&gt;message);
+    dbi_conn_quote_string(t-&gt;probe-&gt;db, &amp;escmsg);
   } else {
     escmsg = strdup(&quot;&quot;);
   }
     
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;insert into pr_snmpget_raw &quot;
                     &quot;set    probe = '%u', yellow = '%f', red = '%f', stattime = '%u', color = '%u', &quot;
                     &quot;       value = '%f', &quot;
@@ -78,10 +91,11 @@
                     def-&gt;probeid, def-&gt;yellow, def-&gt;red, res-&gt;stattime, res-&gt;color, 
                     res-&gt;value, escmsg);
   g_free(escmsg);
-  if (result) mysql_free_result(result);
-  if (mysql_errno(t-&gt;probe-&gt;db) == ER_DUP_ENTRY) {
+  if (result) dbi_result_free(result);
+  lasterr = dbi_conn_error(t-&gt;probe-&gt;db, &amp;errmsg);
+  if (errmsg &amp;&amp; (lasterr == 1062)) { // MySQL ER_DUP_ENTRY(1062)
     t-&gt;seen_before = TRUE;
-  } else if (mysql_errno(t-&gt;probe-&gt;db)) {
+  } else if (lasterr &gt; -1) { // otther error
     return 0; // other failure
   }
   return 1; // success
@@ -129,8 +143,7 @@
 //*******************************************************************
 static void snmpget_summarize(trx *t, char *from, char *into, guint slot, guint slotlow, guint slothigh, gint resummarize)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   struct probe_def *def = (struct probe_def *)t-&gt;def;
   float avg_yellow, avg_red;
   float avg_value;
@@ -139,48 +152,47 @@
 
   stattime = slotlow + ((slothigh-slotlow)/2);
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
-                    &quot;select avg(value), &quot;
-                    &quot;       max(color), avg(yellow), avg(red) &quot;
+  result = db_query(t-&gt;probe-&gt;db, 0,
+                    &quot;select avg(value) as avg_value, &quot;
+                    &quot;       max(color) as max_color, avg(yellow) as avg_yellow, avg(red) as avg_red &quot;
                     &quot;from   pr_snmpget_%s use index(probstat) &quot;
                     &quot;where  probe = '%d' and stattime &gt;= %d and stattime &lt; %d&quot;,
                     from, def-&gt;probeid, slotlow, slothigh);
 
   if (!result) return;
-  if (mysql_num_rows(result) == 0) { // no records found
+  if (dbi_result_get_numrows(result) == 0) { // no records found
     LOG(LOG_NOTICE, &quot;nothing to summarize from %s for probe %u %u %u&quot;,
                        from, def-&gt;probeid, slotlow, slothigh);
-    mysql_free_result(result);
+    dbi_result_free(result);
     return;
   }
 
-  row = mysql_fetch_row(result);
-  if (!row) {
-    mysql_free_result(result);
+  if (!dbi_result_next_row(result)) {
+    dbi_result_free(result);
     return;
   }
-  if (row[0] == NULL) {
+  if (dbi_result_get_string(result, &quot;avg_value&quot;) == NULL) {
     LOG(LOG_NOTICE, &quot;nothing to summarize from %s for probe %u %u %u&quot;, 
                        from, def-&gt;probeid, slotlow, slothigh);
-    mysql_free_result(result);
+    dbi_result_free(result);
     return;
   }
 
-  avg_value = atof(row[0]);
-  max_color   = atoi(row[1]);
-  avg_yellow  = atof(row[2]);
-  avg_red     = atof(row[3]);
-  mysql_free_result(result);
+  avg_value   = dbi_result_get_float(result, &quot;avg_value&quot;);
+  max_color   = dbi_result_get_uint(result, &quot;max_color&quot;);
+  avg_yellow  = dbi_result_get_float(result, &quot;avg_yellow&quot;);
+  avg_red     = dbi_result_get_float(result, &quot;avg_red&quot;);
+  dbi_result_free(result);
 
   if (resummarize) {
     // delete old values
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;delete from pr_snmpget_%s where probe = '%u' and stattime = '%u'&quot;,
                     into, def-&gt;probeid, stattime);
-    mysql_free_result(result);
+    dbi_result_free(result);
   }
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;insert into pr_snmpget_%s &quot;
                     &quot;set    value = '%f', &quot;
                     &quot;       probe = %d, color = '%u', stattime = %d, &quot;
@@ -188,7 +200,7 @@
                     into, avg_value, def-&gt;probeid, 
                     max_color, stattime, avg_yellow, avg_red, slot);
 
-  mysql_free_result(result);
+  dbi_result_free(result);
 }
 
 module snmpget_module  = {

Modified: upwatch/libdbi/uw_process/sysstat.c
===================================================================
--- upwatch/libdbi/uw_process/sysstat.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/sysstat.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -13,21 +13,23 @@
 //*******************************************************************
 static gint sysstat_store_raw_result(trx *t)
 {
-  MYSQL_RES *result;
+  dbi_result result;
   struct sysstat_result *res = (struct sysstat_result *)t-&gt;res;
   struct probe_def *def = (struct probe_def *)t-&gt;def;
   char *escmsg;
+  const char *errmsg;
+  int lasterr;
 
   if (t-&gt;res-&gt;color == STAT_PURPLE) return 1;
   t-&gt;seen_before = FALSE;
   if (res-&gt;message) {
-    escmsg = g_malloc(strlen(res-&gt;message) * 2 + 1);
-    mysql_real_escape_string(t-&gt;probe-&gt;db, escmsg, res-&gt;message, strlen(res-&gt;message)) ;
+    escmsg = strdup(res-&gt;message);
+    dbi_conn_quote_string(t-&gt;probe-&gt;db, &amp;escmsg);
   } else {
     escmsg = strdup(&quot;&quot;);
   }
     
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;insert into pr_sysstat_raw &quot;
                     &quot;set    probe = '%u', yellow = '%f', red = '%f', stattime = '%u', color = '%u', &quot;
                     &quot;       loadavg = '%f', user = '%u', system = '%u', idle = '%u', &quot;
@@ -40,11 +42,12 @@
                     res-&gt;swapped, res-&gt;free, res-&gt;buffered, res-&gt;cached,
                     res-&gt;used, res-&gt;systemp, escmsg);
   g_free(escmsg);
-  if (result) mysql_free_result(result);
-  if (mysql_errno(t-&gt;probe-&gt;db) == ER_DUP_ENTRY) {
+  if (result) dbi_result_free(result);
+  lasterr = dbi_conn_error(t-&gt;probe-&gt;db, &amp;errmsg);
+  if (errmsg &amp;&amp; (lasterr == 1062)) { // MySQL ER_DUP_ENTRY(1062)
     t-&gt;seen_before = TRUE;
-  } else if (mysql_errno(t-&gt;probe-&gt;db)) {
-    LOG(LOG_WARNING, &quot;%s:[%u] %s&quot;, &quot;insert into pr_sysstat_raw&quot;, mysql_errno(t-&gt;probe-&gt;db), mysql_error(t-&gt;probe-&gt;db));
+  } else if (lasterr &gt; -1) { // other error
+    LOG(LOG_WARNING, &quot;%s: %s&quot;, &quot;insert into pr_sysstat_raw&quot;, errmsg);
     return 0; // other failure
   }
   return 1; // success
@@ -55,8 +58,7 @@
 //*******************************************************************
 static void sysstat_summarize(trx *t, char *from, char *into, guint slot, guint slotlow, guint slothigh, gint resummarize)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   struct probe_def *def = (struct probe_def *)t-&gt;def;
   gfloat avg_yellow, avg_red;
   gfloat avg_loadavg;
@@ -68,62 +70,64 @@
 
   stattime = slotlow + ((slothigh-slotlow)/2);
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
-                    &quot;select avg(loadavg), avg(user), avg(system), avg(idle), &quot;
-                    &quot;       avg(swapin), avg(swapout), avg(blockin), avg(blockout), &quot;
-                    &quot;       avg(swapped), avg(free), avg(buffered), avg(cached), &quot;
-                    &quot;       avg(used), avg(systemp), max(color), avg(yellow), avg(red) &quot; 
+  result = db_query(t-&gt;probe-&gt;db, 0,
+                    &quot;select avg(loadavg) as avg_loadavg, avg(user) as avg_user, avg(system) as avg_system, &quot;
+                    &quot;       avg(idle) as avg_idle, avg(swapin) as avg_swapin, avg(swapout) as avg_swapout, &quot;
+                    &quot;       avg(blockin) as avg_blockin, avg(blockout) as avg_blockout, &quot;
+                    &quot;       avg(swapped) as avg_swapped, avg(free) as avg_free, &quot;
+                    &quot;       avg(buffered) as avg_buffered, avg(cached) as avg_cached, &quot;
+                    &quot;       avg(used) as avg_used, avg(systemp) as avg_systemp, max(color) as max_color, &quot;
+                    &quot;       avg(yellow) as avg_yellow, avg(red) as avg_red &quot; 
                     &quot;from   pr_sysstat_%s use index(probstat) &quot;
                     &quot;where  probe = '%d' and stattime &gt;= %d and stattime &lt; %d&quot;,
                     from, def-&gt;probeid, slotlow, slothigh);
   
   if (!result) return;
-  if (mysql_num_rows(result) == 0) { // no records found
+  if (dbi_result_get_numrows(result) == 0) { // no records found
     LOG(LOG_NOTICE, &quot;nothing to summarize from %s for probe %u %u %u&quot;, 
                        from, def-&gt;probeid, slotlow, slothigh);
-    mysql_free_result(result);
+    dbi_result_free(result);
     return;
   }
-  row = mysql_fetch_row(result);
-  if (!row) {
-    mysql_free_result(result);
+  if (!dbi_result_next_row(result)) {
+    dbi_result_free(result);
     return;
   }
-  if (row[0] == NULL) {
+  if (dbi_result_get_string(result, &quot;avg_lowest&quot;) == NULL) {
     LOG(LOG_NOTICE, &quot;NULL values found in summarizing from %s for probe %u %u %u&quot;, 
                       from, def-&gt;probeid, slotlow, slothigh);
-    mysql_free_result(result);
+    dbi_result_free(result);
     return;
   }
 
-  avg_loadavg = atof(row[0]);
-  avg_user    = atoi(row[1]);
-  avg_system  = atoi(row[2]);
-  avg_idle    = atoi(row[3]);
-  avg_swapin  = atoi(row[4]);
-  avg_swapout = atoi(row[5]);
-  avg_blockin = atoi(row[6]);
-  avg_blockout= atoi(row[7]);
-  avg_swapped = atoi(row[8]);
-  avg_free    = atoi(row[9]);
-  avg_buffered= atoi(row[10]);
-  avg_cached  = atoi(row[11]);
-  avg_used    = atoi(row[12]);
-  avg_systemp = atoi(row[13]);
-  max_color   = atoi(row[14]);
-  avg_yellow  = atof(row[15]);
-  avg_red     = atof(row[16]);
-  mysql_free_result(result);
+  avg_loadavg = dbi_result_get_float(result, &quot;avg_loadavg&quot;);
+  avg_user    = dbi_result_get_uint(result, &quot;avg_user&quot;);
+  avg_system  = dbi_result_get_uint(result, &quot;avg_system&quot;);
+  avg_idle    = dbi_result_get_uint(result, &quot;avg_idle&quot;);
+  avg_swapin  = dbi_result_get_uint(result, &quot;avg_swapin&quot;);
+  avg_swapout = dbi_result_get_uint(result, &quot;avg_swapout&quot;);
+  avg_blockin = dbi_result_get_uint(result, &quot;avg_blockin&quot;);
+  avg_blockout= dbi_result_get_uint(result, &quot;avg_blockout&quot;);
+  avg_swapped = dbi_result_get_uint(result, &quot;avg_swapped&quot;);
+  avg_free    = dbi_result_get_uint(result, &quot;avg_free&quot;);
+  avg_buffered= dbi_result_get_uint(result, &quot;avg_buffered&quot;);
+  avg_cached  = dbi_result_get_uint(result, &quot;avg_cached&quot;);
+  avg_used    = dbi_result_get_uint(result, &quot;avg_used&quot;);
+  avg_systemp = dbi_result_get_uint(result, &quot;avg_systemp&quot;);
+  max_color   = dbi_result_get_uint(result, &quot;max_color&quot;);
+  avg_yellow  = dbi_result_get_float(result, &quot;avg_yellow&quot;);
+  avg_red     = dbi_result_get_float(result, &quot;avg_red&quot;);
+  dbi_result_free(result);
 
   if (resummarize) {
     // delete old values
-    result = my_query(t-&gt;probe-&gt;db, 0,
+    result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;delete from pr_sysstat_%s where probe = '%u' and stattime = '%u'&quot;,
                     into, def-&gt;probeid, stattime);
-    mysql_free_result(result);
+    dbi_result_free(result);
   }
 
-  result = my_query(t-&gt;probe-&gt;db, 0,
+  result = db_query(t-&gt;probe-&gt;db, 0,
                     &quot;insert into pr_sysstat_%s &quot; 
                     &quot;set    loadavg = '%f', user = '%u', system = '%u', idle = '%u', &quot;
                     &quot;       swapin = '%u', swapout = '%u', blockin = '%u', blockout = '%u', &quot;
@@ -136,7 +140,7 @@
                     avg_swapped, avg_free, avg_buffered, avg_cached, 
                     avg_used, avg_systemp, def-&gt;probeid, max_color, stattime,
                     avg_yellow, avg_red, slot);
-  mysql_free_result(result);
+  dbi_result_free(result);
 }
 
 module sysstat_module  = {

Modified: upwatch/libdbi/uw_process/tcpconnect.c
===================================================================
--- upwatch/libdbi/uw_process/tcpconnect.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/tcpconnect.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -11,22 +11,29 @@
 //*******************************************************************
 // Get the results of the MySQL query into our probe_def structure
 //*******************************************************************
-static void tcpconnect_set_def_fields(trx *t, struct probe_def *probedef, MYSQL_RES *result)
+static void tcpconnect_set_def_fields(trx *t, struct probe_def *probedef, dbi_result result)
 {
   struct tcpconnect_def *def = (struct tcpconnect_def *) probedef;
-  MYSQL_ROW row = mysql_fetch_row(result);
 
-  if (row) {
-    if (row[0]) def-&gt;ipaddress   = strdup(row[0]);
-    if (row[1]) def-&gt;description = strdup(row[1]);
-    if (row[2]) def-&gt;server   = atoi(row[2]);
-    if (row[3]) def-&gt;yellow   = atof(row[3]);
-    if (row[4]) def-&gt;red      = atof(row[4]);
-    if (row[5]) def-&gt;contact  = atof(row[5]);
-    strcpy(def-&gt;hide, row[6] ? row[6] : &quot;no&quot;);
-    strcpy(def-&gt;email, row[7] ? row[7] : &quot;&quot;);
-    if (row[8]) def-&gt;delay = atoi(row[8]);
-    if (row[9]) def-&gt;port = atoi(row[9]);
+  if (dbi_result_next_row(result)) {
+    def-&gt;ipaddress   = dbi_result_get_string_copy_idx(result, 0);
+    def-&gt;description = dbi_result_get_string_copy_idx(result, 1);
+    def-&gt;server   = dbi_result_get_uint_idx(result, 2);
+    def-&gt;yellow   = dbi_result_get_float_idx(result, 3);
+    def-&gt;red      = dbi_result_get_float_idx(result, 4);
+    def-&gt;contact  = dbi_result_get_float_idx(result, 5);
+    if (dbi_result_get_string_idx(result, 6)) {
+      strcpy(def-&gt;hide, dbi_result_get_string_idx(result, 6));
+    } else {
+      strcpy(def-&gt;hide, &quot;no&quot;);
+    }
+    if (dbi_result_get_string_idx(result, 7)) {
+      strcpy(def-&gt;email, dbi_result_get_string_idx(result, 7));
+    } else {
+      strcpy(def-&gt;email, &quot;&quot;);
+    }
+    def-&gt;delay = dbi_result_get_uint_idx(result, 8);
+    def-&gt;port = dbi_result_get_uint_idx(result, 9);
   }
 }
 

Modified: upwatch/libdbi/uw_process/uw_process.def
===================================================================
--- upwatch/libdbi/uw_process/uw_process.def	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/uw_process.def	2006-07-21 20:34:40 UTC (rev 632)
@@ -14,7 +14,7 @@
 
 // this section is for the generated specfile
 spec-buildrequires = &quot;libesmtp-devel&quot;;
-spec-requires = &quot;/usr/bin/mysql glib2&quot;;
+spec-requires = &quot;libdbi &gt;= 0.8 glib2&quot;;
 spec-files = `echo &quot;%attr(0770,root,upwatch)&quot; $sbindir/uw_process`;
 spec-files = `echo &quot;%attr(0770,root,upwatch) %dir &quot; $spooldir/q_failed`;
 spec-files = `echo &quot;%attr(0770,root,upwatch) %dir &quot; $spooldir/q_failed/new`;
@@ -56,7 +56,6 @@
 about maildir see <A HREF="http://www.qmail.org/man/man5/maildir.html.">http://www.qmail.org/man/man5/maildir.html.</A>';
 };
 
-// describe commandline flags
 flag = {
     name      = input;
     value     = I;
@@ -82,6 +81,15 @@
 };
 
 flag = {
+    name      = realm;
+    value     = R;
+    arg_type  = string;
+    descrip   = &quot;ignored&quot;;
+    doc       =
+'uw_process ignores this parameter when it encounters it in fir example upwatch.conf';
+};
+
+flag = {
     name      = failures;
     value     = f;
     arg_type  = string;

Modified: upwatch/libdbi/uw_process/uw_process_glob.h
===================================================================
--- upwatch/libdbi/uw_process/uw_process_glob.h	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/uw_process_glob.h	2006-07-21 20:34:40 UTC (rev 632)
@@ -48,27 +48,27 @@
                          guint slot, guint slotlow, guint slothigh, gint resummarize);
 
 struct dbspec {
-  char *realm;
-  char *host;
-  int port;
-  char *db;
-  char *user;
-  char *password;
-  char *srvrbyname; // query to retrieve the server id given the server name
-  char *srvrbyid;   // query to retrieve the server name given the server id
-  char *srvrbyip;   // query to retrieve the server id given the ipaddress
-  MYSQL *mysql;
+  const char *realm;
+  const char *host;
+  const char *port;
+  const char *db;
+  const char *user;
+  const char *password;
+  const char *srvrbyname; // query to retrieve the server id given the server name
+  const char *srvrbyid;   // query to retrieve the server name given the server id
+  const char *srvrbyip;   // query to retrieve the server id given the ipaddress
+  dbi_conn conn;
 };
 extern struct dbspec *dblist;
 extern int dblist_cnt;
 
-int realm_exists(char *realm);
-MYSQL *open_realm(char *realm);
-int realm_server_by_name(char *realm, char *name);
-char *realm_server_by_id(char *realm, int id);
-int realm_server_by_ip(char *realm, char *ip);
+int realm_exists(const char *realm);
+dbi_conn open_realm(const char *realm);
+int realm_server_by_name(const char *realm, const char *name);
+char *realm_server_by_id(const char *realm, int id);
+int realm_server_by_ip(const char *realm, char *ip);
 
-int mail(char *to, char *subject, char *body, time_t date);
+int mail(const char *to, const char *subject, const char *body, time_t date);
 
 #endif /* __UW_PROCESS_GLOB_H */
 

Modified: upwatch/libdbi/uw_process/uw_tnot.def
===================================================================
--- upwatch/libdbi/uw_process/uw_tnot.def	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_process/uw_tnot.def	2006-07-21 20:34:40 UTC (rev 632)
@@ -13,7 +13,7 @@
 'uw_process reads probe resultfiles, and stores them in the database';
 
 // this section is for the generated specfile
-spec-requires = &quot;/usr/bin/mysql glib2&quot;;
+spec-requires = &quot;libdbi &gt;= 0.8 glib2&quot;;
 spec-files = `echo &quot;%attr(0770,root,upwatch)&quot; $sbindir/uw_process`;
 spec-files = `echo &quot;%attr(0770,root,upwatch) %dir &quot; $spooldir/uw_process`;
 spec-files = `echo &quot;%attr(0770,root,upwatch) %dir &quot; $spooldir/uw_process/new`;

Modified: upwatch/libdbi/uw_purple/Makefile.am
===================================================================
--- upwatch/libdbi/uw_purple/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_purple/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -7,8 +7,8 @@
 init_DATA = $(INITFILES)
 
 uw_purple_SOURCES = run.c uw_purple.h uw_purple.c  $(SPECFILES) $(INITFILES)
-uw_purple_CFLAGS = @MYSQL_CFLAGS@ @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
-uw_purple_LDADD = uw_purple_$(DB_O) uw_purple_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) @MYSQL_LIBS@ @LIBGLIB2_LIBS@
+uw_purple_CFLAGS = @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
+uw_purple_LDADD = uw_purple_$(DB_O) uw_purple_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) @LIBDBI_LIBS@ @LIBGLIB2_LIBS@
 
 BUILT_SOURCES = $(program:%=%.1) $(program:%=%.h) $(program:%=%.c) $(SPECFILES) $(INITFILES)
 INCLUDES = -I../upwatch

Modified: upwatch/libdbi/uw_purple/run.c
===================================================================
--- upwatch/libdbi/uw_purple/run.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_purple/run.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -8,12 +8,12 @@
 
 struct dbspec {
   int domid;
-  char *realm;
-  char *host;
+  const char *realm;
+  const char *host;
   int port;
-  char *db;
-  char *user;
-  char *password;
+  const char *db;
+  const char *user;
+  const char *password;
 };
 
 int init(void)
@@ -32,44 +32,47 @@
 {
   xmlDocPtr doc;
   xmlNodePtr probe;
-  MYSQL_RES *result;
-  MYSQL_ROW row;
-  MYSQL *db;
+  dbi_result result;
+  dbi_conn conn;
   int count = 0;
+  char buf[10];
 
-  db = open_database(dbspec-&gt;host, dbspec-&gt;port, dbspec-&gt;db,
+  sprintf(buf, &quot;%d&quot;, dbspec-&gt;port);
+
+  conn = open_database(OPT_ARG(DBTYPE), dbspec-&gt;host, buf, dbspec-&gt;db,
                      dbspec-&gt;user, dbspec-&gt;password);
-  if (!db) return 0;
+  if (!conn) return 0;
 
   doc = UpwatchXmlDoc(&quot;result&quot;, NULL);
 
   // find all expired probes, but skip those for which processing
   // has been stopped for some reason
-  result = my_query(db, 0, &quot;select probe.name, pr_status.probe, &quot; 
-                           &quot;       pr_status.server, pr_status.color, &quot;
-                           &quot;       pr_status.expires &quot;
-                           &quot;from   pr_status, probe &quot;
-                           &quot;where  probe.id = pr_status.class and color &lt;&gt; 400 &quot;
-                           &quot;       and expires &lt; UNIX_TIMESTAMP()-30 &quot;
-                           &quot;       and expires &lt; probe.lastseen&quot;
-                           &quot;       and probe.expiry = 'yes'&quot;);
+  result = db_query(conn, 0, &quot;select probe.name, pr_status.probe, &quot; 
+                             &quot;       pr_status.server, pr_status.color, &quot;
+                             &quot;       pr_status.expires &quot;
+                             &quot;from   pr_status, probe &quot;
+                             &quot;where  probe.id = pr_status.class and color &lt;&gt; 400 &quot;
+                             &quot;       and expires &lt; UNIX_TIMESTAMP()-30 &quot;
+                             &quot;       and expires &lt; probe.lastseen&quot;
+                             &quot;       and probe.expiry = 'yes'&quot;);
   if (!result) goto errexit;
 
-  while ((row = mysql_fetch_row(result)) != NULL) {
+  while (dbi_result_next_row(result)) {
     char buffer[256];
     time_t now = time(NULL);
 
-    probe = xmlNewChild(xmlDocGetRootElement(doc), NULL, row[0], NULL);
+    probe = xmlNewChild(xmlDocGetRootElement(doc), NULL, dbi_result_get_string(result, &quot;name&quot;), NULL);
     xmlSetProp(probe, &quot;realm&quot;, dbspec-&gt;realm);
-    xmlSetProp(probe, &quot;id&quot;, row[1]);
-    xmlSetProp(probe, &quot;server&quot;, row[2]);
+    xmlSetProp(probe, &quot;id&quot;, dbi_result_get_string(result, &quot;probe&quot;));
+    xmlSetProp(probe, &quot;server&quot;, dbi_result_get_string(result, &quot;server&quot;));
     sprintf(buffer, &quot;%u&quot;, (int) now);	xmlSetProp(probe, &quot;date&quot;, buffer);
-    xmlSetProp(probe, &quot;expires&quot;, row[4]);
+    xmlSetProp(probe, &quot;expires&quot;, dbi_result_get_string(result, &quot;expires&quot;));
 
     xmlNewChild(probe, NULL, &quot;color&quot;, &quot;400&quot;);  // PURPLE
-    xmlNewChild(probe, NULL, &quot;prevcolor&quot;, row[3]);
+    xmlNewChild(probe, NULL, &quot;prevcolor&quot;, dbi_result_get_string(result, &quot;color&quot;));
 
-    LOG(LOG_INFO, &quot;%s: purpled %s %s&quot;, dbspec-&gt;realm, row[0], row[1]);
+    LOG(LOG_INFO, &quot;%s: purpled %s %s&quot;, dbspec-&gt;realm, dbi_result_get_string(result, &quot;name&quot;), 
+                                                      dbi_result_get_string(result, &quot;probe&quot;));
     count++;
   }
   if (count) {
@@ -79,8 +82,8 @@
   }
 
 errexit:
-  if (result) mysql_free_result(result);
-  if (db) close_database(db);
+  if (result) dbi_result_free(result);
+  if (conn) close_database(conn);
   if (doc) xmlFreeDoc(doc);
   return count;
 }
@@ -91,40 +94,39 @@
 //***********************************************************************
 int run(void)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
-  MYSQL *upwatch;
+  dbi_result result;
+  dbi_conn conn;
   int count = 0;
 
-  upwatch = open_database(OPT_ARG(DBHOST), OPT_VALUE_DBPORT, OPT_ARG(DBNAME),
+  conn = open_database(OPT_ARG(DBTYPE), OPT_ARG(DBHOST), OPT_ARG(DBPORT), OPT_ARG(DBNAME),
                         OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
-  if (!upwatch) return 0;
+  if (!conn) return 0;
 
   LOG(LOG_INFO, &quot;processing ..&quot;);
   uw_setproctitle(&quot;reading info from database&quot;);
-  result = my_query(upwatch, 0, &quot;select pr_realm.id, pr_realm.name, pr_realm.host, &quot;
-                                &quot;       pr_realm.port, pr_realm.db, pr_realm.user, &quot;
-                                &quot;       pr_realm.password &quot;
-                                &quot;from   pr_realm &quot;
-                                &quot;where  pr_realm.id &gt; 1&quot;);
+  result = db_query(conn, 0, &quot;select pr_realm.id, pr_realm.name, pr_realm.host, &quot;
+                              &quot;       pr_realm.port, pr_realm.db, pr_realm.user, &quot;
+                              &quot;       pr_realm.password &quot;
+                              &quot;from   pr_realm &quot;
+                              &quot;where  pr_realm.id &gt; 1&quot;);
   if (result) {
-    while ((row = mysql_fetch_row(result)) != NULL) {
+    while (dbi_result_next_row(result)) {
       struct dbspec db;
 
-      db.domid = atoi(row[0]);
-      db.realm = row[1];
-      db.host = row[2];
-      db.port = atoi(row[3]);
-      db.db = row[4];
-      db.user = row[5];
-      db.password = row[6];
-      uw_setproctitle(&quot;checking %s&quot;, row[1]);
-      LOG(LOG_DEBUG, &quot;checking %s&quot;, row[1]);
+      db.domid = dbi_result_get_uint(result, &quot;id&quot;);
+      db.realm = dbi_result_get_string(result, &quot;name&quot;);
+      db.host = dbi_result_get_string(result, &quot;host&quot;);
+      db.port = dbi_result_get_uint(result, &quot;port&quot;);
+      db.db = dbi_result_get_string(result, &quot;db&quot;);
+      db.user = dbi_result_get_string(result, &quot;user&quot;);
+      db.password = dbi_result_get_string(result, &quot;password&quot;);
+      uw_setproctitle(&quot;checking %s&quot;, dbi_result_get_string(result, &quot;name&quot;));
+      LOG(LOG_DEBUG, &quot;checking %s&quot;, dbi_result_get_string(result, &quot;name&quot;));
       count += find_expired_probes(&amp;db);
     }
-    mysql_free_result(result);
+    dbi_result_free(result);
   }
-  close_database(upwatch);
+  close_database(conn);
   LOG(LOG_INFO, &quot;sleeping&quot;);
   return count;
 }

Modified: upwatch/libdbi/uw_purple/uw_purple.def
===================================================================
--- upwatch/libdbi/uw_purple/uw_purple.def	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_purple/uw_purple.def	2006-07-21 20:34:40 UTC (rev 632)
@@ -18,7 +18,7 @@
 be notified';
 
 // this section is for the generated specfile
-spec-requires = &quot;/usr/bin/mysql glib2&quot;;
+spec-requires = &quot;libdbi &gt;= 0.8 glib2&quot;;
 spec-files = `echo &quot;%attr(0770,root,upwatch)&quot; $sbindir/uw_purple`;
 
 // describe commandline flags

Modified: upwatch/libdbi/uw_route/Makefile.am
===================================================================
--- upwatch/libdbi/uw_route/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_route/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -11,8 +11,8 @@
 init_DATA = $(INITFILES)
 
 uw_route_SOURCES = run.c uw_route.h uw_route.c $(SPECFILES) $(INITFILES) 
-uw_route_CFLAGS = @MYSQL_CFLAGS@ @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
-uw_route_LDADD = uw_route_$(DB_O) uw_route_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) @MYSQL_LIBS@ @LIBGLIB2_LIBS@ @LIBXML2_LIBS@ $(SOLARISLIBS)
+uw_route_CFLAGS = @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
+uw_route_LDADD = uw_route_$(DB_O) uw_route_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) @LIBDBI_LIBS@ @LIBGLIB2_LIBS@ @LIBXML2_LIBS@ $(SOLARISLIBS)
 
 BUILT_SOURCES = $(program:%=%.1) $(program:%=%.h) $(program:%=%.c) $(SPECFILES) $(INITFILES)
 INCLUDES = -I../upwatch

Modified: upwatch/libdbi/uw_route/uw_route.def
===================================================================
--- upwatch/libdbi/uw_route/uw_route.def	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_route/uw_route.def	2006-07-21 20:34:40 UTC (rev 632)
@@ -13,7 +13,7 @@
 'uw_route reads probe resultfiles, and stores them in the database';
 
 // this section is for the generated specfile
-spec-requires = &quot;/usr/bin/mysql glib2&quot;;
+spec-requires = &quot;libdbi &gt;= 0.8 glib2&quot;;
 spec-files = `echo &quot;%attr(0770,root,upwatch)&quot; $sbindir/uw_route`;
 spec-files = `echo &quot;%attr(0770,root,upwatch) %dir &quot; $spooldir/uw_route`;
 spec-files = `echo &quot;%attr(0770,root,upwatch) %dir &quot; $spooldir/uw_route/new`;

Modified: upwatch/libdbi/uw_send/Makefile.am
===================================================================
--- upwatch/libdbi/uw_send/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_send/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -7,7 +7,7 @@
 init_DATA = $(INITFILES)
 
 uw_send_SOURCES = run.c uw_send.c uw_send.h uw_send.def $(SPECFILES) $(INITFILES)
-uw_send_CFLAGS = @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @MYSQL_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
+uw_send_CFLAGS = @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
 uw_send_LDADD = uw_send_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) @LIBGLIB2_LIBS@
 
 BUILT_SOURCES = $(program:%=%.1) $(program:%=%.h) $(program:%=%.c) $(SPECFILES) $(INITFILES)

Modified: upwatch/libdbi/uw_setip/Makefile.am
===================================================================
--- upwatch/libdbi/uw_setip/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_setip/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -8,8 +8,8 @@
 init_DATA = $(INITFILES)
 
 uw_setip_SOURCES = run.c uw_setip.h uw_setip.c $(SPECFILES) $(INITFILES)
-uw_setip_CFLAGS = @MYSQL_CFLAGS@ @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS) 
-uw_setip_LDADD = uw_setip_$(DB_O) uw_setip_$(MAIN_O) $(LIBOPTS) $(LIBST) $(LIBUPWATCH) @MYSQL_LIBS@ @LIBGLIB2_LIBS@
+uw_setip_CFLAGS = @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS) 
+uw_setip_LDADD = uw_setip_$(DB_O) uw_setip_$(MAIN_O) $(LIBOPTS) $(LIBST) $(LIBUPWATCH) @LIBDBI_LIBS@ @LIBGLIB2_LIBS@
 
 BUILT_SOURCES = $(program:%=%.1) $(program:%=%.h) $(program:%=%.c) $(SPECFILES) $(INITFILES)
 INCLUDES = -I../upwatch

Modified: upwatch/libdbi/uw_setip/run.c
===================================================================
--- upwatch/libdbi/uw_setip/run.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_setip/run.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -20,7 +20,7 @@
   char db[64];
   char user[25];
   char password[25];
-  MYSQL *mysql;
+  dbi_conn conn;
 } *dblist;
 int dblist_cnt;
 
@@ -37,46 +37,45 @@
 
 void init_dblist(void)
 {
-  MYSQL *db;
+  dbi_conn conn;
 
-  db = open_database(OPT_ARG(DBHOST), OPT_VALUE_DBPORT, OPT_ARG(DBNAME),
-                     OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
-  if (db) {
-    MYSQL_RES *result;
+  conn = open_database(OPT_ARG(DBTYPE), OPT_ARG(DBHOST), OPT_ARG(DBPORT), OPT_ARG(DBNAME),
+                       OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
+  if (conn) {
+    dbi_result result;
 
     if (dblist) free(dblist);
     dblist = calloc(100, sizeof(struct dbspec));
 
-    result = my_query(db, 0, &quot;select pr_realm.name, pr_realm.host, &quot;
-                             &quot;       pr_realm.port, pr_realm.db, pr_realm.user, &quot;
-                             &quot;       pr_realm.password &quot;
-                             &quot;from   pr_realm &quot;
-                             &quot;where  pr_realm.id &gt; 1&quot;);
+    result = db_query(conn, 0, &quot;select pr_realm.name, pr_realm.host, &quot;
+                               &quot;       pr_realm.port, pr_realm.db, pr_realm.user, &quot;
+                               &quot;       pr_realm.password &quot;
+                               &quot;from   pr_realm &quot;
+                               &quot;where  pr_realm.id &gt; 1&quot;);
     if (result) {
-      MYSQL_ROW row;
       dblist_cnt = 0;
-      while ((row = mysql_fetch_row(result)) != NULL) {
-        strcpy(dblist[dblist_cnt].realm, row[0]);
-        strcpy(dblist[dblist_cnt].host, row[1]);
-        dblist[dblist_cnt].port = atoi(row[2]);
-        strcpy(dblist[dblist_cnt].db, row[3]);
-        strcpy(dblist[dblist_cnt].user, row[4]);
-        strcpy(dblist[dblist_cnt].password, row[5]);
+      while (dbi_result_next_row(result)) {
+        strcpy(dblist[dblist_cnt].realm, dbi_result_get_string(result, &quot;name&quot;));
+        strcpy(dblist[dblist_cnt].host, dbi_result_get_string(result, &quot;host&quot;));
+        dblist[dblist_cnt].port = dbi_result_get_uint(result, &quot;port&quot;);
+        strcpy(dblist[dblist_cnt].db, dbi_result_get_string(result, &quot;db&quot;));
+        strcpy(dblist[dblist_cnt].user, dbi_result_get_string(result, &quot;user&quot;));
+        strcpy(dblist[dblist_cnt].password, dbi_result_get_string(result, &quot;password&quot;));
         dblist_cnt++;
       }
-      mysql_free_result(result);
+      dbi_result_free(result);
     }
-    close_database(db);
+    close_database(conn);
     LOG(LOG_INFO, &quot;read %u realms&quot;, dblist_cnt);
   } else {
     LOG(LOG_NOTICE, &quot;could not open database %s@%s as user %s&quot;, OPT_ARG(DBNAME), OPT_ARG(DBHOST), OPT_ARG(DBUSER));
   } 
 }
 
-MYSQL *open_realm(char *realm)
+dbi_conn open_realm(char *realm)
 {
   int i;
-  MYSQL *mysql;
+  dbi_conn conn;
 static int call_cnt = 0;
 
   if (!dblist || ++call_cnt == 100) {
@@ -88,60 +87,58 @@
     }
   }
   if (realm == NULL || realm[0] == 0) {
-    mysql = open_database(dblist[0].host, dblist[0].port,
+    char buf[10];
+
+    sprintf(buf, &quot;%d&quot;, dblist[0].port);
+    conn = open_database(OPT_ARG(DBTYPE), dblist[0].host, buf,
             dblist[0].db, dblist[0].user, dblist[0].password);
-    return(mysql);
+    return(conn);
   }
 
   for (i=0; i &lt; dblist_cnt; i++) {
     if (strcmp(dblist[i].realm, realm) == 0) {
-      mysql = open_database(dblist[i].host, dblist[i].port,
+      char buf[10];
+
+      sprintf(buf, &quot;%d&quot;, dblist[0].port);
+      conn = open_database(OPT_ARG(DBTYPE), dblist[i].host, buf,
               dblist[i].db, dblist[i].user, dblist[i].password);
-      return(mysql);
+      return(conn);
     }
   }
   return(NULL);
 }
 
-static int uw_password_ok(char *user, char *passwd) 
+static int uw_password_ok(char *user, char *passwd)
 {
-  MYSQL *mysql;
-  MYSQL_RES *result;
+  dbi_conn conn;
+  dbi_result result;
   char user_realm[256];
   char *realm;
 
   strncpy(user_realm, user, sizeof(user_realm));
   realm = strrchr(user, '@');
-  if (realm) { 
-    *realm++ = 0; 
+  if (realm) {
+    *realm++ = 0;
   }
-  mysql = open_realm(realm);
-  if (mysql) {
+  conn = open_realm(realm);
+  if (conn) {
     gchar buffer[256];
-    MYSQL_ROW row;
 
     sprintf(buffer, OPT_ARG(AUTHQUERY), user, passwd);
     LOG(LOG_DEBUG, buffer);
-    if (mysql_query(mysql, buffer)) {
-      close_database(mysql);
+    result = dbi_conn_query(conn, buffer);
+    if (!result) {
+      close_database(conn);
       return(FALSE);
     }
-    result = mysql_store_result(mysql);
-    if (!result || mysql_num_rows(result) &lt; 1) {
-      // LOG(LOG_NOTICE, &quot;user %s, pwd %s not found&quot;, user, passwd);
-      close_database(mysql);
-      return(FALSE);
-    }
-    if ((row = mysql_fetch_row(result))) {
-      int id;
-
-      id = atoi(row[0]);
+    if (dbi_result_next_row(result)) {
+      int id = dbi_result_get_uint_idx(result, 0);
       LOG(LOG_DEBUG, &quot;user %s, pwd %s resulted in id %d&quot;, user_realm, passwd, id);
     }
-    mysql_free_result(result);
-    close_database(mysql);
+    dbi_result_free(result);
+    close_database(conn);
   } else {
-    close_database(mysql);
+    close_database(conn);
     return(FALSE); // couldn't open database
   }
   return(TRUE);
@@ -149,22 +146,21 @@
 
 static int uw_set_ip(char *user, char *ip, char *remotehost) 
 {
-  MYSQL *mysql;
-
-  mysql = open_database(OPT_ARG(DBHOST), OPT_VALUE_DBPORT, OPT_ARG(DBNAME), 
+  dbi_conn conn;
+  conn = open_database(OPT_ARG(DBTYPE), OPT_ARG(DBHOST), OPT_ARG(DBPORT), OPT_ARG(DBNAME), 
 			OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
-  if (mysql) {
+  if (conn) {
     gchar buffer[256];
 
     sprintf(buffer, OPT_ARG(SETIPQUERY), ip, remotehost, user);
     LOG(LOG_DEBUG, buffer);
-    if (mysql_query(mysql, buffer)) {
-      close_database(mysql);
+    if (!dbi_conn_query(conn, buffer)) {
+      close_database(conn);
       return(FALSE);
     }
-    close_database(mysql);
+    close_database(conn);
   } else {
-    close_database(mysql);
+    close_database(conn);
     return(FALSE); // couldn't open database
   }
   return(TRUE);

Modified: upwatch/libdbi/uw_setip/uw_setip.def
===================================================================
--- upwatch/libdbi/uw_setip/uw_setip.def	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_setip/uw_setip.def	2006-07-21 20:34:40 UTC (rev 632)
@@ -15,7 +15,7 @@
 These are send by clients with variable IP addresses.';
 
 // this section is for the generated specfile 
-spec-requires = &quot;/usr/bin/mysql glib2&quot;;
+spec-requires = &quot;libdbi &gt;= 0.8 glib2&quot;;
 spec-files = `echo &quot;%attr(0770,root,upwatch)&quot; $sbindir/uw_setip`;
 
 // describe commandline flags

Modified: upwatch/libdbi/uw_smtp/Makefile.am
===================================================================
--- upwatch/libdbi/uw_smtp/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_smtp/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -8,8 +8,8 @@
 init_DATA = $(INITFILES)
 
 uw_smtp_SOURCES = run.c uw_smtp.h uw_smtp.c  $(PROBFILES) $(SPECFILES) $(INITFILES)
-uw_smtp_CFLAGS = @MYSQL_CFLAGS@ @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS) 
-uw_smtp_LDADD = uw_smtp_$(DB_O) uw_smtp_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) $(LIBST) @MYSQL_LIBS@ @LIBGLIB2_LIBS@
+uw_smtp_CFLAGS = @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS) 
+uw_smtp_LDADD = uw_smtp_$(DB_O) uw_smtp_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) $(LIBST) @LIBDBI_LIBS@ @LIBGLIB2_LIBS@
 
 BUILT_SOURCES = $(program:%=%.1) $(program:%=%.h) $(program:%=%.c) $(PROBFILES) $(SPECFILES) $(INITFILES)
 INCLUDES = -I../upwatch

Modified: upwatch/libdbi/uw_smtp/run.c
===================================================================
--- upwatch/libdbi/uw_smtp/run.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_smtp/run.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -70,13 +70,13 @@
   return(1);
 }
 
-void refresh_database(MYSQL *mysql);
+void refresh_database(dbi_conn conn);
 void run_actual_probes(void);
 void write_results(void);
 
 int run(void)
 {
-  MYSQL *mysql;
+  dbi_conn conn;
 
   if (!cache) {
     cache = g_hash_table_new_full(g_int_hash, g_int_equal, g_free, free_probe);
@@ -84,11 +84,11 @@
   
   LOG(LOG_INFO, &quot;reading info from database&quot;);
   uw_setproctitle(&quot;reading info from database&quot;);
-  mysql = open_database(OPT_ARG(DBHOST), OPT_VALUE_DBPORT, OPT_ARG(DBNAME), 
+  conn = open_database(OPT_ARG(DBTYPE), OPT_ARG(DBHOST), OPT_ARG(DBPORT), OPT_ARG(DBNAME), 
 			OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
-  if (mysql) {
-    refresh_database(mysql);
-    close_database(mysql);
+  if (conn) {
+    refresh_database(conn);
+    close_database(conn);
   }
 
   if (g_hash_table_size(cache) &gt; 0) {
@@ -104,10 +104,9 @@
   return(g_hash_table_size(cache));
 }
 
-void refresh_database(MYSQL *mysql)
+void refresh_database(dbi_conn conn)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   char qry[1024];
 
   sprintf(qry,  &quot;SELECT pr_smtp_def.id, pr_smtp_def.domid, pr_smtp_def.tblid, pr_realm.name, &quot;
@@ -118,22 +117,22 @@
                 &quot;       and pr_smtp_def.pgroup = '%d' and pr_realm.id = pr_smtp_def.domid&quot;,
                 (unsigned)OPT_VALUE_GROUPID);
 
-  result = my_query(mysql, 1, qry);
+  result = db_query(conn, 1, qry);
   if (!result) {
     return;
   }
     
-  while ((row = mysql_fetch_row(result))) {
+  while (dbi_result_next_row(result)) {
     int id;
     struct probedef *probe;
 
-    id = atol(row[0]);
+    id = dbi_result_get_uint(result, &quot;id&quot;);
     probe = g_hash_table_lookup(cache, &amp;id);
     if (!probe) {
       probe = g_malloc0(sizeof(struct probedef));
-      if (atoi(row[1]) &gt; 1) {
-        probe-&gt;probeid = atoi(row[2]);
-        probe-&gt;realm = strdup(row[3]);
+      if (dbi_result_get_uint(result, &quot;domid&quot;) &gt; 1) {
+        probe-&gt;probeid = dbi_result_get_uint(result, &quot;tblid&quot;);
+        strcpy(probe-&gt;realm, dbi_result_get_string(result, &quot;name&quot;));
       } else {
         probe-&gt;probeid = probe-&gt;id;
       }
@@ -141,19 +140,22 @@
     }
 
     if (probe-&gt;ipaddress) g_free(probe-&gt;ipaddress);
-    probe-&gt;ipaddress = strdup(row[4]);
-    probe-&gt;yellow = atof(row[5]);
-    probe-&gt;red = atof(row[6]);
+    probe-&gt;ipaddress = dbi_result_get_string_copy(result, &quot;ipaddress&quot;);
+    probe-&gt;yellow = dbi_result_get_float(result, &quot;yellow&quot;);
+    probe-&gt;red = dbi_result_get_float(result, &quot;red&quot;);
     if (probe-&gt;msg) g_free(probe-&gt;msg);
     probe-&gt;msg = NULL;
     probe-&gt;seen = 1;
   }
-  mysql_free_result(result);
-  if (mysql_errno(mysql)) {
+  if (dbi_conn_error_flag(conn)) {
+    const char *errmsg;
+    dbi_conn_error(conn, &amp;errmsg);
+    LOG(LOG_ERR, &quot;%s&quot;, errmsg);
     g_hash_table_foreach(cache, reset_seen, NULL);
   } else {
     g_hash_table_foreach_remove(cache, return_seen, NULL);
   }
+  dbi_result_free(result);
 }
 
 void *probe(void *user_data); 
@@ -222,7 +224,7 @@
 void write_results(void)
 {
   int ct  = STACKCT_OPT(OUTPUT);
-  char **output = STACKLST_OPT(OUTPUT);
+  const char **output = STACKLST_OPT(OUTPUT);
   int i;
   xmlDocPtr doc;
 

Modified: upwatch/libdbi/uw_smtp/uw_smtp.def
===================================================================
--- upwatch/libdbi/uw_smtp/uw_smtp.def	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_smtp/uw_smtp.def	2006-07-21 20:34:40 UTC (rev 632)
@@ -15,7 +15,7 @@
 so uw_smtp can process thousands of hosts in a very short period.';
 
 // this section is for the generated specfile
-spec-requires = &quot;/usr/bin/mysql glib2&quot;;
+spec-requires = &quot;libdbi &gt;= 0.8 glib2&quot;;
 spec-files = `echo &quot;%attr(0770,root,upwatch)&quot; $sbindir/uw_smtp`;
 
 // describe commandline flags

Modified: upwatch/libdbi/uw_snmpget/Makefile.am
===================================================================
--- upwatch/libdbi/uw_snmpget/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_snmpget/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -7,8 +7,8 @@
 init_DATA = $(INITFILES)
 
 uw_snmpget_SOURCES = run.c uw_snmpget.h uw_snmpget.c $(PROBFILES) $(SPECFILES) $(INITFILES)
-uw_snmpget_CFLAGS = @MYSQL_CFLAGS@ @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
-uw_snmpget_LDADD = uw_snmpget_$(DB_O) uw_snmpget_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) @MYSQL_LIBS@ @LIBSNMP_LIBS@ @LIBCRYPTO_LIBS@ @LIBGLIB2_LIBS@ 
+uw_snmpget_CFLAGS = @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
+uw_snmpget_LDADD = uw_snmpget_$(DB_O) uw_snmpget_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) @LIBDBI_LIBS@ @LIBSNMP_LIBS@ @LIBCRYPTO_LIBS@ @LIBGLIB2_LIBS@ 
 
 BUILT_SOURCES = $(program:%=%.1) $(program:%=%.h) $(program:%=%.c) $(PROBFILES) $(SPECFILES) $(INITFILES)
 INCLUDES = -I../upwatch

Modified: upwatch/libdbi/uw_snmpget/run.c
===================================================================
--- upwatch/libdbi/uw_snmpget/run.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_snmpget/run.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -69,13 +69,13 @@
   return(1);
 }
 
-void refresh_database(MYSQL *mysql);
+void refresh_database(dbi_conn conn);
 void run_actual_probes(void);
 void write_results(void);
 
 int run(void)
 {
-  MYSQL *mysql;
+  dbi_conn conn;
 
   if (!cache) {
     cache = g_hash_table_new_full(g_int_hash, g_int_equal, g_free, free_probe);
@@ -83,11 +83,11 @@
   
   LOG(LOG_INFO, &quot;reading info from database&quot;);
   uw_setproctitle(&quot;reading info from database&quot;);
-  mysql = open_database(OPT_ARG(DBHOST), OPT_VALUE_DBPORT, OPT_ARG(DBNAME), 
+  conn = open_database(OPT_ARG(DBTYPE), OPT_ARG(DBHOST), OPT_ARG(DBPORT), OPT_ARG(DBNAME), 
 			OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
-  if (mysql) {
-    refresh_database(mysql);
-    close_database(mysql);
+  if (conn) {
+    refresh_database(conn);
+    close_database(conn);
   }
 
   if (g_hash_table_size(cache) &gt; 0) {
@@ -103,10 +103,9 @@
   return(g_hash_table_size(cache));
 }
 
-void refresh_database(MYSQL *mysql)
+void refresh_database(dbi_conn conn)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   char qry[1024];
 
   sprintf(qry,  &quot;SELECT pr_snmpget_def.id, pr_snmpget_def.domid, pr_snmpget_def.tblid, pr_realm.name, &quot;
@@ -118,22 +117,22 @@
                 &quot;       and pr_snmpget_def.pgroup = '%d' and pr_realm.id = pr_snmpget_def.domid&quot;,
                 (unsigned) OPT_VALUE_GROUPID);
 
-  result = my_query(mysql, 1, qry);
+  result = db_query(conn, 1, qry);
   if (!result) {
     return;
   }
     
-  while ((row = mysql_fetch_row(result))) {
+  while (dbi_result_next_row(result)) {
     int id;
     struct probedef *probe;
 
-    id = atol(row[0]);
+    id = dbi_result_get_uint(result, &quot;id&quot;);
     probe = g_hash_table_lookup(cache, &amp;id);
     if (!probe) {
       probe = g_malloc0(sizeof(struct probedef));
-      if (atoi(row[1]) &gt; 1) {
-        probe-&gt;probeid = atoi(row[2]);
-        probe-&gt;realm = strdup(row[3]);
+      if (dbi_result_get_uint(result, &quot;domid&quot;) &gt; 1) {
+        probe-&gt;probeid = dbi_result_get_uint(result, &quot;tblid&quot;);
+        strcpy(probe-&gt;realm, dbi_result_get_string(result, &quot;name&quot;));
       } else {
         probe-&gt;probeid = probe-&gt;id;
       }
@@ -142,25 +141,28 @@
     }
 
     if (probe-&gt;ipaddress) g_free(probe-&gt;ipaddress);
-    probe-&gt;ipaddress = strdup(row[4]);
+    probe-&gt;ipaddress = dbi_result_get_string_copy(result, &quot;ipaddress&quot;);
     if (probe-&gt;community) g_free(probe-&gt;community);
-    probe-&gt;community = strdup(row[5]);
+    probe-&gt;community = dbi_result_get_string_copy(result, &quot;community&quot;);
     if (probe-&gt;OID) g_free(probe-&gt;OID);
-    probe-&gt;OID = strdup(row[6]);
-    strcpy(probe-&gt;mode, row[7]);
-    probe-&gt;multiplier = atof(row[8]);
-    probe-&gt;yellow = atof(row[9]);
-    probe-&gt;red = atof(row[10]);
+    probe-&gt;OID = dbi_result_get_string_copy(result, &quot;OID&quot;);
+    strcpy(probe-&gt;mode, dbi_result_get_string(result, &quot;mode&quot;));
+    probe-&gt;multiplier = dbi_result_get_float(result, &quot;multiplier&quot;);
+    probe-&gt;yellow = dbi_result_get_float(result, &quot;yellow&quot;);
+    probe-&gt;red = dbi_result_get_float(result, &quot;red&quot;);
     if (probe-&gt;msg) g_free(probe-&gt;msg);
     probe-&gt;msg = NULL;
     probe-&gt;seen = 1;
   }
-  mysql_free_result(result);
-  if (mysql_errno(mysql)) {
+  if (dbi_conn_error_flag(conn)) {
+    const char *errmsg;
+    dbi_conn_error(conn, &amp;errmsg);
+    LOG(LOG_ERR, &quot;%s&quot;, errmsg);
     g_hash_table_foreach(cache, reset_seen, NULL);
   } else {
     g_hash_table_foreach_remove(cache, return_seen, NULL);
   }
+  dbi_result_free(result);
 }
 
 static int active_hosts;
@@ -346,7 +348,7 @@
 void write_results(void)
 {
   int ct  = STACKCT_OPT(OUTPUT);
-  char **output = STACKLST_OPT(OUTPUT);
+  const char **output = STACKLST_OPT(OUTPUT);
   int i;
   xmlDocPtr doc;
 

Modified: upwatch/libdbi/uw_snmpget/uw_snmpget.def
===================================================================
--- upwatch/libdbi/uw_snmpget/uw_snmpget.def	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_snmpget/uw_snmpget.def	2006-07-21 20:34:40 UTC (rev 632)
@@ -15,7 +15,7 @@
 so uw_snmpget can process thousands of hosts in a very short period.';
 
 // this section is for the generated specfile
-spec-requires = &quot;/usr/bin/mysql glib2&quot;;
+spec-requires = &quot;libdbi &gt;= 0.8 glib2&quot;;
 spec-files = `echo &quot;%attr(0770,root,upwatch)&quot; $sbindir/uw_snmpget`;
 
 // describe commandline flags

Modified: upwatch/libdbi/uw_syncprobes/Makefile.am
===================================================================
--- upwatch/libdbi/uw_syncprobes/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_syncprobes/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -7,8 +7,8 @@
 init_DATA = $(INITFILES)
 
 uw_syncprobes_SOURCES = run.c uw_syncprobes.h uw_syncprobes.c  $(SPECFILES) $(INITFILES)
-uw_syncprobes_CFLAGS = @MYSQL_CFLAGS@ @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
-uw_syncprobes_LDADD = uw_syncprobes_$(DB_O) uw_syncprobes_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) @MYSQL_LIBS@ @LIBGLIB2_LIBS@
+uw_syncprobes_CFLAGS = @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
+uw_syncprobes_LDADD = uw_syncprobes_$(DB_O) uw_syncprobes_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) @LIBDBI_LIBS@ @LIBGLIB2_LIBS@
 
 BUILT_SOURCES = $(program:%=%.1) $(program:%=%.h) $(program:%=%.c) $(SPECFILES) $(INITFILES)
 INCLUDES = -I../upwatch

Modified: upwatch/libdbi/uw_syncprobes/run.c
===================================================================
--- upwatch/libdbi/uw_syncprobes/run.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_syncprobes/run.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -8,12 +8,12 @@
 
 struct dbspec {
   int domid;
-  char *realm;
-  char *host;
+  const char *realm;
+  const char *host;
   int port;
-  char *db;
-  char *user;
-  char *password;
+  const char *db;
+  const char *user;
+  const char *password;
 };
 
 int init(void)
@@ -24,41 +24,42 @@
   return(1);
 }
 
-void sync_table(MYSQL *upwatch, struct dbspec *db, char *table);
+void sync_table(dbi_conn conn, struct dbspec *db, const char *table);
 
 int run(void)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
-  MYSQL *upwatch;
+  dbi_result result;
+  dbi_conn upwatch;
 
-  upwatch = open_database(OPT_ARG(DBHOST), OPT_VALUE_DBPORT, OPT_ARG(DBNAME),
+  upwatch = open_database(OPT_ARG(DBTYPE), OPT_ARG(DBHOST), OPT_ARG(DBPORT), OPT_ARG(DBNAME),
                         OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
   if (!upwatch) return 0;
 
   LOG(LOG_INFO, &quot;syncing..&quot;);
   uw_setproctitle(&quot;reading info from database&quot;);
-  result = my_query(upwatch, 0, &quot;select pr_realm.id, pr_realm.name, pr_realm.host, &quot;
+  result = db_query(upwatch, 0, &quot;select pr_realm.id, pr_realm.name, pr_realm.host, &quot;
                                 &quot;       pr_realm.port, pr_realm.db, pr_realm.user, &quot;
                                 &quot;       pr_realm.password, probe.name as tbl &quot;
                                 &quot;from   probe, pr_realm &quot; 
                                 &quot;where  probe.id &gt; 1 and pr_realm.id &gt; 1&quot;);
   if (result) {
-    while ((row = mysql_fetch_row(result)) != NULL) {
+    while (dbi_result_next_row(result)) {
       struct dbspec db;
 
-      db.domid = atoi(row[0]);
-      db.realm = row[1];
-      db.host = row[2];
-      db.port = atoi(row[3]);
-      db.db = row[4];
-      db.user = row[5];
-      db.password = row[6];
-      uw_setproctitle(&quot;synching %s:pr_%s_def&quot;, row[1], row[7]);
-      LOG(LOG_DEBUG, &quot;syncing %s:pr_%s_def&quot;, row[1], row[7]);
-      sync_table(upwatch, &amp;db, row[7]);
+      db.domid = dbi_result_get_uint(result, &quot;id&quot;);
+      db.realm = dbi_result_get_string(result, &quot;name&quot;);
+      db.host = dbi_result_get_string(result, &quot;host&quot;);
+      db.port = dbi_result_get_uint(result, &quot;port&quot;);
+      db.db = dbi_result_get_string(result, &quot;db&quot;);
+      db.user = dbi_result_get_string(result, &quot;user&quot;);
+      db.password = dbi_result_get_string(result, &quot;password&quot;);
+      uw_setproctitle(&quot;synching %s:pr_%s_def&quot;, dbi_result_get_string(result, &quot;name&quot;), 
+                       dbi_result_get_string(result, &quot;tbl&quot;));
+      LOG(LOG_DEBUG, &quot;syncing %s:pr_%s_def&quot;, dbi_result_get_string(result, &quot;name&quot;), 
+                       dbi_result_get_string(result, &quot;tbl&quot;));
+      sync_table(upwatch, &amp;db, dbi_result_get_string(result, &quot;tbl&quot;));
     }
-    mysql_free_result(result);
+    dbi_result_free(result);
   }
   close_database(upwatch);
   LOG(LOG_INFO, &quot;sleeping&quot;);
@@ -73,147 +74,142 @@
 };
  
 #define SIZE_STEP 1000
-struct deftable *read_def(MYSQL *db, char *table, int realmid, int isaggr, int *count)
+struct deftable *read_def(dbi_conn conn, const char *table, int realmid, int isaggr, int *count)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   struct deftable *tbl;
   int tbl_max=1000;
 
   if (isaggr) {
-    result = my_query(db, 0, &quot;select id, domid, tblid, unix_timestamp(changed) &quot; 
-                             &quot;from   pr_%s_def &quot;
-                             &quot;where  id &gt; 1 and tblid &gt; 1 and domid = %u &quot;
-                             &quot;order  by tblid asc&quot;, table, realmid);
+    result = db_query(conn, 0, &quot;select id, domid, tblid, unix_timestamp(changed) &quot; 
+                               &quot;from   pr_%s_def &quot;
+                               &quot;where  id &gt; 1 and tblid &gt; 1 and domid = %u &quot;
+                               &quot;order  by tblid asc&quot;, table, realmid);
   } else {
-    result = my_query(db, 0, &quot;select id, domid, tblid, unix_timestamp(changed) &quot; 
-                             &quot;from   pr_%s_def &quot;
-                             &quot;where  id &gt; 1 &quot;
-                             &quot;order  by id asc&quot;, table);
+    result = db_query(conn, 0, &quot;select id, domid, tblid, unix_timestamp(changed) &quot; 
+                               &quot;from   pr_%s_def &quot;
+                               &quot;where  id &gt; 1 &quot;
+                               &quot;order  by id asc&quot;, table);
   }
   if (!result) {
     return(NULL);
   }
   tbl = calloc(SIZE_STEP, sizeof(struct deftable));
   *count = 0; // preset
-  while ((row = mysql_fetch_row(result)) != NULL) {
-    tbl[*count].id = atoi(row[0]);
-    tbl[*count].domid = atoi(row[1]);
-    tbl[*count].tblid = atoi(row[2]);
-    tbl[*count].changed = atoi(row[3]);
+  while (dbi_result_next_row(result)) {
+    tbl[*count].id = dbi_result_get_uint(result, &quot;id&quot;);
+    tbl[*count].domid = dbi_result_get_uint(result, &quot;domid&quot;);
+    tbl[*count].tblid = dbi_result_get_uint(result, &quot;tblid&quot;);
+    tbl[*count].changed = dbi_result_get_uint(result, &quot;changed&quot;);
 
     if (++(*count) == tbl_max) {
       tbl_max += 1000;
       tbl = realloc(tbl, tbl_max * sizeof(struct deftable));
     }
   }
-  mysql_free_result(result);
+  dbi_result_free(result);
   return(tbl);
 }
 
-void update_record(MYSQL *db, char *name, unsigned tblid, unsigned upwid, MYSQL *upwatch)
+void update_record(dbi_conn conn, char *name, unsigned tblid, unsigned upwid, dbi_conn upwatch)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
-  MYSQL_FIELD *fields;
+  dbi_result result;
   int i, numfields;
   char buffer[8192], tmp[8192];
 
-  result = my_query(db, 0, &quot;select * from pr_%s_def where id = '%u'&quot;, name, tblid);
+  result = db_query(conn, 0, &quot;select * from pr_%s_def where id = '%u'&quot;, name, tblid);
   if (!result) return;
 
-  row = mysql_fetch_row(result);
-  if (!row) {
-    mysql_free_result(result);
+  if (dbi_result_next_row(result)) {
+    dbi_result_free(result);
     return;
   }
 
-  numfields = mysql_num_fields(result);
-  fields = mysql_fetch_fields(result);
+  numfields = dbi_result_get_numfields(result);
 
   sprintf(buffer, &quot;update pr_%s_def set &quot;, name);
   for (i=3; i&lt;numfields; i++) {
-    char escaped[16384];
+    char *escaped = strdup(dbi_result_get_string_idx(result, i));
 
-    mysql_real_escape_string(db, escaped, row[i], strlen(row[i]));
-    sprintf(tmp, &quot;%s = '%s', &quot;, fields[i].name, escaped);
+    dbi_conn_quote_string(conn, &amp;escaped);
+    sprintf(tmp, &quot;%s = '%s', &quot;, dbi_result_get_field_name(result, i), escaped);
     strcat(buffer, tmp);
+    if (escaped) free(escaped);
   }
   buffer[strlen(buffer)-2] = 0;
   sprintf(tmp, &quot; where id = '%u'&quot;, upwid);
   strcat(buffer, tmp);
-  mysql_free_result(result);
+  dbi_result_free(result);
 
-  result = my_query(upwatch, 0, buffer);
-  if (result) mysql_free_result(result);
+  result = db_query(upwatch, 0, buffer);
+  if (result) dbi_result_free(result);
 }
 
-void delete_record(MYSQL *upwatch, char *name, unsigned id)
+void delete_record(dbi_conn upwatch, const char *name, unsigned id)
 {
-  MYSQL_RES *result;
+  dbi_result result;
 
-  result = my_query(upwatch, 0, &quot;delete from pr_%s_def where id = '%u'&quot;, name, id);
-  if (result) mysql_free_result(result);
+  result = db_query(upwatch, 0, &quot;delete from pr_%s_def where id = '%u'&quot;, name, id);
+  if (result) dbi_result_free(result);
 
 }
 
-void insert_record(MYSQL *db, char *name, unsigned tblid, unsigned realmid, MYSQL *upwatch)
+void insert_record(dbi_conn conn, const char *name, unsigned tblid, unsigned realmid, dbi_conn upwatch)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
-  MYSQL_FIELD *fields;
+  dbi_result result;
   int i, numfields;
   char buffer[8192], tmp[8192];
 
-  result = my_query(db, 0, &quot;select * from pr_%s_def where id = '%u'&quot;, name, tblid);
+  result = db_query(conn, 0, &quot;select * from pr_%s_def where id = '%u'&quot;, name, tblid);
   if (!result) return;
 
-  row = mysql_fetch_row(result);
-  if (!row) {
-    mysql_free_result(result);
+  if (!dbi_result_next_row(result)) {
+    dbi_result_free(result);
     return;
   }
 
-  numfields = mysql_num_fields(result);
-  fields = mysql_fetch_fields(result);
+  numfields = dbi_result_get_numfields(result);
 
   sprintf(buffer, &quot;insert into pr_%s_def set domid = '%u', tblid = '%u', &quot;, name, realmid, tblid);
   for (i=3; i&lt;numfields; i++) {
-    char escaped[16384];
+    char *escaped;
 
-    mysql_real_escape_string(db, escaped, row[i], strlen(row[i]));
-    sprintf(tmp, &quot;%s = '%s', &quot;, fields[i].name, escaped);
+    dbi_conn_quote_string_copy(conn, dbi_result_get_char_idx(result, i), &amp;escaped);
+    sprintf(tmp, &quot;%s = '%s', &quot;, dbi_result_get_field_name(result, i), escaped);
     strcat(buffer, tmp);
+    if (escaped) free(escaped);
   }
   buffer[strlen(buffer)-2] = 0;
-  mysql_free_result(result);
+  dbi_result_free(result);
 
-  result = my_query(upwatch, 0, buffer);
-  if (result) mysql_free_result(result);
+  result = db_query(upwatch, 0, buffer);
+  if (result) dbi_result_free(result);
 }
 
-void sync_table(MYSQL *upwatch, struct dbspec *dbspec, char *table)
+void sync_table(dbi_conn upwatch, struct dbspec *dbspec, const char *table)
 {
-  MYSQL *db;
+  dbi_conn conn;
   struct deftable *tbl, *upw;
   int tbl_size=0, upw_size=0;
   int i, j;
   int added=0, updated=0, deleted=0;
+  char buf[10];
 
-  db = open_database(dbspec-&gt;host, dbspec-&gt;port, dbspec-&gt;db,
+  sprintf(buf, &quot;%d&quot;, dbspec-&gt;port);
+  conn = open_database(OPT_ARG(DBTYPE), dbspec-&gt;host, buf, dbspec-&gt;db,
                      dbspec-&gt;user, dbspec-&gt;password);
-  if (!db) return;
+  if (!conn) return;
 
-  tbl = read_def(db, table, dbspec-&gt;domid, FALSE, &amp;tbl_size);
+  tbl = read_def(conn, table, dbspec-&gt;domid, FALSE, &amp;tbl_size);
   if (!tbl) {
-    close_database(db);
+    close_database(conn);
     return;
   }
 
   upw = read_def(upwatch, table, dbspec-&gt;domid, TRUE, &amp;upw_size);
   if (!upw) {
     free(tbl);
-    close_database(db);
+    close_database(conn);
     return;
   }
 
@@ -231,14 +227,14 @@
       continue;
     }
     if (j == upw_size) { // end of dest table
-      insert_record(db, table, tbl[i].id, dbspec-&gt;domid, upwatch);
+      insert_record(conn, table, tbl[i].id, dbspec-&gt;domid, upwatch);
       added++;
       i++;
       continue;
     }
     if (tbl[i].id == upw[j].tblid) { // ok, found
       if (tbl[i].changed &gt; upw[j].changed) {
-        update_record(db, table, tbl[i].id, upw[j].id, upwatch);
+        update_record(conn, table, tbl[i].id, upw[j].id, upwatch);
         updated++;
       }
       i++;
@@ -246,7 +242,7 @@
       continue;
     }
     if (tbl[i].id &lt; upw[j].tblid) {
-      insert_record(db, table, tbl[i].id, dbspec-&gt;domid, upwatch);
+      insert_record(conn, table, tbl[i].id, dbspec-&gt;domid, upwatch);
       added++;
       i++;
       continue;
@@ -260,7 +256,7 @@
   }
   free(upw);
   free(tbl);
-  close_database(db);
+  close_database(conn);
   if (added || updated || deleted) {
     LOG(LOG_INFO, &quot;synced %s:pr_%s_def, added %u, updated %u, deleted %u&quot;, 
                     dbspec-&gt;realm, table, added, updated, deleted);

Modified: upwatch/libdbi/uw_syncprobes/uw_syncprobes.def
===================================================================
--- upwatch/libdbi/uw_syncprobes/uw_syncprobes.def	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_syncprobes/uw_syncprobes.def	2006-07-21 20:34:40 UTC (rev 632)
@@ -18,7 +18,7 @@
 be notified';
 
 // this section is for the generated specfile
-spec-requires = &quot;/usr/bin/mysql glib2&quot;;
+spec-requires = &quot;libdbi &gt;= 0.8 glib2&quot;;
 spec-files = `echo &quot;%attr(0770,root,upwatch)&quot; $sbindir/uw_syncprobes`;
 
 // describe commandline flags

Modified: upwatch/libdbi/uw_sysstat/Makefile.am
===================================================================
--- upwatch/libdbi/uw_sysstat/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_sysstat/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -27,7 +27,7 @@
 init_DATA = $(INITFILES)
 
 uw_sysstat_SOURCES = run.c uw_sysstat.c uw_sysstat.h $(PROBFILES) $(SPECFILES) $(INITFILES)
-uw_sysstat_CFLAGS = @MYSQL_CFLAGS@ @LIBXML2_CFLAGS@ @LIBGLIB2_CFLAGS@ $(AM_CFLAGS) @LIBPCRE_CFLAGS@ @LIBOPTS_CFLAGS@
+uw_sysstat_CFLAGS = @LIBXML2_CFLAGS@ @LIBGLIB2_CFLAGS@ $(AM_CFLAGS) @LIBPCRE_CFLAGS@ @LIBOPTS_CFLAGS@
 uw_sysstat_LDADD = uw_sysstat_$(MAIN_O) $(XMBMON_LIB) $(LIBOPTS) \
   $(FREEBSDLIBS) $(SOLARISLIBS) $(LIBSTATGRAB) \
   $(LIBUPWATCH) @LIBXML2_LIBS@ @LIBGLIB2_LIBS@ @LIBPCRE_LIBS@

Modified: upwatch/libdbi/uw_tcpconnect/Makefile.am
===================================================================
--- upwatch/libdbi/uw_tcpconnect/Makefile.am	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_tcpconnect/Makefile.am	2006-07-21 20:34:40 UTC (rev 632)
@@ -8,8 +8,8 @@
 init_DATA = $(INITFILES)
 
 uw_tcpconnect_SOURCES = run.c uw_tcpconnect.h uw_tcpconnect.c  $(PROBFILES) $(SPECFILES) $(INITFILES)
-uw_tcpconnect_CFLAGS = @MYSQL_CFLAGS@ @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
-uw_tcpconnect_LDADD = uw_tcpconnect_$(DB_O) uw_tcpconnect_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) $(LIBST) @MYSQL_LIBS@ @LIBGLIB2_LIBS@
+uw_tcpconnect_CFLAGS = @LIBGLIB2_CFLAGS@ @LIBXML2_CFLAGS@ @LIBOPTS_CFLAGS@ $(AM_CFLAGS)
+uw_tcpconnect_LDADD = uw_tcpconnect_$(DB_O) uw_tcpconnect_$(MAIN_O) $(LIBOPTS) $(LIBUPWATCH) $(LIBST) @LIBDBI_LIBS@ @LIBGLIB2_LIBS@
 
 BUILT_SOURCES = $(program:%=%.1) $(program:%=%.h) $(program:%=%.c) $(PROBFILES) $(SPECFILES) $(INITFILES)
 INCLUDES = -I../upwatch

Modified: upwatch/libdbi/uw_tcpconnect/run.c
===================================================================
--- upwatch/libdbi/uw_tcpconnect/run.c	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_tcpconnect/run.c	2006-07-21 20:34:40 UTC (rev 632)
@@ -66,13 +66,13 @@
   return(1);
 }
 
-void refresh_database(MYSQL *mysql);
+void refresh_database(dbi_conn conn);
 void run_actual_probes(void);
 void write_results(void);
 
 int run(void)
 {
-  MYSQL *mysql;
+  dbi_conn conn;
 
   if (!cache) {
     cache = g_hash_table_new_full(g_int_hash, g_int_equal, g_free, free_probe);
@@ -80,11 +80,11 @@
   
   LOG(LOG_INFO, &quot;reading info from database&quot;);
   uw_setproctitle(&quot;reading info from database&quot;);
-  mysql = open_database(OPT_ARG(DBHOST), OPT_VALUE_DBPORT, OPT_ARG(DBNAME), 
+  conn = open_database(OPT_ARG(DBTYPE), OPT_ARG(DBHOST), OPT_ARG(DBPORT), OPT_ARG(DBNAME), 
 			OPT_ARG(DBUSER), OPT_ARG(DBPASSWD));
-  if (mysql) {
-    refresh_database(mysql);
-    close_database(mysql);
+  if (conn) {
+    refresh_database(conn);
+    close_database(conn);
   }
 
   if (g_hash_table_size(cache) &gt; 0) {
@@ -100,10 +100,9 @@
   return(g_hash_table_size(cache));
 }
 
-void refresh_database(MYSQL *mysql)
+void refresh_database(dbi_conn conn)
 {
-  MYSQL_RES *result;
-  MYSQL_ROW row;
+  dbi_result result;
   char qry[1024];
 
   sprintf(qry,  &quot;SELECT pr_tcpconnect_def.id, pr_tcpconnect_def.domid, pr_tcpconnect_def.tblid, pr_realm.name, &quot;
@@ -114,23 +113,23 @@
 		&quot;       and pr_tcpconnect_def.pgroup = '%d' and pr_realm.id = pr_tcpconnect_def.domid&quot;,	
                 (unsigned)OPT_VALUE_GROUPID);
 
-  result = my_query(mysql, 1, qry);
+  result = db_query(conn, 1, qry);
   if (!result) {
     return;
   }
     
-  while ((row = mysql_fetch_row(result))) {
+  while (dbi_result_next_row(result)) {
     int id;
     struct probedef *probe;
 
-    id = atol(row[0]);
+    id = dbi_result_get_uint(result, &quot;id&quot;);
     probe = g_hash_table_lookup(cache, &amp;id);
     if (!probe) {
       probe = g_malloc0(sizeof(struct probedef));
       probe-&gt;id = id;
-      if (atoi(row[1]) &gt; 1) {
-        probe-&gt;probeid = atoi(row[2]);
-        probe-&gt;realm = strdup(row[3]);
+      if (dbi_result_get_uint(result, &quot;domid&quot;) &gt; 1) {
+        probe-&gt;probeid = dbi_result_get_uint(result, &quot;tblid&quot;);
+        strcpy(probe-&gt;realm, dbi_result_get_string(result, &quot;name&quot;));
       } else {
         probe-&gt;probeid = probe-&gt;id;
       }
@@ -138,20 +137,23 @@
     }
 
     if (probe-&gt;ipaddress) g_free(probe-&gt;ipaddress);
-    probe-&gt;ipaddress = strdup(row[4]);
-    probe-&gt;port = atoi(row[5]);
-    probe-&gt;yellow = atof(row[6]);
-    probe-&gt;red = atof(row[7]);
+    probe-&gt;ipaddress = dbi_result_get_string_copy(result, &quot;ipaddress&quot;);
+    probe-&gt;port = dbi_result_get_uint(result, &quot;port&quot;);
+    probe-&gt;yellow = dbi_result_get_float(result, &quot;yellow&quot;);
+    probe-&gt;red = dbi_result_get_float(result, &quot;red&quot;);
     if (probe-&gt;msg) g_free(probe-&gt;msg);
     probe-&gt;msg = NULL;
     probe-&gt;seen = 1;
   }
-  mysql_free_result(result);
-  if (mysql_errno(mysql)) {
+  if (dbi_conn_error_flag(conn)) {
+    char *errmsg;
+    dbi_conn_error(conn, &amp;errmsg);
+    LOG(LOG_ERR, &quot;%s&quot;, errmsg);
     g_hash_table_foreach(cache, reset_seen, NULL);
   } else {
     g_hash_table_foreach_remove(cache, return_seen, NULL);
   }
+  dbi_result_free(result);
 }
 
 void *probe(void *user_data); 

Modified: upwatch/libdbi/uw_tcpconnect/uw_tcpconnect.def
===================================================================
--- upwatch/libdbi/uw_tcpconnect/uw_tcpconnect.def	2006-07-21 20:32:44 UTC (rev 631)
+++ upwatch/libdbi/uw_tcpconnect/uw_tcpconnect.def	2006-07-21 20:34:40 UTC (rev 632)
@@ -15,7 +15,7 @@
 so uw_tcpconnect can process thousands of hosts in a very short period.';
 
 // this section is for the generated specfile
-spec-requires = &quot;/usr/bin/mysql glib2&quot;;
+spec-requires = &quot;libdbi &gt;= 0.8 glib2&quot;;
 spec-files = `echo &quot;%attr(0770,root,upwatch)&quot; $sbindir/uw_tcpconnect`;
 
 // describe commandline flags


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000165.html">[Upwatch-commits] r631 - upwatch
</A></li>
	<LI>Next message: <A HREF="000168.html">[Upwatch-commits] r633 - in upwatch/libdbi: . cfg common compat doc	patches upwatch util uw_accept uw_acceptbb uw_dns uw_httpget	uw_imap uw_iptraf uw_mssql uw_mysql uw_mysqlstats uw_null	uw_ping uw_pop3 uw_postgresql uw_process uw_purple uw_route	uw_send uw_setip uw_smtp uw_snmpget uw_syncprobes uw_sysstat	uw_sysstat/uw_sysstat.d/maillog uw_sysstat/uw_sysstat.d/mysql	uw_sysstat/uw_sysstat.d/quagga uw_sysstat/uw_sysstat.d/syslog	uw_sysstat/uw_sysstat.d/upwatch uw_tcpconnect
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#167">[ date ]</a>
              <a href="thread.html#167">[ thread ]</a>
              <a href="subject.html#167">[ subject ]</a>
              <a href="author.html#167">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/upwatch-commits">More information about the Upwatch-commits
mailing list</a><br>
</body></html>
